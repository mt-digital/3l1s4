!function(e){!function(e){"use strict";var t,r,i,n,o,s,a,c,u,l,d,p,h,m,w,f,g,v,y,b,S,P,I,E,C,k,D,T,A,N,U,W,F,_,V,x,O,R,L,j,M,B,J,$,G,q,z,H,K,X,Y,Z,Q,ee,te,re,ie,ne,oe,se,ae,ce,ue,le,de,pe,he,me,we,fe,ge,ve,ye,be,Se,Pe,Ie,Ee,Ce,ke,De,Te,Ae,Ne,Ue,We,Fe,_e,Ve,xe,Oe,Re,Le,je,Me,Be,Je,$e,Ge,qe,ze,He,Ke,Xe,Ye,Ze,Qe,et,tt,rt,it,nt,ot,st,at,ct,ut,lt,dt,pt,ht,mt,wt,ft,gt,vt,yt,bt,St,Pt,It,Et,Ct,kt,Dt,Tt,At,Nt,Ut,Wt,Ft,_t,Vt,xt,Ot,Rt,Lt,jt,Mt,Bt,Jt,$t,Gt,qt,zt,Ht,Kt,Xt,Yt,Zt,Qt,er,tr,rr,ir,nr,or,sr,ar,cr,ur,lr,dr,pr,hr,mr,wr,fr,gr,vr,yr,br,Sr,Pr,Ir,Er,Cr,kr,Dr,Tr,Ar,Nr,Ur,Wr,Fr,_r,Vr,xr,Or,Rr,Lr,jr,Mr,Br,Jr,$r,Gr,qr,zr,Hr,Kr,Xr,Yr,Zr,Qr,ei,ti,ri,ii,ni,oi,si,ai,ci,ui,li,di,pi,hi,mi,wi,fi,gi,vi,yi,bi,Si,Pi,Ii,Ei,Ci,ki,Di,Ti,Ai,Ni,Ui,Wi,Fi,_i,Vi,xi,Oi,Ri,Li,ji,Mi,Bi,Ji,$i,Gi,qi,zi,Hi,Ki,Xi,Yi,Zi,Qi,en,tn,rn,nn,on,sn,an,cn,un,ln,dn,pn,hn,mn,wn,fn,gn,vn,yn,bn,Sn,Pn=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)},In=(e,t,r)=>(Pn(e,t,"read from private field"),r?r.call(e):t.get(e)),En=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},Cn=(e,t,r,i)=>(Pn(e,t,"write to private field"),i?i.call(e,r):t.set(e,r),r),kn=(e,t,r)=>(Pn(e,t,"access private method"),r),Dn=(e=>(e["Await"]="await",e["Filter"]="filter",e["React"]="react",e["BackendTransfer"]="backend_transfer",e))(Dn||{}),Tn=(e=>(e["AwaitClick"]="await_click",e["AwaitScroll"]="await_scroll",e["AwaitExit"]="await_exit",e["AwaitInactivity"]="await_inactivity",e["AwaitECommerceActivity"]="await_ecommerce_activity",e["AwaitMergedNodes"]="await_merged_nodes",e["AwaitWebPushConsent"]="await_webpush_consent",e["FilterUrl"]="filter_url",e["FilterSubscriber"]="filter_subscriber",e["FilterDevice"]="filter_device",e["FilterLocation"]="filter_location",e["FilterTime"]="filter_time",e["FilterVisit"]="filter_visit",e["FilterUniqueSessionVisit"]="filter_unique_session_visit",e["FilterPopup"]="filter_popup",e["FilterECommerceActivity"]="filter_ecommerce_activity",e["ReactDelay"]="react_delay",e["ReactScroll"]="react_scroll",e["ReactRedirect"]="react_redirect",e["ReactPopup"]="react_popup",e["ReactSendToBackend"]="react_send_to_backend",e["ReactSendWebPush"]="react_send_webpush",e["ReactCollectWebPushConsent"]="react_collect_web_push_consent",e))(Tn||{});class An extends Error{}const Nn="true",Un="false",Wn="exit";class Fn extends ReferenceError{constructor(e){super(`Node of selector ${e} not found`),Object.setPrototypeOf(this,new.target.prototype),this.name="ElementNotFoundException"}}if(false){if("undefined"!=typeof navigator&&"ReactNative"===navigator.product&&"undefined"==typeof crypto)throw new Error("React Native does not have a built-in secure random generator. If you don’t need unpredictable IDs use `nanoid/non-secure`. For secure IDs, import `react-native-get-random-values` before Nano ID.");if("undefined"!=typeof msCrypto&&"undefined"==typeof crypto)throw new Error("Import file with `if (!window.crypto) window.crypto = window.msCrypto` before importing Nano ID to fix IE 11 support");if("undefined"==typeof crypto)throw new Error("Your browser does not have secure random generator. If you don’t need unpredictable IDs, you can use nanoid/non-secure.")}let _n=(e=21)=>{let t="",r=crypto.getRandomValues(new Uint8Array(e));for(;e--;){let i=63&r[e];if(36>i)t+=i.toString(36);else if(62>i)t+=(i-26).toString(36).toUpperCase();else if(63>i)t+="_";else t+="-"}return t};const Vn="_grDebugMode",xn=new class{isDebugEnabled(){return!!window.sessionStorage.getItem(Vn)}startDebug(){window.sessionStorage.setItem(Vn,"true")}},On=new class{get isLoggingEnabled(){return xn.isDebugEnabled()}log(...e){this.displayLog("log",...e)}info(...e){this.displayLog("info",...e)}error(...e){if(e[0]instanceof Error)e.push(e[0].stack);this.displayLog("error",...e)}forceLogError(...e){if(e[0]instanceof Error)e.push(e[0].stack);console.error(...e)}warn(...e){this.displayLog("warn",...e)}displayLog(e,...t){if(this.isLoggingEnabled)console[e](...t)}};function Rn(e){const t=document.cookie.match(new RegExp(`(^| )${e}=([^;]+)`));if(t)return t[2]}function Ln(){const e=new Date,t=location.hostname.split(".").reverse(),r=[],i=`gaDomain-${_n(6)}`,n=_n(6);let o="";for(e.setTime(e.getTime()+60*1e3),r.push(t.shift());t.length>0;){if(o=r.reverse().join("."),document.cookie=`${i}=${n}; expires=${e.toUTCString()}; domain=.${o}; path=/`,Rn(i)===n)return o;r.push(t.shift())}return location.hostname}function jn(e){return new Proxy({},{get(t,r){if(!(r in t))if("object"==typeof e&&null!==e)t[r]=structuredClone(e);else t[r]=e;return t[r]}})}function Mn(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Bn(e){return!!e&&"object"==typeof e}function Jn(e,t){const r={...e};for(const i of Object.keys(t))if(e.hasOwnProperty(i)&&Bn(e[i])&&Bn(t[i])&&!Array.isArray(e[i]))r[i]=Jn(e[i],t[i]);else r[i]=t[i];return r}class $n{constructor(){En(this,t,jn([]))}on(e,r,i={}){if(In(this,t)[e].push({once:i.once,listener:r}),i.signal)i.signal.addEventListener("abort",(()=>{this.off(e,r)}),{once:true})}off(e,r){In(this,t)[e]=In(this,t)[e].filter((e=>e.listener!==r))}emit(e,...r){In(this,t)[e].forEach((({listener:t,once:i})=>{if(t(...r),i)this.off(e,t)}))}}t=new WeakMap;const Gn={1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",0:"7"};function qn(e){On.error(`Unsupported value: ${e}`)}class zn{static hasValue(...e){return true}}class Hn extends zn{constructor(e){super(),En(this,n),En(this,r,null),En(this,i,void 0),Cn(this,r,e)}waitForUpstream(){if(!kn(this,n,o).call(this))return new Promise((e=>{const t=Date.now(),n=Date.parse(In(this,r))-t;if(n>0)Cn(this,i,window.setTimeout((()=>{e()}),n));else e()}))}cancelUpstreamCalculation(){if(In(this,i))clearTimeout(In(this,i))}static hasValue(e){const t=Date.parse(e);return!isNaN(t)}}var Kn,Xn;r=new WeakMap,i=new WeakMap,n=new WeakSet,o=function(){return(new Date).getTime()>Date.parse(In(this,r))},(Xn=Kn||(Kn={}))["PageVisit"]="visit",Xn["Popup"]="popup",Xn["ViewItem"]="view_item",Xn["ViewCategory"]="view_category",Xn["WishlistItem"]="wishlist_item",Xn["LikeItem"]="like_item",Xn["UnlikeItem"]="unlike_item",Xn["OrderPlaced"]="order_placed",Xn["Cart"]="cart_update",void(Xn["ShopifyAbandonedCart"]="shopify_webhook_abandoned_cart");let Yn=class extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype),this.name=this.constructor.name}};class Zn extends Yn{constructor(e){super(e)}}const Qn={cartToken:"string",urlToken:"string",visitorEmail:"string"},eo=["cartToken","urlToken"];var to,ro,io,no,oo,so,ao,co,uo,lo,po,ho,mo,wo;(wo=to||(to={}))["Inline"]="inline",void(wo["Popup"]="popup"),(mo=ro||(ro={}))["Hq"]="Hq",void(mo["Us"]="Us"),void((io||(io={}))["UserAid"]="X-Aid"),(ho=no||(no={}))[ho["OneSecond"]=1e3]="OneSecond",ho[ho["OneMinute"]=6e4]="OneMinute",ho[ho["OneHour"]=36e5]="OneHour",ho[ho["OneDay"]=864e5]="OneDay",void(ho[ho["OneWeek"]=6048e5]="OneWeek"),(po=oo||(oo={}))["Active"]="active",void(po["Inactive"]="inactive"),(lo=so||(so={}))["EveryTime"]="everyTime",void(lo["OnceEveryAmountTime"]="onceEveryAmountTime"),void((ao||(ao={}))["RemoveLastTransitionNodeEnter"]="removeLastTransitionNodeEnter"),(uo=co||(co={}))["ReactSendWebPush"]="react_web_webpush",uo["ReactCollectWebPushConsent"]="react_web_collect_webpush_subscription",uo["ReactShowPopup"]="react_web_popup",uo["FilterWebUrl"]="filter_web_url",uo["FilterWebSubscribers"]="filter_web_subscriber",uo["FilterLocation"]="filter_web_geolocation",uo["FilterDevice"]="filter_web_device",uo["FilterReturningVisitor"]="filter_web_returning_visitor",uo["ConditionProductViewed"]="await_web_view_item_event",uo["ConditionCategoryViewed"]="await_web_view_category_event",uo["ConditionWebPushConsent"]="await_web_webpush_subscribe",uo["ConditionProductLiked"]="await_web_like_item_event",uo["ConditionWebAction"]="await_web_action",uo["TransferToBackend"]="react_backend_transfer",uo["AwaitScroll"]="await_scroll",void(uo["ShowPopup"]="react_popup");class fo extends zn{constructor(e,t){super(),En(this,u),En(this,d),En(this,s,void 0),En(this,a,void 0),En(this,c,void 0),Cn(this,s,e),Cn(this,a,t)}waitForUpstream(){if(kn(this,u,l).call(this))return Promise.resolve();else return new Promise((e=>{const t=Date.now(),r=kn(this,d,p).call(this)+In(this,s)*no.OneSecond-t;if(!Number.isNaN(r))if(r>0)Cn(this,c,window.setTimeout((()=>{e()}),r));else e()}))}cancelUpstreamCalculation(){if(In(this,c))clearTimeout(In(this,c))}static hasValue(e){return"number"==typeof e&&e>=0}}s=new WeakMap,a=new WeakMap,c=new WeakMap,u=new WeakSet,l=function(){return Date.now()-kn(this,d,p).call(this)>In(this,s)*no.OneSecond},d=new WeakSet,p=function(){var e;return(null==(e=In(this,a))?void 0:e.node_entered_at)?new Date(In(this,a).node_entered_at).getTime():(new Date).getTime()};var go=(e=>(e["ExitIntend"]="exit-intend",e))(go||{});const vo={gr:"exit-intend"};var yo,bo,So,Po,Io,Eo,Co,ko,Do,To,Ao,No,Uo,Wo,Fo,_o,Vo,xo,Oo,Ro,Lo,jo,Mo,Bo,Jo,$o,Go,qo,zo,Ho,Ko,Xo,Yo,Zo,Qo,es,ts,rs,is,ns;(ns=yo||(yo={}))["ShowWhenCondition"]="showWhenCondition",ns["VisitorsCondition"]="visitors",ns["DeviceCondition"]="device",ns["LocationCondition"]="location",ns["ECommerceCondition"]="ecommerce",ns["TriggerFrequency"]="frequency",ns["PreventDisplay"]="preventDisplay",void(ns["DateRange"]="dateRange"),(is=bo||(bo={}))["Mobile"]="mobile",is["Tablet"]="tablet",void(is["Desktop"]="desktop"),(rs=So||(So={}))["All"]="all",rs["New"]="new",void(rs["Returning"]="returning"),void((Po||(Po={}))["All"]="all"),(ts=Io||(Io={}))["ConditionsLogicSeparator"]="conditionsLogicSeparator",void(ts["ECommerceConditions"]="ecommerceConditions"),(es=Eo||(Eo={}))["Amount"]="amount",void(es["Date"]="date"),(Qo=Co||(Co={}))["And"]="and",void(Qo["Or"]="or"),(Zo=ko||(ko={}))["Exactly"]="exactly",Zo["LessThan"]="lessThan",void(Zo["MoreThan"]="moreThan"),(Yo=Do||(Do={}))["LastDays"]="lastDays",void(Yo["DateRange"]="dateRange"),(Xo=To||(To={}))["AnyProduct"]="any",Xo["AnyCategory"]="any",Xo["AnyProductLiked"]="any",Xo["AnyProductInPlacedOrder"]="any",Xo["AnyCategoryInPlacedOrder"]="any",Xo["AnyProductInUpdatedCart"]="any",void(Xo["AnyCategoryInUpdatedCart"]="any"),(Ko=Ao||(Ao={}))["PastEvents"]="filter",void(Ko["FutureEvents"]="await"),(Ho=No||(No={}))["Category"]="category",void(Ho["Product"]="product"),void((Uo||(Uo={}))["Product"]="product"),(zo=Wo||(Wo={}))["ViewProductOrCategory"]="productOrCategoryView",zo["LikeProduct"]="likeItem",zo["OrderPlaced"]="orderPlaced",void(zo["CartUpdated"]="cartUpdated"),(qo=Fo||(Fo={}))["Percent"]="percent",void(qo["Selector"]="selector"),(Go=_o||(_o={}))["Instantly"]="instantly",Go["Delay"]="delay",Go["Exit"]="exit",Go["Scroll"]="scroll",Go["Inactivity"]="inactivity",void(Go["Click"]="click"),($o=Vo||(Vo={}))["AfterSubmit"]="submit",$o["AfterClose"]="close",void($o["AfterTimes"]="timesAmount"),(Jo=xo||(xo={}))["Always"]="always",Jo["Session"]="session",void(Jo["EveryDays"]="everyDays"),(Bo=Oo||(Oo={}))["Exactly"]="equal",Bo["LessThan"]="lessThan",void(Bo["MoreThan"]="moreThan"),(Mo=Ro||(Ro={}))["Exactly"]="equal",Mo["LessThan"]="lessThan",void(Mo["MoreThan"]="moreThan"),(jo=Lo||(Lo={}))[jo["InvalidCssSelector"]=1]="InvalidCssSelector",jo[jo["EmptyCssSelector"]=2]="EmptyCssSelector",jo[jo["CssSelectorTooLong"]=3]="CssSelectorTooLong",jo[jo["CssInvalidType"]=4]="CssInvalidType",jo[jo["InvalidTimeoutProperty"]=5]="InvalidTimeoutProperty",jo[jo["ShowWhenScrollPercentInvalidValueType"]=6]="ShowWhenScrollPercentInvalidValueType",jo[jo["ShowWhenScrollPercentValueOutOfBound"]=7]="ShowWhenScrollPercentValueOutOfBound",jo[jo["VisitorTriggerEmpty"]=8]="VisitorTriggerEmpty",jo[jo["VisitorTriggerInvalidProperty"]=9]="VisitorTriggerInvalidProperty",jo[jo["DevicesTriggerEmpty"]=10]="DevicesTriggerEmpty",jo[jo["DevicesTriggerInvalidValue"]=11]="DevicesTriggerInvalidValue",jo[jo["FrequencyEmptyTrigger"]=12]="FrequencyEmptyTrigger",jo[jo["FrequencyTriggerInvalidName"]=13]="FrequencyTriggerInvalidName",jo[jo["FrequencyTriggerNDaysInvalidPropertyValue"]=14]="FrequencyTriggerNDaysInvalidPropertyValue",jo[jo["FrequencyTriggerNDaysEmptyValue"]=15]="FrequencyTriggerNDaysEmptyValue",jo[jo["PreventDisplayTriggerInvalidName"]=16]="PreventDisplayTriggerInvalidName",jo[jo["PreventDisplayTriggerAfterTimesNoValue"]=17]="PreventDisplayTriggerAfterTimesNoValue",jo[jo["PreventDisplayTriggerAfterTimesInvalidValue"]=18]="PreventDisplayTriggerAfterTimesInvalidValue",jo[jo["DateRangeInvalidFromDate"]=19]="DateRangeInvalidFromDate",jo[jo["DateRangeInvalidToDate"]=20]="DateRangeInvalidToDate",jo[jo["DateRangeDateFromAfterDateTo"]=21]="DateRangeDateFromAfterDateTo",jo[jo["LocationEmptyTrigger"]=22]="LocationEmptyTrigger",jo[jo["LocationInvalidType"]=23]="LocationInvalidType",jo[jo["LackOfLogicSeparator"]=24]="LackOfLogicSeparator",jo[jo["LackOfTriggerConditions"]=25]="LackOfTriggerConditions",jo[jo["InvalidTriggerConditions"]=26]="InvalidTriggerConditions",jo[jo["NoProductOrCategorySelected"]=27]="NoProductOrCategorySelected",jo[jo["ProductInvalidType"]=28]="ProductInvalidType",jo[jo["CategoryInvalidType"]=29]="CategoryInvalidType",jo[jo["AmountInvalidConditionName"]=30]="AmountInvalidConditionName",jo[jo["AmountInvalidConditionValueType"]=31]="AmountInvalidConditionValueType",jo[jo["DateInvalidConditionName"]=32]="DateInvalidConditionName",jo[jo["DateLastDaysInvalidConditionValue"]=33]="DateLastDaysInvalidConditionValue",jo[jo["DateDateRangeInvalidConditionValue"]=34]="DateDateRangeInvalidConditionValue",jo[jo["DateDateRangeFromInvalidValue"]=35]="DateDateRangeFromInvalidValue",jo[jo["DateDateRangeToInvalidValue"]=36]="DateDateRangeToInvalidValue",jo[jo["DateDateRangeDateFromAfterDateTo"]=37]="DateDateRangeDateFromAfterDateTo",jo[jo["PopupTriggerInvalidName"]=38]="PopupTriggerInvalidName",jo[jo["PopupTriggerLackOfValuesInLikeItemTrigger"]=39]="PopupTriggerLackOfValuesInLikeItemTrigger",jo[jo["PopupTriggerLikeItemInvalidValues"]=40]="PopupTriggerLikeItemInvalidValues",jo[jo["PopupTriggerOrderPlacedNoConditions"]=41]="PopupTriggerOrderPlacedNoConditions",jo[jo["PopupTriggerOrderPlacedInvalidProducts"]=42]="PopupTriggerOrderPlacedInvalidProducts",jo[jo["PopupTriggerOrderPlacedInvalidCategories"]=43]="PopupTriggerOrderPlacedInvalidCategories",jo[jo["PopupTriggerCartUpdatedNoConditions"]=44]="PopupTriggerCartUpdatedNoConditions",jo[jo["PopupTriggerCartUpdatedInvalidProducts"]=45]="PopupTriggerCartUpdatedInvalidProducts",jo[jo["PopupTriggerCartUpdatedInvalidCategories"]=46]="PopupTriggerCartUpdatedInvalidCategories",jo[jo["PopupTriggerPriceValueConditionInvalidComparator"]=47]="PopupTriggerPriceValueConditionInvalidComparator",jo[jo["PopupTriggerPriceValueConditionInvalidValue"]=48]="PopupTriggerPriceValueConditionInvalidValue",jo[jo["PopupTriggerProductsAmountValueConditionInvalidComparator"]=49]="PopupTriggerProductsAmountValueConditionInvalidComparator",jo[jo["PopupTriggerProductsAmountValueConditionInvalidValue"]=50]="PopupTriggerProductsAmountValueConditionInvalidValue",void(jo[jo["PopupTriggerInvalidTriggerType"]=51]="PopupTriggerInvalidTriggerType");var os=(e=>(e[e["Mobile"]=768]="Mobile",e[e["Tablet"]=1023]="Tablet",e))(os||{});const ss=Symbol("DeviceService");h=new WeakSet,m=()=>window.matchMedia("(any-pointer: coarse)").matches&&navigator.maxTouchPoints>0,w=new WeakSet,f=()=>window.matchMedia("(pointer: coarse)").matches&&navigator.maxTouchPoints>0;let as=class e{constructor(t){if(En(this,h),En(this,w),new.target===e&&t!==ss)throw new Error(`Invalid ${new.target.name} constructor`)}detectDeviceTypeByScreenWidth(e){var t;const{availWidth:r,availHeight:i}=screen;let n=null==(t=screen.orientation)?void 0:t.type;if(!n)n=window.matchMedia("(orientation: landscape)").matches?"landscape":"portrait";const o=n.match(/landscape/)?i:r;if(os.Mobile>=o)return bo.Mobile;else if(o>os.Mobile&&os.Tablet>=o)return bo.Tablet;return e?bo.Tablet:bo.Desktop}isDesktopDevice(){return this.getDeviceType()===bo.Desktop}getDeviceType(){var e,t;const{userAgentData:r}=window.navigator;if(r){if(r.mobile)return bo.Mobile;else if((null==(e=r.platform)?void 0:e.toLowerCase().includes("android"))||(null==(t=r.platform)?void 0:t.toLowerCase().includes("ipad")))return bo.Tablet;else if(In(this,w,f))return bo.Tablet}else if(In(this,w,f))return this.detectDeviceTypeByScreenWidth(true);else if(In(this,h,m))return this.detectDeviceTypeByScreenWidth();return bo.Desktop}getBrowserLanguage(){const{language:e}=window.navigator;if(e.match(/\w{2}-\w{2}/))return e.split("-")[0].toLowerCase();else return e.toLowerCase()}getUserOs(){const{userAgentData:e}=window.navigator;if(e)return e.platform.toLowerCase();else return this.getOsFromUserAgent()}getOsFromUserAgent(){let e="unknown";const{userAgent:t}=navigator,r=t.toLowerCase();if(r.includes("win"))e="windows";if(r.includes("mac"))e="macos";if(r.includes("x11"))e="unix";if(r.includes("linux"))e="Linux";if(r.includes("android"))e="android";if(/iphone|ipad|ipod/.test(r))e="ios";return e}};const cs=new as(ss),us=50;class ls{constructor({useMobileHistoryBasedExitIntend:e=false,useMobileScrollBasedExitIntend:t=false}){En(this,b),En(this,P),En(this,E),En(this,k),En(this,T),En(this,g,null),En(this,v,false),En(this,y,false),Cn(this,g,new AbortController),Cn(this,v,e),Cn(this,y,t)}handle(){return cs.isDesktopDevice()?kn(this,P,I).call(this):kn(this,E,C).call(this)}abort(){In(this,g).abort()}}g=new WeakMap,v=new WeakMap,y=new WeakMap,b=new WeakSet,S=e=>{const{clientX:t,clientY:r}=e,{clientWidth:i,clientHeight:n}=document.documentElement;return!(t>0&&i>t&&r>0&&n>r)},P=new WeakSet,I=function(){return new Promise((e=>{document.documentElement.addEventListener("mouseleave",(t=>{if(kn(this,b,S).call(this,t))e(),In(this,g).abort()}),{signal:In(this,g).signal})}))},E=new WeakSet,C=function(){const e=[kn(this,P,I).call(this)];if(In(this,v))e.push(kn(this,k,D).call(this));if(In(this,y))e.push(kn(this,T,A).call(this));return Promise.race(e)},k=new WeakSet,D=function(){return new Promise((e=>{const t=window.history.state;document.documentElement.addEventListener("touchstart",(()=>{window.history.replaceState(vo,""),window.history.pushState(vo,""),window.addEventListener("popstate",(()=>{setTimeout((()=>{var r;if((null==(r=window.history.state)?void 0:r.gr)===go.ExitIntend)e(),In(this,g).abort(),window.history.replaceState(t,"")}),0)}),{signal:In(this,g).signal})}),{once:true,signal:In(this,g).signal})}))},T=new WeakSet,A=function(){const e=document.documentElement;let t=e.scrollTop;return new Promise((r=>{window.addEventListener("scroll",(()=>{if(us>e.scrollTop&&-us>e.scrollTop-t)r(),In(this,g).abort();else t=e.scrollTop}),{signal:In(this,g).signal})}))};class ds extends zn{constructor(){super(),En(this,N,void 0),Cn(this,N,new ls({useMobileHistoryBasedExitIntend:true,useMobileScrollBasedExitIntend:true}))}waitForUpstream(){return In(this,N).handle()}cancelUpstreamCalculation(){In(this,N).abort()}static hasValue(e){return"boolean"==typeof e&&true===e}}N=new WeakMap,U=new WeakMap,W=new WeakMap,F=new WeakMap,_=new WeakMap,V=new WeakSet,x=async function(){const{quantifier:e}=In(this,F),t=In(this,W).map((e=>e.waitForUpstream()));if("and"===e)await Promise.all(t);else await Promise.race(t);this.emit("upstreamPassed"),this.hasUpstreamTimePassed=true},O=new WeakSet,R=function(){if(In(this,W).length)In(this,W).forEach((e=>e.cancelUpstreamCalculation()))},L=new WeakSet,(e,t)=>{const r=new Date(t);return e.includes((r.getHours()+1).toString())},j=new WeakSet,(e,t)=>{const r=new Date(t);return e.includes(r.getDate().toString())},M=new WeakSet,(e,t)=>{const r=new Date(t);return e.includes(Gn[r.getDay().toString()])},B=new WeakSet,J=function(e){const t=[];return e.forEach((e=>{const{type:r,value:i}=e;switch(r){case"specificDate":if(Hn.hasValue(i))t.push(new Hn(i));break;case"delaySeconds":if(fo.hasValue(i))t.push(new fo(i,In(this,U)));break;case"onExitIntent":if(ds.hasValue(i))t.push(new ds);break;case"allowedDaysOfMonth":case"allowedHours":case"excludedDaysOfWeek":case"recalculateAt":break;default:qn(r)}})),t};let ps=class e extends $n{constructor({journey:e,upstreamData:t,signal:r}){super(),En(this,V),En(this,O),En(this,L),En(this,j),En(this,M),En(this,B),En(this,U,void 0),En(this,W,void 0),En(this,F,void 0),En(this,_,void 0),Cn(this,U,null),Cn(this,W,[]),Cn(this,F,null),this.hasUpstreamTimePassed=false,Cn(this,_,null),Cn(this,F,t),Cn(this,U,e),Cn(this,_,r)}static create(t){return new e(t)}initVisitorEntry(){var e;if(null==(e=In(this,F))?void 0:e.upstreams.length)if(Cn(this,W,kn(this,B,J).call(this,In(this,F).upstreams)),kn(this,V,x).call(this),In(this,_))In(this,_).onabort=()=>{kn(this,O,R).call(this)}}};var hs=(e=>(e["Api"]="api",e["Db"]="db",e["AutomationJourneyReactWebPushApi"]="automationJourneyReactWebPushApi",e["AutomationJourneyReactWebPushDb"]="automationJourneyReactWebPushDb",e))(hs||{}),ms=(e=>(e["Events"]="gr_webconnect",e["VisitorJourneys"]="gr_visitor_journeys",e["ServiceWorkerCallbacks"]="gr_sw_callbacks",e))(ms||{});const ws={gr_webconnect:1,gr_visitor_journeys:2,gr_sw_callbacks:1};var fs=(e=>(e["UserActivityEvents"]="user_activity_events",e))(fs||{}),gs=(e=>(e["EventType"]="eventType",e["VisitorUuid"]="visitorUuid",e["EventTypeWithVisitor"]="eventType, visitorUuid",e))(gs||{}),vs=(e=>(e["VisitorJourneys"]="visitorJourneys",e["VisitorJourneysGraphHistory"]="visitorJourneysGraphHistory",e["GraphJourneyFetchedData"]="graphJourneyFetchedData",e))(vs||{}),ys=(e=>(e["Callbacks"]="callbacks",e))(ys||{}),bs=(e=>(e["VisitorUuid"]="visitor_uuid",e["JourneyIdentifier"]="uuid",e["VisitorUuidWithJourneyIdentifier"]="visitor_uuid, uuid",e))(bs||{}),Ss=(e=>(e["VisitorUuid"]="visitor.uuid",e["NodeUuid"]="node.uuid",e["VisitorUuidWithNodeUuid"]="visitor.uuid, node.uuid",e))(Ss||{}),Ps=(e=>(e["GraphId"]="graph.id",e))(Ps||{});function Is(e,t,r){(e=>{if(!e.objectStoreNames.contains(vs.VisitorJourneys))try{const t=e.createObjectStore(vs.VisitorJourneys,{keyPath:["journey.uuid","visitor.uuid"],autoIncrement:false}),r=e.createObjectStore(vs.VisitorJourneysGraphHistory,{keyPath:["node.uuid","visitor.uuid"],autoIncrement:false});t.createIndex(bs.VisitorUuid,"visitor.uuid",{unique:false}),t.createIndex(bs.JourneyIdentifier,"journey.uuid",{unique:false}),t.createIndex(bs.VisitorUuidWithJourneyIdentifier,["visitor.uuid","journey.uuid"],{unique:false}),r.createIndex(Ss.VisitorUuid,"visitor.uuid",{unique:false}),r.createIndex(Ss.NodeUuid,"node.uuid",{unique:false}),r.createIndex(Ss.VisitorUuidWithNodeUuid,["visitor.uuid","node.uuid"],{unique:true})}catch(t){On.error("Error while initializing/upgrading visitor journeys database",t)}})(r),(e=>{if(!e.objectStoreNames.contains(vs.GraphJourneyFetchedData))try{e.createObjectStore(vs.GraphJourneyFetchedData,{keyPath:["graph.id","journey.id","node.id"],autoIncrement:false}).createIndex(Ps.GraphId,"graph.id",{unique:false})}catch(t){On.error("Error while initializing graph journey active node since date store",t)}})(r)}function Es(e,t){return[e,t]}let Cs,ks;const Ds=new WeakMap,Ts=new WeakMap,As=new WeakMap,Ns=new WeakMap,Us=new WeakMap;let Ws={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return Ts.get(e);if("objectStoreNames"===t)return e.objectStoreNames||As.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return _s(e[t])},set:(e,t,r)=>(e[t]=r,true),has(e,t){if(e instanceof IDBTransaction&&("done"===t||"store"===t))return true;else return t in e}};function Fs(e){if("function"==typeof e)return function(e){if(e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype))return function(t,...r){const i=e.call(Vs(this),t,...r);return As.set(i,t.sort?t.sort():[t]),_s(i)};if((ks||(ks=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e))return function(...t){return e.apply(Vs(this),t),_s(Ds.get(this))};else return function(...t){return _s(e.apply(Vs(this),t))}}(e);if(e instanceof IDBTransaction)!(e=>{if(Ts.has(e))return;const t=new Promise(((t,r)=>{const i=()=>{e.removeEventListener("complete",n),e.removeEventListener("error",o),e.removeEventListener("abort",o)},n=()=>{t(),i()},o=()=>{r(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",n),e.addEventListener("error",o),e.addEventListener("abort",o)}));Ts.set(e,t)})(e);if(t=e,(Cs||(Cs=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>t instanceof e)))return new Proxy(e,Ws);else return e;var t}function _s(e){if(e instanceof IDBRequest)return(e=>{const t=new Promise(((t,r)=>{const i=()=>{e.removeEventListener("success",n),e.removeEventListener("error",o)},n=()=>{t(_s(e.result)),i()},o=()=>{r(e.error),i()};e.addEventListener("success",n),e.addEventListener("error",o)}));return t.then((t=>{if(t instanceof IDBCursor)Ds.set(t,e)})).catch((()=>{})),Us.set(t,e),t})(e);if(Ns.has(e))return Ns.get(e);const t=Fs(e);if(t!==e)Ns.set(e,t),Us.set(t,e);return t}const Vs=e=>Us.get(e),xs=["get","getKey","getAll","getAllKeys","count"],Os=["put","add","delete","clear"],Rs=new Map;function Ls(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&"string"==typeof t))return;if(Rs.get(t))return Rs.get(t);const r=t.replace(/FromIndex$/,""),i=t!==r,n=Os.includes(r);if(!(r in(i?IDBIndex:IDBObjectStore).prototype)||!(n||xs.includes(r)))return;const o=async function(e,...t){const o=this.transaction(e,n?"readwrite":"readonly");let s=o.store;if(i)s=s.index(t.shift());return(await Promise.all([s[r](...t),n&&o.done]))[0]};return Rs.set(t,o),o}var js;js=Ws,void(Ws={...js,get(e,t,r){return Ls(e,t)||js.get(e,t,r)},has(e,t){return!!Ls(e,t)||js.has(e,t)}});const Ms=new class{openEventsDatabaseConnection(e){return this.openConnection(ms.Events,ws[ms.Events],e)}openAutomationJourneysDatabaseConnection(e){return this.openConnection(ms.VisitorJourneys,ws[ms.VisitorJourneys],e)}openServiceWorkerCallbacksDatabaseConnection(e){return this.openConnection(ms.ServiceWorkerCallbacks,ws[ms.ServiceWorkerCallbacks],e)}async openConnection(e,t,r){const i=await((e,t,{blocked:r,upgrade:i,blocking:n,terminated:o}={})=>{const s=indexedDB.open(e,t),a=_s(s);if(i)s.addEventListener("upgradeneeded",(e=>{i(_s(s.result),e.oldVersion,e.newVersion,_s(s.transaction),e)}));if(r)s.addEventListener("blocked",(e=>r(e.oldVersion,e.newVersion,e)));return a.then((e=>{if(o)e.addEventListener("close",(()=>o()));if(n)e.addEventListener("versionchange",(e=>n(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a})(e,t,{blocked(e,t,r){On.error(`Connection to old db version: ${t} not closed. Version ${e} not available`,r)},upgrade(e,t,i){On.log(`New db version ${i} detected, upgrading from ${t}`),r(t,i,e)},terminated(){On.log("Closing db connection")},blocking(e,t,r){On.log(`Current connection od db version ${e} is blocking connection to version ${t}.`,r),i.close()}});return i}},Bs=(Ms.openServiceWorkerCallbacksDatabaseConnection.bind(Ms),Ms.openAutomationJourneysDatabaseConnection.bind(Ms),class e{constructor(e){En(this,$,void 0),Cn(this,$,e)}static create(t){return new e(t)}validate(e){return Object.entries(In(this,$)).reduce(((t,[r,i])=>{if(false===t)return t;if(null==e[r]&&i._isOptional)return t;else return i.call(e,e[r])}),true)}stringifySchemaShape(){var t;return kn(t=e,G,q).call(t,In(this,$))}trim(e,t=In(this,$)){var r;const i={};for(const[n,o]of Object.entries(e))if("object"==typeof o&&null!==o){if(n in t){const e=null==(r=t[n])?void 0:r.valueShape;if(Array.isArray(o))if(e)i[n]=o.map((t=>this.trim(t,e)));else i[n]=o;else i[n]=this.trim(o,e)}}else if(n in t)i[n]=o;return i}static string(){return $s((e=>"string"==typeof e),(()=>"string"))}static number(){return $s((e=>"number"==typeof e),(()=>"number"))}static boolean(){return $s((e=>"boolean"==typeof e),(()=>"boolean"))}static dateString(){return $s((e=>{if("string"!=typeof e)return false;else return!Number.isNaN(new Date(e).getTime())}),(()=>"date string"))}static object(t){return $s((r=>{if(!t||"object"!=typeof t)return false;else return e.create(t).validate(r)}),(()=>kn(this,G,q).call(this,t)),t)}static array(t){return $s((r=>{if(!Array.isArray(r))return false;if("function"==typeof t)return r.every((e=>t(e)));const i=e.create(t);return r.every((e=>i.validate(e)))}),(()=>`[${kn(this,G,q).call(this,t)}]`),"function"==typeof t?void 0:t)}});$=new WeakMap,G=new WeakSet,q=e=>{const t={};if("function"==typeof e)return e.getValueType();else for(const[r,i]of Object.entries(e))t[r]=i.getValueType();try{return JSON.stringify(t).replaceAll('\\"','"')}catch{return"Failed to parse validation shape"}},En(Bs,G);let Js=Bs;function $s(e,t,r){if(e.optional=()=>(e._isOptional=true,e),e.getValueType=t,r)e.valueShape=r;return e}class Gs extends Error{constructor(e,t){super(e),this.code=t,Object.setPrototypeOf(this,Gs.prototype)}static createShopIdMismatchException(e,t){return new Gs(`Shop id mismatch: shopId from event: ${e}, shopId already in journey: ${t}`,1)}static createInvalidEventException(e){return new Gs(`Unable to replace event with ID ${e}: invalid event`,4)}static createNoShopDataProvidedInEventException(e){return new Gs(`No shop data provided in event with id: ${e}`,2)}static createInvalidReplacementEventIdException(e){return new Gs(`Unable to replace event with ID ${e} with newest event: specifier identifier not found in array`,3)}}const qs=8;z=new WeakSet,H=function(e){kn(this,ae,ce).call(this,e),this.products||=[];const t=this.products.find((t=>t.data.product.id===e.data.product.id));if(t)kn(this,ie,ne).call(this,t.eventId,e,this.products);else kn(this,te,re).call(this,e,this.products);this.shopId||=e.data.shop.id},K=new WeakSet,X=function(e){kn(this,ae,ce).call(this,e),this.categories||=[];const t=this.categories.find((t=>t.data.id===e.data.id));if(t)kn(this,ie,ne).call(this,t.eventId,e,this.categories);else kn(this,te,re).call(this,e,this.categories);this.shopId||=e.data.shop.id},Y=new WeakSet,Z=function(e){kn(this,ae,ce).call(this,e),this.products||=[];const t=this.products.find((t=>t.data.product.id===e.data.product.id));if(t)kn(this,ie,ne).call(this,t.eventId,e,this.products);else kn(this,te,re).call(this,e,this.products);this.shopId||=e.data.shop.id},Q=new WeakSet,ee=function(e){var t;kn(this,ae,ce).call(this,e),this.products||=[];const r=null==(t=this.products.find((t=>t.data.product.id===e.data.product.id)))?void 0:t.eventId;if(r)kn(this,oe,se).call(this,r,this.products)},te=new WeakSet,re=(e,t)=>{if(!t.some((t=>t.eventId===e.eventId)))if(qs>t.length)t.push(e);else t.sort(((e,t)=>new Date(e.occurredOn).getTime()-new Date(t.occurredOn).getTime())),t.shift(),t.push(e)},ie=new WeakSet,ne=(e,t,r)=>{const i=r.findIndex((t=>t.eventId===e));if(0>i)throw Gs.createInvalidReplacementEventIdException(e);r.splice(i,1,t)},oe=new WeakSet,se=(e,t)=>{const r=t.findIndex((t=>t.eventId===e));if(r>=-1)t.splice(r,1)},ae=new WeakSet,ce=function(e){var t,r;const i=e.eventType===Kn.ViewCategory;if(e.eventType===Kn.ViewItem||e.eventType===Kn.LikeItem||e.eventType===Kn.UnlikeItem){if(!(null==(t=e.data.shop)?void 0:t.id))throw Gs.createNoShopDataProvidedInEventException(e.eventId);if(!e.data.product.id)throw Gs.createInvalidEventException(e.eventId);if(this.shopId&&e.data.shop.id!==this.shopId)throw Gs.createShopIdMismatchException(e.data.shop.id,this.shopId)}else if(i){if(!(null==(r=e.data.shop)?void 0:r.id))throw Gs.createNoShopDataProvidedInEventException(e.eventId);if(this.shopId&&e.data.shop.id!==this.shopId)throw Gs.createShopIdMismatchException(e.data.shop.id,this.shopId);if(!e.data.id)throw Gs.createInvalidEventException(e.eventId)}};let zs=class e{constructor({categories:e,shopId:t,products:r}){En(this,z),En(this,K),En(this,Y),En(this,Q),En(this,te),En(this,ie),En(this,oe),En(this,ae),this.products=[],this.categories=[],this.shopId=t,this.products=r||[],this.categories=e||[]}static create(t={}){return new e(t)}addParamFromEvent(e){switch(e.eventType){case Kn.ViewItem:kn(this,z,H).call(this,e);break;case Kn.ViewCategory:kn(this,K,X).call(this,e);break;case Kn.LikeItem:kn(this,Y,Z).call(this,e);break;case Kn.UnlikeItem:kn(this,Q,ee).call(this,e);break;default:qn(e)}}toSerializedForApiJson(){const{categories:e,shopId:t,products:r}=this;return{shopId:t,product_id:r.map((e=>e.data.product.id)).filter(Boolean),category_id:e.map((e=>e.data.id)).filter(Boolean)}}toSerializedForDatabaseAutomationJourneyField(){if(!this.shopId||0===this.products.length&&0===this.categories.length)return{};else return{pass_through_params:{...this}}}};var Hs=(e=>(e["UuidHasBeenSet"]="grUuidHasBeenSet",e["PopupsRendererCustomUrl"]="grPopupsRendererCustomUrl",e))(Hs||{});class Ks{constructor(){En(this,ue,new Proxy({},{get(e,t){if(t in e)return e[t];else return e[t]=[],e[t]}}))}addEvent(e,t){In(this,ue)[e].push(t)}drainEvents(e){const t=In(this,ue)[e];return In(this,ue)[e]=[],t}getEvents(e){return In(this,ue)[e]}hasDelayedEvents(e){return In(this,ue)[e].length>0}}ue=new WeakMap,le=new WeakMap,de=new WeakMap;const Xs=new class{constructor(){En(this,le,{}),En(this,de,new Ks)}publish(e,...t){var r;if(null==(r=In(this,le)[e])?void 0:r.length)In(this,le)[e].forEach((r=>{r(...t),On.log(`Event ${e} published with arguments'`,...t)}));else In(this,de).addEvent(e,t)}subscribe(e,t,r={}){const{preventEventDraining:i,ignoreQueuedEvents:n}=r;if(!In(this,le)[e])In(this,le)[e]=[];if(In(this,de).hasDelayedEvents(e)&&!n)if(i)In(this,de).getEvents(e).forEach((e=>t(...e)));else In(this,de).drainEvents(e).forEach((e=>t(...e)));if(r.signal)r.signal.addEventListener("abort",(()=>{this.unsubscribe(e,t)}),{once:true});In(this,le)[e].push(t)}unsubscribe(e,t){var r;const i=null==(r=In(this,le)[e])?void 0:r.indexOf(t);if(i>-1)In(this,le)[e].splice(i,1)}removeListeners(e){delete In(this,le)[e]}};var Ys=(e=>(e["DeviceType"]="debug_device_type",e["Location"]="debug_location",e["VisitUrlPath"]="debug_visit_url_path",e["BrowserStorageLastActivityDate"]="debug_browser_storage_last_activity_date",e["NewVisitor"]="debug_new_visitor",e["HasUserVisitPage"]="debug_has_user_visit_page",e["Events"]="debug_events",e))(Ys||{});function Zs(){const e=e=>{const t=sessionStorage.getItem(e);if(t){if([Ys.DeviceType,Ys.VisitUrlPath,Ys.Location].includes(e))return t;if(e===Ys.BrowserStorageLastActivityDate){const e=new Date(t);return isNaN(e.getTime())?void 0:e}if([Ys.NewVisitor,Ys.HasUserVisitPage,Ys.Events].includes(e))try{return JSON.parse(t)}catch(r){On.error(`Invalid debug data for: ${e}`)}}};return{enabled:true,data:{[Ys.DeviceType]:e(Ys.DeviceType),[Ys.BrowserStorageLastActivityDate]:e(Ys.BrowserStorageLastActivityDate),[Ys.Location]:e(Ys.Location),[Ys.NewVisitor]:e(Ys.NewVisitor),[Ys.VisitUrlPath]:e(Ys.VisitUrlPath),[Ys.HasUserVisitPage]:e(Ys.HasUserVisitPage),[Ys.Events]:e(Ys.Events)}}}function Qs(e,t,r){const i=da.debugObject;da.debugObject={...i,data:{...null==i?void 0:i.data,[e]:t}},sessionStorage.setItem(e,r||String(t))}function ea(e){var t,r;return null==(r=null==(t=da.debugObject)?void 0:t.data)?void 0:r[e]}function ta(e,t){return da.isDebug?t:e}pe=new WeakMap;const ra=new class{constructor(){En(this,pe,{[Kn.LikeItem]:[],[Kn.OrderPlaced]:[],[Kn.UnlikeItem]:[],[Kn.ViewCategory]:[],[Kn.ViewItem]:[],[Kn.WishlistItem]:[],[Kn.PageVisit]:[],[Kn.Popup]:[],[Kn.Cart]:[]})}getEvents(e){return Promise.resolve(In(this,pe)[e])}getAllEvents(){return Promise.resolve(Object.values(In(this,pe)).flat(1))}getAllECommerceEvents(){return Promise.resolve([...In(this,pe)[Kn.ViewItem],...In(this,pe)[Kn.ViewCategory],...In(this,pe)[Kn.LikeItem],...In(this,pe)[Kn.UnlikeItem],...In(this,pe)[Kn.WishlistItem],...In(this,pe)[Kn.OrderPlaced],...In(this,pe)[Kn.Cart]])}getAllPopupEvents(){return Promise.resolve([...In(this,pe)[Kn.Popup]])}saveEvent(e){return In(this,pe)[e.eventType].push(e),Promise.resolve()}};var ia=(e=>(e["v2"]="v2",e["af"]="af",e["wp"]="wp",e["we"]="we",e["ec"]="ec",e))(ia||{}),na=(e=>(e["v2"]="GRV2",e["af"]="GRAF",e["wp"]="GRWP",e["we"]="GRWE",e["ec"]="GREC",e))(na||{});const oa={[ia.af]:"autoFunnel",[ia.ec]:"ecommerce",[ia.v2]:"tracking",[ia.we]:"webEvents",[ia.wp]:"webPush"};he=new WeakSet,me=e=>oa[e];const sa=new class{constructor(){En(this,he)}setScriptInitialized(e){const t=kn(this,he,me).call(this,e);window.__grIntegrationConfig[t].isModuleInitialized=true}isScriptInitialized(e){var t,r;const i=kn(this,he,me).call(this,e);return(null==(r=null==(t=null==window?void 0:window.__grIntegrationConfig)?void 0:t[i])?void 0:r.isModuleInitialized)??false}};var aa=(e=>(e["visitorUuid"]="gaVisitorUuid",e["visitorValuable"]="gaIsValuable",e["VisitorEmail"]="gaVisitorEId",e["VisitorResubscribed"]="gaVisitorResubscribed",e["NotificationConsentAcceptedFromPrompt"]="gaWpnConAcc",e["NotificationConsentCustomPromptRejectedDEPRECATED"]="gaWpnConRej-{promptId}",e["NotificationConsentCustomPromptRejected"]="gaWpnConRej-promptId",e))(aa||{}),ca=(e=>(e[e["OneYear"]=31536e6]="OneYear",e[e["TwoWeeks"]=12096e5]="TwoWeeks",e[e["ThreeMonths"]=7776e6]="ThreeMonths",e))(ca||{});const ua=new class{constructor(){this.timer=Date.now()}getCurrentVisitOnPageTime(){return Date.now()-this.timer}resetTimer(){this.timer=Date.now()}};we=new WeakMap,fe=new WeakMap,ge=new WeakMap,ve=new WeakSet,ye=function(){if(!In(this,we))window.history.pushState=new Proxy(window.history.pushState,{apply:(e,t,r)=>{const i=e.apply(t,r);for(const o of Array.from(In(this,fe)))try{o.apply(t,r)}catch(n){On.error("Push state callback error",n)}return i}}),window.history.replaceState=new Proxy(window.history.replaceState,{apply:(e,t,r)=>{const i=e.apply(t,r);for(const o of Array.from(In(this,ge)))try{o.apply(t,r)}catch(n){On.error("Replace state callback error",n)}return i}}),Cn(this,we,true)};const la=new class{constructor(){En(this,ve),En(this,we,false),En(this,fe,new Set),En(this,ge,new Set)}init(){kn(this,ve,ye).call(this)}onPushState(e,t={}){var r;if(!(null==(r=t.signal)?void 0:r.aborted))if(In(this,fe).add(e),t.signal)t.signal.addEventListener("abort",(()=>{this.removePushStateListener(e)}),{once:true})}onReplaceState(e,t={}){var r;if(!(null==(r=t.signal)?void 0:r.aborted))if(In(this,ge).add(e),t.signal)t.signal.addEventListener("abort",(()=>{this.removeReplaceStateListener(e)}),{once:true})}removePushStateListener(e){In(this,fe).delete(e)}removeReplaceStateListener(e){In(this,ge).delete(e)}};la.init();const da=new class{constructor(){this.scriptModuleManager=sa}initialize(e){const{xsid:t,grid:r,clientLatestGrid:i,domain:n,aid:o,useNOStorage:s,useBetterSubscriberIdentification:a,isServedFromCustomDomain:c,scriptsDomain:u,scriptsVersion:l,tracking:d,isDebugMode:p,uuuid:h}=e;if(p)xn.startDebug();window.__grIntegrationConfig=window.__grIntegrationConfig||{cData:{aid:o,grid:r,domain:n,useNOStorage:s,useBetterSubscriberIdentification:a,isServedFromCustomDomain:c,clientLatestGrid:i,uuuid:h},visitor:{email:null,eComId:null,xsid:t},tracking:{isModuleInitialized:false,isEnabled:d},webEvents:{isModuleInitialized:false,visitorApplicationEndpoint:null,automationJourneyGraphs:{},webPushActivePromptGraph:null,popupGraphs:{}},webPush:{isModuleInitialized:false,customSwPath:null,wpid:null,pushDomain:null,promptEndpoint:null},analyticsData:{scriptsDomain:u,scriptsVersion:l},ecommerce:{isModuleInitialized:false},autoFunnel:{isModuleInitialized:false},eventBus:Xs,temporaryEventsStorage:ra,vts:ua,phs:la,debug:p?Zs():void 0,delayedScripts:{},scriptTypesInitialized:new Set}}canUseBackendForSubscriberIdentification(){return window.__grIntegrationConfig.cData.useBetterSubscriberIdentification}getUserAid(){return window.__grIntegrationConfig.cData.aid}getClientLatestGrid(){return window.__grIntegrationConfig.cData.clientLatestGrid}getVisitorUuid(){return Rn(aa.visitorUuid)}getUserAnalyticsDomain(){return window.__grIntegrationConfig.cData.domain}getUserUuid(){return window.__grIntegrationConfig.cData.uuuid}enablePopupDevMode(){window.__grIntegrationConfig.setCustomPopupRendererUrl=e=>{window.sessionStorage.setItem(Hs.PopupsRendererCustomUrl,e)}}getPopupRendererCustomUrl(){return window.sessionStorage.getItem(Hs.PopupsRendererCustomUrl)}setCustomSwPath(e){if("string"!=typeof e)throw new Error("Path type must be string");if(!e.match(/gr_sw_main.js|service-worker\/service-worker.js$/))throw new Error("Invalid sw file name");window.__grIntegrationConfig.webPush.customSwPath=e}getCustomSwPath(){var e;return null==(e=window.__grIntegrationConfig)?void 0:e.webPush.customSwPath}isTrackingEnabled(){return window.__grIntegrationConfig.tracking.isEnabled}isTrackingScriptServedFromCustomDomain(){return window.__grIntegrationConfig.cData.isServedFromCustomDomain}set visitorEmail(e){window.__grIntegrationConfig.visitor.email=e}get visitorEmail(){return window.__grIntegrationConfig.visitor.email}get pushWpid(){return window.__grIntegrationConfig.webPush.wpid}set pushWpid(e){window.__grIntegrationConfig.webPush.wpid=e}set pushDomain(e){window.__grIntegrationConfig.webPush.pushDomain=e}get pushDomain(){return window.__grIntegrationConfig.webPush.pushDomain}set pushPromptEndpoint(e){window.__grIntegrationConfig.webPush.promptEndpoint=e}get pushPromptEndpoint(){return window.__grIntegrationConfig.webPush.promptEndpoint}get eventBus(){return window.__grIntegrationConfig.eventBus}get canUseBackendStorageForEvents(){return window.__grIntegrationConfig.cData.useNOStorage}get webConnectScriptCdnUrl(){return window.__grIntegrationConfig.analyticsData.scriptsDomain}get webConnectCurrentScriptsVersion(){return window.__grIntegrationConfig.analyticsData.scriptsVersion}get isDebug(){var e,t;return!!(null==(t=null==(e=window.__grIntegrationConfig)?void 0:e.debug)?void 0:t.enabled)}set debugObject(e){window.__grIntegrationConfig.debug=e}get debugObject(){var e;return null==(e=window.__grIntegrationConfig)?void 0:e.debug}get delayedScripts(){var e;return(null==(e=window.__grIntegrationConfig)?void 0:e.delayedScripts)||{}}set delayedScripts(e){window.__grIntegrationConfig.delayedScripts=e}set visitorApplicationEndpoint(e){window.__grIntegrationConfig.webEvents.visitorApplicationEndpoint=e}get visitorApplicationEndpoint(){return window.__grIntegrationConfig.webEvents.visitorApplicationEndpoint}get userEventsStorageApplicationUrl(){return window.__grIntegrationConfig.ecommerce.webEventsSearchApplicationEndpoint}set userEventsStorageApplicationUrl(e){window.__grIntegrationConfig.ecommerce.webEventsSearchApplicationEndpoint=e}get temporaryEventsStorage(){return window.__grIntegrationConfig.temporaryEventsStorage}get automationJourneyGraphs(){return window.__grIntegrationConfig.webEvents.automationJourneyGraphs}get webPushActivePromptGraph(){return window.__grIntegrationConfig.webEvents.webPushActivePromptGraph}set webPushActivePromptGraph(e){window.__grIntegrationConfig.webEvents.webPushActivePromptGraph=e}get popupGraphs(){return window.__grIntegrationConfig.webEvents.popupGraphs}get visitorXsid(){return window.__grIntegrationConfig.visitor.xsid}get visitorTimeService(){return window.__grIntegrationConfig.vts}get pageHistoryService(){return window.__grIntegrationConfig.phs}};var pa=(e=>(e["SetDomain"]="setDomain",e["SetListToken"]="setListToken",e["SetUserId"]="setUserId",e["SetEvent"]="setEvent",e["SetCookie"]="setCookie",e["SetAutoFunnelData"]="setAutoFunnelData",e["Push"]="push",e["SetCustomServiceWorkerPath"]="setCustomSwPath",e["ViewItem"]="viewItem",e["ViewCategory"]="viewCategory",e["LikeItem"]="likeItem",e["UnlikeItem"]="unlikeItem",e["WishListItem"]="wishlistItem",e["Purchase"]="orderPlaced",e["CartUpdate"]="cartUpdate",e["ShopifyAbandonedCart"]="shopifyAbandonedCart",e["SaveEvent"]="saveEvent",e["FlushEvents"]="flushEvents",e["SetUserDevice"]="setUserDevice",e["SetUserLocation"]="setUserLocation",e["SetVisitUrlPath"]="setVisitUrlPath",e["SetLastActivityDate"]="setLastActivityDate",e["SetIsNewVisitor"]="setIsNewVisitor",e["SetHasUserVisitPage"]="setHasUserVisitPage",e["SetRawEvent"]="setRawEvent",e["ImportScript"]="importScript",e["DelayScript"]="delayScript",e["InitScript"]="initScript",e))(pa||{}),ha=(e=>(e["UserEventSaved"]="userEventSaved",e["UserEventUpdated"]="userEventUpdated",e["UserECommerceEventMatchedByECommerceElement"]="userECommerceEventMatchedByElement",e["WebPushConsentAccepted"]="webPushConsentAccepted",e["WebPushCustomConsentRejected"]="webPushCustomConsentRejected",e["WebPushNativeConsentRejected"]="webPushNativeConsentRejected",e))(ha||{}),ma=(e=>(e["Show"]="show",e["Close"]="close",e["Submit"]="submit",e))(ma||{}),wa=(e=>(e["One"]="1.0",e))(wa||{}),fa=(e=>(e["Web"]="web",e["Mobile"]="mobile",e))(fa||{});const ga=new class{encodeEmail(e){return btoa(e)}decode(e){return atob(e)}isEncodedString(e){try{return atob(e),true}catch{return false}}validateEmail(e){return/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/.test(e)}};class va extends Error{constructor(e){super(e)}static create(...[e,t]){switch(e){case"email":return new va(`Provided string ${t} is not valid email address`);default:qn(e)}}}class ya{constructor({e}={}){if(e)this.e=ga.encodeEmail(e)}static createFromContextData(e){try{if(ga.isEncodedString(e.e))e.e=ga.decode(e.e);return ya.validate(e),new ya(e)}catch(t){if(t instanceof va)return On.error(t),ya.createBlank();throw t}}static createBlank(){return new ya}static validate(e){if("e"in e&&!ga.validateEmail(e.e))throw va.create("email",e.e)}toJSON(){return{...this}}}class ba{constructor(e){En(this,be,void 0),this.eventType=e,Cn(this,be,null),this.eventId=null,this.aid=da.getUserAid(),this.grid=da.getClientLatestGrid(),this.time=da.visitorTimeService.getCurrentVisitOnPageTime(),this.context=ya.createBlank(),this.uuid=da.getVisitorUuid(),this.url=window.location.href,this.occurredOn=new Date,this.tags=[]}get externalUid(){return In(this,be)}toJSON(){return{eventId:this.eventId,aid:this.aid,grid:this.aid,uuid:this.uuid,externalUid:this.externalUid,context:this.context.toJSON(),time:this.time,url:this.url,tags:this.tags,eventType:this.eventType,occurredOn:this.occurredOn.toUTCString()}}toString({normalized:e}={}){if(e)return JSON.stringify(this.normalizeForExternalStorage());else return JSON.stringify(this.toJSON())}normalize(){const{eventId:e,...t}=this.toJSON();return t}getBaseNormalizedEvent(){return{version:wa.One,user_uuid:da.getUserUuid(),time:this.time,tags:this.tags,occurred_on:this.occurredOn.toISOString(),url:this.url,app:{lang:cs.getBrowserLanguage(),device:cs.getDeviceType(),os:cs.getUserOs()},channel:fa.Web,visitor:{uuid:this.uuid,external_id:this.externalUid,xsid:da.visitorXsid}}}}be=new WeakMap;const Sa=class e{constructor(e){En(this,De),En(this,Ae),En(this,Se,void 0),En(this,Pe,void 0),this.node={},Cn(this,Se,new AbortController),Cn(this,Pe,false);const{pass_through_params:t,...r}=e;Object.assign(this,r),this.pass_through_params=zs.create(e.pass_through_params||{})}static create(t,r={}){var i,n;if(!kn(i=e,Ie,Ee).call(i,t))throw new Error("Automation journey data does not match required schema");const o=new e(t);if(!r.preventAttachingListeners)kn(n=o,De,Te).call(n);if(t instanceof e)t.terminate();return o}static createBlank(t){var r,i;if(!kn(r=e,Ce,ke).call(r,t))throw new Error("Automation journey data does not match required schema");const n=new e(t);return kn(i=n,De,Te).call(i),n}updateJourneyData({node_entered_at:e,node:t,upstreamed_to:r}){this.node.uuid=t.uuid,this.upstreamed_to=r,this.node_entered_at=e}toSerializedDatabaseJSON(){const{pass_through_params:e,...t}=this;return structuredClone({...t,...e.toSerializedForDatabaseAutomationJourneyField()})}terminate(){In(this,Se).abort(),Cn(this,Pe,true)}};Se=new WeakMap,Pe=new WeakMap,Ie=new WeakSet,Ee=e=>Js.create({journey:Js.object({uuid:Js.string()}),visitor:Js.object({uuid:Js.string()}),node:Js.object({uuid:Js.string()}),node_entered_at:Js.dateString(),upstreamed_to:Js.dateString().optional(),pass_through_params:Js.object({shopId:Js.string().optional(),product_id:Js.array(Js.string()).optional(),category_id:Js.array(Js.string()).optional()}).optional()}).validate(e),Ce=new WeakSet,ke=e=>Js.create({journey:Js.object({uuid:Js.string()}),visitor:Js.object({uuid:Js.string()})}).validate(e),De=new WeakSet,Te=function(){da.eventBus.subscribe(ha.UserECommerceEventMatchedByECommerceElement,(async e=>{if(!In(this,Pe))kn(this,Ae,Ne).call(this,e),await Ia.saveVisitorJourney(this)}),{signal:In(this,Se).signal})},Ae=new WeakSet,Ne=function(e){const t=e instanceof ba?e.toJSON():e;switch(e.eventType){case Kn.ViewItem:case Kn.ViewCategory:case Kn.LikeItem:case Kn.UnlikeItem:this.pass_through_params.addParamFromEvent(t);break}},En(Sa,Ie),En(Sa,Ce);let Pa=Sa;const Ia=new class{async getVisitorJourneys(e){const t=(await Ms.openAutomationJourneysDatabaseConnection(Is)).transaction(vs.VisitorJourneys,"readonly"),r=t.objectStore(vs.VisitorJourneys).index(bs.VisitorUuid),i=await r.getAll(e);return await t.done,i.map((e=>Pa.create(e)))}async saveVisitorJourney(e){const{journey:t,visitor:r}=e,i=(await Ms.openAutomationJourneysDatabaseConnection(Is)).transaction(vs.VisitorJourneys,"readwrite"),n=i.objectStore(vs.VisitorJourneys);await n.delete([t.uuid,r.uuid]),await n.add(e.toSerializedDatabaseJSON()),await i.done}async clearVisitorJourney(e){const{journey:t,visitor:r}=e,i=(await Ms.openAutomationJourneysDatabaseConnection(Is)).transaction(vs.VisitorJourneys,"readwrite"),n=i.objectStore(vs.VisitorJourneys);await n.delete([t.uuid,r.uuid]),await i.done}async getNodeEntryHistory(e,t){const r=(await Ms.openAutomationJourneysDatabaseConnection(Is)).transaction(vs.VisitorJourneysGraphHistory,"readonly"),i=r.objectStore(vs.VisitorJourneysGraphHistory),n=await i.getAll(Es(e,t));return await r.done,n}async saveNodeHistoryEntry(e,t,r){const i=(await Ms.openAutomationJourneysDatabaseConnection(Is)).transaction(vs.VisitorJourneysGraphHistory,"readwrite"),n=i.objectStore(vs.VisitorJourneysGraphHistory);await n.delete(Es(e,t)),await n.add({node:{uuid:e},visitor:{uuid:t},entered_at:r}),await i.done}},Ea=new class{constructor(){this.visitorFlow=[]}addEntry(e){this.visitorFlow.push(e)}hasElementBeenVisited(e){return!!this.visitorFlow.find((t=>t===e))}};Ue=new WeakMap,We=new WeakSet,Fe=function(e,t){if(0===t.length)return true;const{type:r}=In(this,Ue).recurrent;switch(r){case so.OnceEveryAmountTime:return kn(this,_e,Ve).call(this,t);case so.EveryTime:return kn(this,xe,Oe).call(this,t,e);default:qn(r)}},_e=new WeakSet,Ve=function(e){const t=e.sort(((e,t)=>Date.parse(t.entered_at)-Date.parse(e.entered_at))).at(0),{value:r,type:i}=In(this,Ue).recurrent;if(i!==so.OnceEveryAmountTime)throw new Error("Invalid recurrent condition type");return Date.now()>Date.parse(t.entered_at)+r},xe=new WeakSet,Oe=function(e,t){var r;const{value:i}=In(this,Ue).recurrent;if(i)return true;if((null==(r=null==t?void 0:t.node)?void 0:r.uuid)===In(this,Ue).id&&!Ea.hasElementBeenVisited(In(this,Ue).id))return true;else return 0===(null==e?void 0:e.length)};let Ca=class e{constructor({node:e}){En(this,We),En(this,_e),En(this,xe),En(this,Ue,void 0),Cn(this,Ue,e)}static create(t){return new e(t)}async shouldProcessElementInFlow(e){const t=await Ia.getNodeEntryHistory(In(this,Ue).id,e.visitor.uuid);return kn(this,We,Fe).call(this,e,t)}};class ka{constructor({id:e,externalId:t,properties:r,recurrent:i,upstream:n,context:o}){En(this,Re,void 0),this.context=null,Cn(this,Re,Ca.create({node:this})),this.id=e,this.externalId=t,this.recurrent=i,this.properties=r,this.upstream=n,this.context=o}get nodeTypeGroup(){var e,t;if(this.type===Tn.ReactSendToBackend)return Dn.BackendTransfer;else return null==(t=null==(e=this.type.match(/^(?<nodeGroupType>[a-zA-Z]*)_.*/))?void 0:e.groups)?void 0:t.nodeGroupType}startUpstreamCalculation(e){this.upstreamAbortController=new AbortController,this.upstreamService=ps.create({upstreamData:this.upstream,journey:e,signal:this.upstreamAbortController.signal}),this.upstreamService.initVisitorEntry()}waitForUpstreamPassed(){return new Promise((e=>{if(this.upstream)if(this.upstreamService.hasUpstreamTimePassed)e(Symbol.for("upstreamPassed"));else this.upstreamService.on("upstreamPassed",(()=>{e(Symbol.for("upstreamPassed"))}),{once:true,signal:this.upstreamAbortController.signal})}))}cancelUpstreamToResolveWait(){this.upstreamAbortController.abort()}validateRecurrentConditionForJourney(e){return In(this,Re).shouldProcessElementInFlow(e)}shouldProcessHandler(){return!this.upstreamService.hasUpstreamTimePassed}}Re=new WeakMap;class Da extends ka{constructor(){super(...arguments),this.leaveFalseTimeout=null}waitForDelayLeaveFalse(){return new Promise((e=>{const{leaveFalseDelay:t}=this.properties;if(t)this.leaveFalseTimeout=window.setTimeout(e,t)}))}cleanLeaveFalseTimeout(){if(this.leaveFalseTimeout)window.clearTimeout(this.leaveFalseTimeout),this.leaveFalseTimeout=null}}const Ta=100,Aa=204;function Na(e,t){const r=e.isTextResponse??(null==t?void 0:t.isTextResponse);return fetch(e,{...t,headers:{...null==t?void 0:t.headers,...(null==t?void 0:t.omitAidHeader)?{}:{[io.UserAid]:da.getUserAid()}}}).then((async e=>{if(e.ok){if(e.status===Aa)return;return r?e.text():e.json()}const t=await e.text();return Promise.reject({statusCode:e.status,message:t})}))}const Ua=new class{getVisitorData(){return Na(new URL(`visitors/${da.getUserAid()}/${Rn(aa.visitorUuid)}`,da.getUserAnalyticsDomain()).href)}},Wa=1e3*60*60*24,Fa=1e3;function _a(e){return new Promise((t=>{setTimeout(t,e)}))}function Va(e,t){const r=new Date(e+t*Wa),i=new Date(r.getFullYear(),r.getMonth(),r.getDate(),0,0,0);return Date.now()>=Date.parse(i.toString())}async function xa(e,{maxAttempts:t=void 0,delay:r=Fa,multiplyDelay:i=true,maxDelay:n=Fa}={}){const o=async s=>{try{return await e()}catch(c){if(t&&s+1>t)throw c;const e=i?r*s:r;return 0,a=n&&e>n?n:e,new Promise((e=>{setTimeout((()=>e(o(s+1))),a)}))}var a};return o(1)}class Oa extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype),this.name=this.constructor.name}}class Ra extends Oa{}const La=Symbol("DebugDeviceService");class ja extends as{constructor(e){if(super(),new.target===ja&&e!==La)throw new Error(`Invalid ${new.target.name} constructor`)}getDeviceType(){const e=ea(Ys.DeviceType);if(!e)return super.getDeviceType();if(!Object.values(bo).includes(e))return On.error("Incorrect debug device type. Check if device is correct. Instead of that we will use normal values"),super.getDeviceType();else return e}setDeviceType(e){Qs(Ys.DeviceType,e)}}const Ma=new ja(La),Ba=Symbol("LocationService");class Ja{constructor(e){if(new.target===Ja&&e!==Ba)throw new Error(`Invalid ${new.target.name} constructor`)}getVisitorCountryCode(){const{domain:e}=window.__grIntegrationConfig.cData;return fetch(`${e}web-user-data/country`).then((e=>e.text()))}}const $a=new Ja(Ba),Ga=Symbol("DebugLocationService");class qa extends Ja{constructor(e){if(super(),new.target===qa&&e!==Ga)throw new Error(`Invalid ${new.target.name} constructor`)}getVisitorCountryCode(){const e=ea(Ys.Location);if(!e)return super.getVisitorCountryCode();else return Promise.resolve(e)}setVisitorCountryCode(e){if("string"!=typeof e)return On.error("Incorrect debug country code value"),null;Qs(Ys.Location,e)}}const za=new qa(Ga),Ha=400;class Ka extends Oa{constructor(){super("Invalid time properties")}}const Xa=new Map,Ya=(e,t)=>{if(!Array.isArray(e))switch(typeof e){case"string":e=[e];break;case"undefined":e=[];break;default:throw new TypeError(`Expected '${t}' to be a string or an array, but got a type of '${typeof e}'`)}return e.filter((e=>{if("string"!=typeof e){if(void 0===e)return false;throw new TypeError(`Expected '${t}' to be an array of strings, but found a type of '${typeof e}' in the array`)}return true}))};function Za(e,t,r){return((e,t,r,i)=>{if(e=Ya(e,"inputs"),0===(t=Ya(t,"patterns")).length)return[];t=t.map((e=>((e,t)=>{t={caseSensitive:false,...t};const r=e+JSON.stringify(t);if(Xa.has(r))return Xa.get(r);const i="!"===e[0];if(i)e=e.slice(1);e=(e=>{if("string"!=typeof e)throw new TypeError("Expected a string");return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")})(e).replace(/\\\*/g,"[\\s\\S]*");const n=new RegExp(`^${e}$`,t.caseSensitive?"":"i");return n.negated=i,Xa.set(r,n),n})(e,r)));const{allPatterns:n}=r||{},o=[];for(const s of e){let e;const r=[...t].fill(false);for(const[i,n]of t.entries())if(n.test(s))if(r[i]=true,e=!n.negated,!e)break;if(!(false===e||void 0===e&&t.some((e=>!e.negated))||n&&r.some(((e,r)=>!e&&!t[r].negated))))if(o.push(s),i)break}return o})(e,t,r,true).length>0}class Qa extends Oa{constructor(){super("Failed to parse data from JSON string")}}class ec extends ba{constructor(e,t,r=ya.createBlank()){super(Kn.Popup),this.popupEvent=e,this.popupId=t,this.context=r}toJSON(){return{...super.toJSON(),popupId:this.popupId,popupEvent:this.popupEvent}}normalizeForExternalStorage(){return{...this.getBaseNormalizedEvent(),event:{version:"1.0",name:Kn.Popup}}}}class tc extends ba{toJSON(){return{...super.toJSON(),data:this.data}}normalizeForExternalStorage(){const e=this.getBaseNormalizedEvent();return{...e,event:{version:this.eventVersion,name:this.eventType,data:this.data},visitor:{uuid:e.visitor.uuid,external_id:e.visitor.external_id}}}}class rc extends ba{constructor(e){super(Kn.ShopifyAbandonedCart),this.data=e}toJSON(){return{...super.toJSON(),data:this.data}}normalizeForExternalStorage(){return{...this.getBaseNormalizedEvent(),event:{version:"1.0",name:Kn.ShopifyAbandonedCart,data:this.data}}}}const ic={id:Js.string(),sku:Js.string().optional(),name:Js.string().optional(),vendor:Js.string().optional(),price:Js.string().optional(),currency:Js.string().optional()},nc=Js.array({id:Js.string(),name:Js.string().optional()}).optional(),oc={id:Js.string()},sc={shop:Js.object({...oc}).optional(),product:Js.object({...ic}),categories:nc},ac={product:Js.object({...ic}),categories:nc,quantity:Js.number()},cc=Js.create({...sc}),uc=Js.create({shop:Js.object({...oc}).optional(),id:Js.string(),name:Js.string().optional()}),lc=Js.create({...sc}),dc=Js.create({...sc}),pc=Js.create({...sc}),hc=Js.create({orderId:Js.string(),cartId:Js.string().optional(),price:Js.number(),currency:Js.string(),products:Js.array(ac)}),mc=Js.create({price:Js.number(),cartId:Js.string(),cartUrl:Js.string(),currency:Js.string(),products:Js.array(ac)});class wc extends Error{constructor(e){super(`Data doesn't match required schema: ${e}`)}}class fc extends ba{constructor(e=ya.createBlank()){super(Kn.PageVisit),this.context=e}normalizeForExternalStorage(){return{...this.getBaseNormalizedEvent(),event:{version:"1.0",name:this.eventType}}}}const gc={[Kn.ViewItem]:cc,[Kn.ViewCategory]:uc,[Kn.WishlistItem]:lc,[Kn.LikeItem]:dc,[Kn.UnlikeItem]:pc,[Kn.OrderPlaced]:hc,[Kn.Cart]:mc},vc={[Kn.ViewItem]:class extends tc{constructor(e,t){super(Kn.ViewItem),this.data=e,this.context=t,this.eventVersion="1.0"}normalizeForExternalStorage(){const e=super.normalizeForExternalStorage();return e.event.data.product.price=parseFloat(e.event.data.product.price),e.time=da.visitorTimeService.getCurrentVisitOnPageTime(),e}},[Kn.ViewCategory]:class extends tc{constructor(e,t){super(Kn.ViewCategory),this.data=e,this.context=t,this.eventVersion="1.0"}normalizeForExternalStorage(){const e=super.normalizeForExternalStorage();return e.time=da.visitorTimeService.getCurrentVisitOnPageTime(),e}},[Kn.WishlistItem]:class extends tc{constructor(e,t){super(Kn.WishlistItem),this.data=e,this.context=t,this.eventVersion="1.0"}},[Kn.LikeItem]:class extends tc{constructor(e,t){super(Kn.LikeItem),this.data=e,this.context=t,this.eventVersion="1.0"}normalizeForExternalStorage(){const e=super.normalizeForExternalStorage();return e.event.data.product.price=parseFloat(e.event.data.product.price),e}},[Kn.UnlikeItem]:class extends tc{constructor(e,t){super(Kn.UnlikeItem),this.data=e,this.context=t,this.eventVersion="1.0"}normalizeForExternalStorage(){const e=super.normalizeForExternalStorage();return e.event.data.product.price=parseFloat(e.event.data.product.price),e}},[Kn.OrderPlaced]:class extends tc{constructor(e,t){super(Kn.OrderPlaced),this.data=e,this.context=t,this.eventVersion="1.0"}normalizeForExternalStorage(){const e=super.normalizeForExternalStorage();return e.event.data.products=e.event.data.products.map((e=>({...e,product:{...e.product,price:parseFloat(e.product.price)}}))),e}},[Kn.Cart]:class extends tc{constructor(e,t){super(Kn.Cart),this.data=e,this.context=t,this.eventVersion="1.0"}normalizeForExternalStorage(){const e=super.normalizeForExternalStorage();return e.event.data.products=e.event.data.products.map((e=>({...e,product:{...e.product,price:parseFloat(e.product.price)}}))),e}}},yc=class e{static getPageVisitEvent(){return new fc}static getPopupEvent({popupId:e,popupEventName:t}){return new ec(t,e)}static getPopupSubmitEvent(e){return new ec(ma.Submit,e)}static getPopupShowEvent(e){return new ec(ma.Show,e)}static getPopupCloseEvent(e){return new ec(ma.Close,e)}static getViewItemEvent(t,r){var i;return kn(i=e,Le,je).call(i,Kn.ViewItem,t,r)}static getWishlistItemEvent(t,r){var i;return kn(i=e,Le,je).call(i,Kn.WishlistItem,t,r)}static getLikeItemEvent(t,r){var i;return kn(i=e,Le,je).call(i,Kn.LikeItem,t,r)}static getUnlikeItemEvent(t,r){var i;return kn(i=e,Le,je).call(i,Kn.UnlikeItem,t,r)}static getViewCategoryEvent(t,r){var i;return kn(i=e,Le,je).call(i,Kn.ViewCategory,t,r)}static getOrderPlacedEvent(t,r){var i;return kn(i=e,Le,je).call(i,Kn.OrderPlaced,t,r)}static getCartUpdateEvent(t,r){var i;return kn(i=e,Le,je).call(i,Kn.Cart,t,r)}static getShopifyIntegrationAbandonedCartEvent(e){try{return(e=>{if("object"!=typeof e||null===e)throw new Zn("Invalid data parameter type");else{const t=Object.entries(Qn),r=Object.keys(e);if(!eo.every((e=>r.includes(e))))throw new Zn("Lack of required parameters");if(!t.every((([t,r])=>!e[t]||typeof e[t]===r)))throw new Zn("Properties have invalid type")}return true})(e),new rc((t=e,r=Object.keys(Qn),Object.entries(t).reduce(((e,[t,i])=>{if(r.includes(t))e[t]=i;return e}),{})))}catch(i){return On.error(i),null}var t,r}};Le=new WeakSet,je=(e,t,r)=>{const i=gc[e],n=vc[e];if(!i||!n)throw new Error("Event type not supported in event factory");if(!i.validate(t))throw new wc(i.stringifySchemaShape());return new n(i.trim(t),r)},En(yc,Le);let bc=yc;const Sc=Symbol("StorageService");class Pc{constructor(e){if(new.target===Pc&&e!==Sc)throw new Error(`Invalid ${new.target.name} constructor`)}async isNewVisitor(){return!(await this.getLastActivityDate())}getLastActivityDate(){return this.getLastActivityDateFromBrowserStorage()}getUserActivityDataFromBrowserStorage(){const e=Rn(aa.visitorUuid),t=localStorage.getItem("gaLocalStorageVisitKey");let r;try{r=JSON.parse(t)}catch{throw new Qa}if(null==r?void 0:r[e])return r[e];else return{lastActivity:null,totalCount:1}}async getLastActivityDateFromBrowserStorage(){const{lastActivity:e}=await this.getUserActivityDataFromBrowserStorage();if(e)return Promise.resolve(new Date(e));else return null}saveUserActivity(){da.eventBus.publish(pa.SaveEvent,{sendToBackend:true,saveToLocal:false},ya.createBlank(),Kn.PageVisit,null),this.saveUserActivityToBrowserStorage()}saveUserActivityToBrowserStorage(){const e=Rn(aa.visitorUuid),{totalCount:t}=this.getUserActivityDataFromBrowserStorage(),r={[e]:{lastActivity:bc.getPageVisitEvent().occurredOn.toUTCString(),totalCount:t+1}};try{window.localStorage.setItem("gaLocalStorageVisitKey",JSON.stringify(r))}catch{throw new Qa}}}const Ic=new Pc(Sc),Ec=Symbol("DebugStorageService");class Cc extends Pc{constructor(e){if(super(),new.target===Cc&&e!==Ec)throw new Error(`Invalid ${new.target.name} constructor`)}getLastActivityDate(){var e;const t=ea(Ys.BrowserStorageLastActivityDate);if(isNaN(null==(e=null==t?void 0:t.getTime)?void 0:e.call(t)))return super.getLastActivityDate();else return Promise.resolve(t)}setLastActivityDate(e){const t=new Date(e);if(isNaN(t.getTime()))return On.error("Incorrect dateString for last activity date. Try again with isoString."),null;Qs(Ys.BrowserStorageLastActivityDate,t,t.toISOString())}isNewVisitor(){const e=ea(Ys.NewVisitor);if(void 0===e)return super.isNewVisitor();else return Promise.resolve(e)}setIsNewVisitor(e){Qs(Ys.NewVisitor,e,String(e))}}const kc=new Cc(Ec);function Dc(){return ta(Ic,kc)}var Tc=(e=>(e["Always"]="always",e["OnceEveryDays"]="xDays",e["OncePerTimeAmount"]="xTimeAmount",e["Session"]="everySession",e["LessThanXTimes"]="lessThanXTimes",e["ExactlyXTimes"]="exactlyXTimes",e["MoreThanXTimes"]="moreThanXTimes",e))(Tc||{});const Ac=Symbol("SessionService");class Nc{constructor(e){if(new.target===Nc&&e!==Ac)throw new Error(`Invalid ${new.target.name} constructor`)}hasUserVisitedPage(){return this.getSessionVisitData().count>1}saveUserVisit(){const e=this.getSessionVisitData()||{count:0};sessionStorage.setItem("gaUserPageSessionVisit",JSON.stringify({...e,count:e.count+1}))}getSessionVisitData(){return JSON.parse(sessionStorage.getItem("gaUserPageSessionVisit"))}}const Uc=new Nc(Ac),Wc=Symbol("DebugSessionService");class Fc extends Nc{constructor(e){if(super(),new.target===Fc&&e!==Wc)throw new Error(`Invalid ${new.target.name} constructor`)}hasUserVisitedPage(){const e=ea(Ys.HasUserVisitPage);if(void 0===e)return super.hasUserVisitedPage();else return e}setHasUserVisitedPage(e){Qs(Ys.HasUserVisitPage,e)}}const _c=new Fc(Wc);function Vc(){return ta(Uc,_c)}Me=new WeakSet,Be=async(e,t=0)=>{if(e===Tc.Session)return!Vc().hasUserVisitedPage();if(e===Tc.OnceEveryDays){const e=await Dc().getLastActivityDate();if(e)return Va(e.getTime(),t)}if(e===Tc.OncePerTimeAmount){const e=await Dc().getLastActivityDate();if(e)return r=e.getTime(),i=t,Date.now()>=r+i}var r,i;const{totalCount:n}=Dc().getUserActivityDataFromBrowserStorage();if(e===Tc.ExactlyXTimes)return t===n;if(e===Tc.LessThanXTimes)return t>n;if(e===Tc.MoreThanXTimes)return n>t;else return true},Je=new WeakSet,$e=async e=>{const t=await Dc().isNewVisitor();switch(e){case So.New:return t;case So.Returning:return!t;default:return true}},Ge=new WeakSet,qe=function(e="*"){const t=window.location.pathname;return kn(this,ze,He).call(this,e,t)},ze=new WeakSet,He=(e,t)=>Za(t,e);const xc=new class{constructor(){En(this,Me),En(this,Je),En(this,Ge),En(this,ze)}async validateVisitorVisits({frequency:e,visitorType:t,frequencyDaysNumber:r,urlPath:i}){if(!kn(this,Ge,qe).call(this,i))return false;const[n,o]=await Promise.all([kn(this,Me,Be).call(this,e,r),kn(this,Je,$e).call(this,t)]);return n&&o}},Oc=Symbol("BrowserEventsStorageService");Ke=new WeakSet,Xe=(e,t,r)=>{!(e=>{if(!e.objectStoreNames.contains(fs.UserActivityEvents))try{const t=e.createObjectStore(fs.UserActivityEvents,{keyPath:"id",autoIncrement:true});t.createIndex(gs.EventType,"eventType",{unique:false}),t.createIndex(gs.VisitorUuid,"uuid",{unique:false}),t.createIndex(gs.EventTypeWithVisitor,["eventType","uuid"])}catch(t){On.error("Error while initializing/upgrading database",t)}})(r)};let Rc=class e{constructor(t){if(En(this,Ke),new.target===e&&t!==Oc)throw new Error(`Invalid ${new.target.name} constructor`)}async saveEvent(e){const t=e instanceof ba?e.normalize():e;try{const e=(await Ms.openEventsDatabaseConnection(kn(this,Ke,Xe))).transaction(fs.UserActivityEvents,"readwrite"),r=e.objectStore(fs.UserActivityEvents),i=await r.add(t);return await e.done,On.log(`Event with created id: ${i} saved to database`,t),i}catch(r){On.error("Error while saving event to database",r)}}async getEvents(e){const t=Rn(aa.visitorUuid);try{const r=(await Ms.openEventsDatabaseConnection(kn(this,Ke,Xe))).transaction(fs.UserActivityEvents,"readwrite"),i=r.objectStore(fs.UserActivityEvents).index(gs.EventTypeWithVisitor),n=await i.getAll([e,t]);return await r.done,n.map((e=>{const{id:t,...r}=e;return{...r,eventId:String(t)}}))}catch(r){On.error("Error while reading from database",r)}}async getEventById(e){const t=Rn(aa.visitorUuid);try{const r=(await Ms.openEventsDatabaseConnection(kn(this,Ke,Xe))).transaction(fs.UserActivityEvents,"readwrite"),i=r.objectStore(fs.UserActivityEvents),n=await i.get(e);if(await r.done,n&&n.uuid===t)return{...n,eventId:String(e)};else return null}catch(r){On.error("Error while reading from database",r)}}async updateEvent(e,t){const r=(await Ms.openEventsDatabaseConnection(kn(this,Ke,Xe))).transaction(fs.UserActivityEvents,"readwrite").objectStore(fs.UserActivityEvents),i=await r.get(e);if(i){const e=Jn(i,t);await r.put(e)}}async getPopupECommerceEvents(e){const t=Rn(aa.visitorUuid),r=(await Ms.openEventsDatabaseConnection(kn(this,Ke,Xe))).transaction(fs.UserActivityEvents,"readwrite").store.index(gs.VisitorUuid),i=[];let n=await r.openCursor(IDBKeyRange.only(t));for(;n;){const{value:t}=n;if(e(t)){const{id:e,...r}=t;i.push({eventId:String(e),...r})}n=await n.continue()}return i}};const Lc=new Rc(Oc),jc=Symbol("DebugBrowserEventsStorageService");class Mc extends Rc{constructor(e){if(super(),new.target===Mc&&e!==jc)throw new Error(`Invalid ${new.target.name} constructor`)}async getPopupECommerceEvents(e){const t=ea(Ys.Events)||[];if(!t.length)return super.getPopupECommerceEvents(e);else return t.filter(e)}async getEvents(e){const t=Rn(aa.visitorUuid),r=ea(Ys.Events)||[];if(!r.length)return super.getEvents(e);else return r.filter((({eventType:r,uuid:i})=>r===e&&i===t))}async saveEvent(e){const t=e instanceof ba?e.toJSON():e,r=[...ea(Ys.Events)||[],t];try{const e=JSON.stringify(r);return Qs(Ys.Events,r,e),Math.random()}catch(i){On.error(`Can't parse new debug events. Try again.`)}}}const Bc=new Mc(jc);function Jc(){return ta(Lc,Bc)}function $c(e,t,r){return r.filter((r=>r.popupEvent===t&&r.popupId===e))}function Gc(e,t){return $c(e,ma.Show,t).length>0}function qc(e,t){var r;const i=$c(e,ma.Show,t).sort(((e,t)=>Date.parse(t.occurredOn)-Date.parse(e.occurredOn)));if(!(null==(r=i[0])?void 0:r.occurredOn))return null;else return new Date(i[0].occurredOn)}function zc(e,t){return $c(e,ma.Close,t).length>0}function Hc(e,t){return $c(e,ma.Submit,t).length>0}function Kc(e,t){return $c(e,ma.Show,t).length}const Xc=new class{getStorage(){try{const e=localStorage.getItem("grPopupsServiceKey");return JSON.parse(e)}catch(e){On.error("Failed to get local storage data",e)}}getPopupEvents(){return Jc().getEvents(Kn.Popup)}async getLastPopupImpression(e){return qc(e,await this.getPopupEvents())}async getPopupImpressionsAmount(e){return Kc(e,await this.getPopupEvents())}async hasPopupBeenClosedBefore(e){return zc(e,await this.getPopupEvents())}async hasPopupBeenSeenInSession(e){return Gc(e,await this.getPopupEvents())}async hasPopupBeenSubmittedBefore(e){return Hc(e,await this.getPopupEvents())}_getPopupEventsFromLocalStorage(){var e,t;return null==(t=null==(e=this.getStorage())?void 0:e.events)?void 0:t.filter((e=>e.popupEvent===ma.Submit||ma.Close||ma.Show))}registerPopupClose(e){return this.addEventToStorage(ma.Close,e)}registerPopupSubmit(e){return this.addEventToStorage(ma.Submit,e)}registerPopupView(e){return this.addEventToStorage(ma.Show,e)}async migrateData(){if(!localStorage.getItem("grPopupsMigration")){const e=this._getPopupEventsFromLocalStorage();if(e)e.forEach((e=>{this.addEventToStorage(e.popupEvent,e.popupId,true)})),localStorage.setItem("grPopupsServiceKey",JSON.stringify({})),localStorage.setItem("grPopupsMigration","true")}}addEventToStorage(e,t,r){return da.eventBus.publish(pa.SaveEvent,{sendToBackend:false,preventRenotify:r},ya.createBlank(),Kn.Popup,{popupEventName:e,popupId:t}),Promise.resolve()}};class Yc{static sendJSON(e,t,r=true){const i=r?JSON.stringify({...JSON.parse(t),[io.UserAid]:da.getUserAid()}):t;navigator.sendBeacon(e,new Blob([i],{type:"application/json"}))}}const Zc=[Kn.OrderPlaced,Kn.Cart,Kn.LikeItem,Kn.UnlikeItem,Kn.WishlistItem,Kn.ViewItem,Kn.ViewCategory],Qc=[Kn.Cart,Kn.LikeItem,Kn.UnlikeItem,Kn.OrderPlaced,Kn.ViewCategory,Kn.ViewItem];Ye=new WeakSet,Ze=()=>new URL(`u/${da.getUserUuid()}/e/${fa.Web}/handle/`,da.userEventsStorageApplicationUrl).href;const eu=new class{constructor(){En(this,Ye)}async addPopupEventToStorage(e){throw new Error("Not implemented")}async getPopupActivityData(e){throw new Error("Not implemented")}async saveEventsToStorage(e){if(da.userEventsStorageApplicationUrl&&da.getUserUuid()){const t=e.filter((e=>Zc.includes(e.event.name)));if(t.length>0)Yc.sendJSON(kn(this,Ye,Ze).call(this),JSON.stringify(t),false)}else On.error("Attempt to send web events to search was made without search application endpoint or uuuid!")}async sendEventsToMetricsInc(e){const t=e.filter((e=>Qc.includes(e.event.name)));if(t.length>0){const e=JSON.stringify({events:t.map((e=>({eventType:e.event.name}))),url:window.location.origin}),r=new URL("/a/ue",da.getUserAnalyticsDomain()).href;Yc.sendJSON(r,e)}}},tu=Symbol("PopupsService");class ru{constructor(e){if(new.target===ru&&e!==tu)throw new Error(`Invalid ${new.target.name} constructor`)}setGrid(e){this.grid=e}setAid(e){this.aid=e}async registerPopupClose(e){return this.addEventToStorage(bc.getPopupCloseEvent(e))}async registerPopupSubmit(e){return this.addEventToStorage(bc.getPopupSubmitEvent(e))}async registerPopupView(e){return this.addEventToStorage(bc.getPopupShowEvent(e))}hasPopupBeenSeenInSession(e){return this.getPopupActivityData(e).then((e=>!!e.lastImpressionOccurredAt))}addEventToStorage(e){return eu.addPopupEventToStorage(e)}async getPopupActivityData(e){return eu.getPopupActivityData(e)}getLastPopupImpression(e){return this.getPopupActivityData(e).then((e=>new Date(e.lastImpressionOccurredAt)))}hasPopupBeenClosedBefore(e){return this.getPopupActivityData(e).then((e=>e.closes>0))}hasPopupBeenSubmittedBefore(e){return this.getPopupActivityData(e).then((e=>e.submits>0))}getPopupImpressionsAmount(e){return this.getPopupActivityData(e).then((e=>e.impressions))}}function iu(){return Xc}new ru(tu);const nu=Symbol("DebugPopupService");class ou extends ru{constructor(e){if(super(),this.hasPopupBeenSeenInSession=e=>{const t=this.getAllEvents();return Promise.resolve(Gc(e,t))},this.getLastPopupImpression=e=>{var t;const r=qc(e,this.getAllEvents());if(isNaN(null==(t=null==r?void 0:r.getTime)?void 0:t.call(r)))return iu().getLastPopupImpression(e);else return Promise.resolve(r)},this.hasPopupBeenClosedBefore=e=>{const t=this.getAllEvents();return Promise.resolve(zc(e,t))},this.hasPopupBeenSubmittedBefore=e=>{const t=this.getAllEvents();return Promise.resolve(Hc(e,t))},this.getPopupImpressionsAmount=e=>{const t=this.getAllEvents();return Promise.resolve(Kc(e,t))},new.target===ou&&e!==nu)throw new Error(`Invalid ${new.target.name} constructor`)}getAllEvents(){return ea(Ys.Events)||[]}}const su=new ou(nu);function au(){return ta(iu(),su)}const cu="https://us-wbe.gr-cdn.com/dynamic/gr-popups.js";var uu=(e=>(e["PopupShow"]="popupShow",e["PopupClose"]="popupClose",e))(uu||{});const lu=new class extends $n{notifyPopupShow(e){this.emit(uu.PopupShow,e)}notifyPopupClose(e){this.emit(uu.PopupClose,e)}};Qe=new WeakMap,et=new WeakMap;const du=new class extends $n{constructor(){super(...arguments),En(this,Qe,false),En(this,et,false)}attachPopupLibrary(){return new Promise(((e,t)=>{if(In(this,Qe))e();else if(In(this,et))this.on("libraryAttachingFinished",e,{once:true});else{Cn(this,et,true);const r=document.createElement("script");r.src=da.getPopupRendererCustomUrl()??cu,r.async=true,r.addEventListener("load",(()=>{Cn(this,Qe,true),Cn(this,et,false),this.emit("libraryAttachingFinished"),e()}),{once:true}),r.addEventListener("error",t),document.head.appendChild(r)}}))}};tt=new WeakMap;const pu="https://",hu="http://",mu="www.",wu=/^(http:\/\/|https:\/\/)/;class fu{constructor(e){this.url=e,this.enhancedUrls=[]}static create(e){return new fu(decodeURI(e))}withSlash(){if(!(this.url.endsWith("*")||this.url.endsWith("+")||this.url.includes("?")||this.url.endsWith("/")))this.url=`${this.url}/`;return this}withLackOfProtocolAndWww(){if(!this.url.startsWith("*")&&!this.hasProtocolIncluded()&&!this.hasWwwPart())this.enhancedUrls=[...this.enhancedUrls,`${pu}${this.url}`,`${hu}${this.url}`,`${pu}${mu}${this.url}`,`${hu}${mu}${this.url}`];return this}withEnforcedProtocol(){if(!this.hasProtocolIncluded())this.enhancedUrls=[...this.enhancedUrls,`${pu}${this.url}`,`${hu}${this.url}`];return this}withDecodeSpecialChars(){return this.enhancedUrls=this.enhancedUrls.map((e=>decodeURI(e))),this}withLackOfWww(){if(this.url.startsWith("*"))return this;if(this.hasProtocolIncluded()&&!this.hasWwwPart())this.enhancedUrls=[...this.enhancedUrls,`${pu}${mu}${this.url.replace(wu,"")}`,`${hu}${mu}${this.url.replace(wu,"")}`];return this}withLackOfProtocol(){if(this.url.startsWith("*"))return this;if(!this.hasProtocolIncluded()&&this.hasWwwPart())this.enhancedUrls=[...this.enhancedUrls,`${pu}${this.url}`,`${hu}${this.url}`];return this}enhance(){return[...this.enhancedUrls,this.url]}hasProtocolIncluded(){return this.url.startsWith(pu)||this.url.startsWith(hu)}hasWwwPart(){return this.url.replace(/^(http:\/\/|https:\/\/)/,"").startsWith(mu)}}function gu(e,t){return(e=>e.map((e=>fu.create(e).withSlash().withLackOfProtocolAndWww().withLackOfProtocol().withLackOfWww().withDecodeSpecialChars().enhance())).flat(1))(t).some((t=>{const r=Array.from(t.matchAll(/[*+]/g));let i;if(r.length)i=r.reduce(((e,r,i,n)=>{var o;const s=[...e,vu(t.substring(((null==(o=n[i-1])?void 0:o.index)??-1)+1,r.index)),"*"===r[0]?".*":"."];if(i===n.length-1)s.push(vu(t.substring(r.index+1)));return s}),[]).join("");else i=vu(t);return new RegExp(`^${i}$`).test((e=>{if(!e.includes("?")&&!e.endsWith("/"))return`${decodeURI(e)}/`;else return decodeURI(e)})(e))}))}function vu(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}rt=new WeakMap,it=new WeakSet,nt=function(e,t,r,i="eq"){if(r.has(e))return kn(this,ot,st).call(this,t,r.get(e),i);else return false},ot=new WeakSet,st=(e,t,r="eq")=>{switch(r){case"eq":return!!decodeURIComponent(t).match(new RegExp(`^${decodeURIComponent(e).replaceAll("*",".*").replaceAll("+",".")}$`));default:return qn(r),false}};let yu=class e{constructor({baseUrl:e,queryParamsSelectionRule:t,queryParams:r,path:i,currentUrl:n}){En(this,it),En(this,ot),En(this,rt,(e=>{var t;const r=new URL(this.path||"",e),i=new URL(this.currentUrl);for(const[n,o]of Object.entries(this.queryParams||{}))r.searchParams.append(n,o.value);if(this.queryParams)if("all"===this.queryParamsSelectionRule){if(!Array.from(r.searchParams.entries()).every((([e,t])=>kn(this,it,nt).call(this,e,t,i.searchParams,this.queryParams[e].operator))))return false}else if(!Array.from(r.searchParams.entries()).some((([e,t])=>kn(this,it,nt).call(this,e,t,i.searchParams,this.queryParams[e].operator))))return false;if(this.path)if(!kn(this,ot,st).call(this,r.pathname,i.pathname))return false;return kn(this,ot,st).call(this,null==(t=r.origin)?void 0:t.toLowerCase(),i.origin)})),this.baseUrl=e,this.path=i,this.queryParams=r,this.queryParamsSelectionRule=t,this.currentUrl=n}static create(t){return new e(t)}isOnCurrentUrl(){return fu.create(this.baseUrl).withEnforcedProtocol().withLackOfProtocolAndWww().withLackOfWww().withSlash().enhance().filter((e=>{try{return new URL(e),true}catch(t){return On.warn("Invalid URL",e),false}})).some(In(this,rt))}};function bu(e){return e.sort(((e,t)=>Date.parse(t.occurredOn)-Date.parse(e.occurredOn)))[0].eventType===Kn.LikeItem}const Su=1e3*60*60*24;function Pu(e,t,r){switch(r){case"equal":return e===t;case"lessThan":return t>e;case"moreThan":return e>t;default:qn(r)}}function Iu(e,t){var r;const{category:i,amount:n,product:o,price:s}=e.condition,{products:a,price:c}=t.data;let u=false;if(o){if("any"===o.id)u=true;if(a.some((e=>o.id.includes(e.product.id))))u=true}if(i){if("any"===i.id)u=true;if(a.some((e=>e.categories.some((e=>i.id.includes(e.id))))))u=true}if(n){const{value:e,condition:t}=n;if(Pu(a.reduce(((e,t)=>e+t.quantity),0),e,t))u=true}if(s){const{value:e,condition:t}=s;if(Pu(c,e,t))u=true}if(u)u=Eu(t,null==(r=e.settings)?void 0:r.date);return u}function Eu(e,t,{ignoreToDateInDateRange:r}={}){const{occurredOn:i}=e;if(t){const{name:e,value:n}=t;if(e===Do.LastDays)return new Date(i).getTime()>Date.now()-n*Su;if(e===Do.DateRange){const{from:e,to:t}=n,o=new Date(i).getTime(),s=!e||new Date(e).getTime()<o;let a=!t||o<new Date(t).getTime();if(r)a=true;return s&&a}return On.error(`Unknown date condition name: ${e} in ecommerce activity filter node`),false}return true}const Cu=[Kn.ViewItem,Kn.ViewCategory,Kn.LikeItem,Kn.UnlikeItem,Kn.OrderPlaced,Kn.Cart,Kn.WishlistItem];function ku(e){return Cu.includes(e.eventType)}function Du(e){return Wu(e,Kn.ViewCategory)}function Tu(e){return Wu(e,Kn.ViewItem)}function Au(e){return Wu(e,Kn.LikeItem)}function Nu(e){return Wu(e,Kn.OrderPlaced)}function Uu(e){return Wu(e,Kn.Cart)}function Wu(e,t){return"object"==typeof e&&null!==e&&"eventType"in e&&e["eventType"]===t}var Fu=(e=>(e["EventsAmount"]="eventsAmount",e["EventsTimeSpent"]="eventsTimeSpent",e))(Fu||{}),_u=(e=>(e["Or"]="or",e["And"]="and",e))(_u||{});async function Vu(e,t,r){let i=await Jc().getEvents(e)||[];if(r||t)i=i.filter((e=>{const i=Date.parse(e.occurredOn);return!(r&&i>r||t&&t>i)}));return i}var xu=(e=>(e["LessThan"]="lt",e["LessThanOrEqual"]="lte",e["Equal"]="eq",e["GreaterThanOrEqual"]="gte",e["GreaterThan"]="gt",e))(xu||{});async function Ou({pastEventsCheckFn:e,rule:t,event:r,eventTypes:i}){const{totalEventsDuration:n,timeTo:o,timeFrom:s}=t;let a;if(r)a=(await Vu(r.eventType,s,o)).filter((e=>e.eventId!==r.eventId));else if(i)a=(await Promise.all(i.map((e=>Vu(e,s,o))))).flat();return a=await(async t=>{const r=await Promise.all(t.map((t=>e(t))));return t.filter(((e,t)=>r[t]))})(a),a.reduce(((e,t)=>e+t.time),(null==r?void 0:r.time)||0)>=n}at=new WeakSet,ct=async({eventTypes:e,pastEventsCheckFn:t,rule:r,event:i})=>{switch(r.type){case Fu.EventsAmount:return(async({pastEventsCheckFn:e,rule:t,event:r,eventTypes:i})=>{const{amount:n,timeTo:o,timeFrom:s,comparisonOperator:a="gte"}=t;let c;if(r)c=await Vu(r.eventType,s,o);else if(i)c=(await Promise.all(i.map((e=>Vu(e,s,o))))).flat();else throw new Error("Event or event types not provided");const u=c.filter((e=>e.eventId!==(null==r?void 0:r.eventId))).map((t=>e(t))),l=(await Promise.all(u)).filter(Boolean).length+(r?1:0);switch(a){case"eq":return l===n;case"gt":return l>n;case"lt":return n>l;case"gte":return l>=n;case"lte":return n>=l;default:qn(a)}})({event:i,rule:r,pastEventsCheckFn:t,eventTypes:e});case Fu.EventsTimeSpent:{const n=Array.isArray(e)&&(null==e?void 0:e.every((e=>e===Kn.ViewItem||e===Kn.ViewCategory))),o=i&&(i.eventType===Kn.ViewItem||i.eventType===Kn.ViewCategory);if(n||o)return Ou({event:i,eventTypes:e,rule:r,pastEventsCheckFn:t});throw new Error("Time spent modifier can be used only with view item or view category events")}default:qn(r)}};const Ru=new class{constructor(){En(this,at)}async checkECommerceEventModificators({eventTypes:e,modificators:t,pastEventsCheckFn:r,event:i}){const{separator:n,rules:o}=t,s=o.map((t=>kn(this,at,ct).call(this,{rule:t,event:i,pastEventsCheckFn:r,eventTypes:e})));if(n===_u.And)return Promise.all(s).then((e=>e.every((e=>e))));else if(n===_u.Or)return Promise.all(s).then((e=>e.some((e=>e))))}};var Lu=(e=>(e["Popup"]="popup",e["Automation"]="automation",e))(Lu||{});async function ju(e,t){const{amount:r,value:i,product:n,category:o}=e,{price:s,products:a}=t.data;if(r){const{condition:e,value:t}=r,i=a.reduce(((e,t)=>e+t.quantity),0);switch(e){case"equal":return i===t;case"lessThan":return t>i;case"moreThan":return i>t}}if(i){const{condition:e,value:t}=i;switch(e){case"equal":return s===t;case"lessThan":return t>s;case"moreThan":return s>t}}if(n){const{id:e}=n;if("any"===e)return true;else if(Array.isArray(e))return a.some((t=>e.includes(t.product.id)))}if(o){const{id:e}=o;if("any"===e)return true;else if(Array.isArray(e))return a.some((t=>{const{categories:r}=t;return r.some((t=>e.includes(t.id)))}))}throw new Error("Unknown condition in order placed ecommerce activity node condition")}async function Mu(e,t){const{data:r}=t,{modifiers:i,...n}=e,{id:o,category:s}=n;let a=false;if("any"===o)a=true;else if(Array.isArray(o))a=o.includes(r.product.id);else if("any"===s)a=r.categories.length>0;else if(Array.isArray(s))a=s.some((e=>{var t;return null==(t=r.categories)?void 0:t.find((t=>t.id===e))}));if(a&&i)return da.eventBus.publish(ha.UserECommerceEventMatchedByECommerceElement,t),Ru.checkECommerceEventModificators({event:t,modificators:i,pastEventsCheckFn(e){return Mu(n,e)}});else return a}async function Bu(e,t){const{data:r}=t,{modifiers:i,...n}=e,{id:o}=n;let s=false;if("any"===o)s=true;else if(Array.isArray(o))s=o.includes(r.id);if(s&&i)return da.eventBus.publish(ha.UserECommerceEventMatchedByECommerceElement,t),Ru.checkECommerceEventModificators({event:t,modificators:i,pastEventsCheckFn(e){return Bu(n,e)}});else return s}const Ju=new Map;ut=new WeakMap,lt=new WeakMap,dt=new WeakSet,pt=async function(e){const{conditions:t,separator:r="or"}=this.properties;if("or"===r){const r=t.map((t=>kn(this,ht,mt).call(this,t,e))),i=await Promise.race(r);if(i)kn(this,gt,vt).call(this,e.eventId);return i}else if("and"===r){let r;for(const i of t)if(await kn(this,ht,mt).call(this,i,e))r=i;if(r)return In(this,lt).push(r.conditionId),kn(this,gt,vt).call(this,e.eventId),this.properties.conditions.every((e=>In(this,lt).includes(e.conditionId)))}else qn(r)},ht=new WeakSet,mt=(e,t)=>{const{product:r,category:i,likeProduct:n,orderPlaced:o,cartUpdate:s}=e;if(r&&Tu(t))return Mu(r,t);if(i&&Du(t))return Bu(i,t);if(n&&Au(t))return(async(e,t)=>{const{product:r}=e;let i=false;if("any"===r.id)i=true;else if(Array.isArray(r.id))i=r.id.includes(t.data.product.id);if(i)da.eventBus.publish(ha.UserECommerceEventMatchedByECommerceElement,t);return i})(n,t);if(o&&Nu(t))return(async(e,t)=>ju(e,t))(o,t);if(s&&Uu(t))return(async(e,t)=>ju(e,t))(s,t);else return Promise.resolve(false)},wt=new WeakSet,ft=async function(){if(In(this,ut)){const e=await da.temporaryEventsStorage.getAllECommerceEvents();for(const t of e)if(!kn(this,yt,bt).call(this,t.eventId))if(await kn(this,dt,pt).call(this,t))return true}else On.error("Could not find graph id for await ecommerce activity node",this.id)},gt=new WeakSet,vt=function(e){if(Ju.has(In(this,ut)))Ju.get(In(this,ut)).add(e);else Ju.set(In(this,ut),new Set([e]))},yt=new WeakSet,bt=function(e){if(Ju.has(In(this,ut)))return Ju.get(In(this,ut)).has(e);else return false};const $u=new class{generateRandomUuid(){if("randomUUID"in window.crypto)return window.crypto.randomUUID();const e=window.URL.createObjectURL(new Blob([])),t=e.slice(-36);return window.URL.revokeObjectURL(e),t}},Gu=1e3;St=new WeakMap,Pt=new WeakMap;class qu{constructor(e){this.resourceId=e}toJSON(){return{...this}}processBeforeExecution(){return Promise.resolve()}}class zu extends qu{constructor(e,t,r){super(e),this.type=hs.Api,this.data=t,this.issuer=r}isSame(e){return e.issuer.id===this.issuer.id&&this.type===e.type}}class Hu extends qu{constructor(e,t,r){super(e),this.type=hs.Db,this.data=t,this.issuer=r}isSame(e){return e.issuer.id===this.issuer.id&&this.type===e.type}}class Ku extends zu{constructor(){super(...arguments),this.type=hs.AutomationJourneyReactWebPushApi}processBeforeExecution(){const e=JSON.parse(this.data.body),t=e.transitions.at(-1),r=(new Date).toISOString();if(t.leave.occurred_at=r,t.entered)t.entered.occurred_at=r;return this.data.body=JSON.stringify(e),Promise.resolve()}}class Xu extends Hu{constructor(){super(...arguments),this.type=hs.AutomationJourneyReactWebPushDb}processBeforeExecution(){if("put"===this.data.operationType){const e=structuredClone(this.data.data);e.node_entered_at=(new Date).toISOString(),this.data.data=e}return Promise.resolve()}}class Yu{static create(e){const{type:t}=e;switch(t){case hs.Api:return new zu(e.resourceId,e.data,e.issuer);case hs.Db:return new Hu(e.resourceId,e.data,e.issuer);case hs.AutomationJourneyReactWebPushApi:return new Ku(e.resourceId,e.data,e.issuer);case hs.AutomationJourneyReactWebPushDb:return new Xu(e.resourceId,e.data,e.issuer);default:qn(t)}}}It=new WeakSet,Et=async function(e,t){return(await Ms.openServiceWorkerCallbacksDatabaseConnection(kn(this,Ct,kt))).transaction(e,t)},Ct=new WeakSet,kt=(e,t,r)=>{!(e=>{if(!e.objectStoreNames.contains(ys.Callbacks))e.createObjectStore(ys.Callbacks)})(r)};const Zu=new class{constructor(){En(this,It),En(this,Ct)}async addCallback(e){const t=await kn(this,It,Et).call(this,ys.Callbacks,"readwrite"),r=t.objectStore(ys.Callbacks),i=await r.get(e.resourceId);if(!(i||[]).find((t=>e.isSame(t))))await r.put([...i||[],e.toJSON()],e.resourceId);await t.done}async getCallbacks({resourceId:e}){const t=await kn(this,It,Et).call(this,ys.Callbacks,"readonly"),r=t.objectStore(ys.Callbacks),i=await r.get(e);if(await t.done,i)return i.map((e=>Yu.create(e)))}async deleteCallbacks({resourceId:e}){const t=await kn(this,It,Et).call(this,ys.Callbacks,"readwrite"),r=t.objectStore(ys.Callbacks);await r.delete(e),await t.done}};Dt=new WeakSet,Tt=()=>({visitorUuid:Rn(aa.visitorUuid),user_uuid:da.getUserUuid()}),At=new WeakSet,Nt=(e,t)=>`/c/${Mn(e)}/v/${Mn(t)}/state/`;const Qu=new class{constructor(){En(this,Dt),En(this,At)}getVisitorJourneys({visitorUuid:e,user_uuid:t}=kn(this,Dt,Tt).call(this)){return Na(new URL(kn(this,At,Nt).call(this,t,e),da.visitorApplicationEndpoint).href)}sendVisitorTransitions(e,{visitorUuid:t,user_uuid:r}=kn(this,Dt,Tt).call(this)){return Na(this.getVisitorApplicationEndpoint(r,t),{omitAidHeader:true,headers:{"Content-Type":"application/json"},body:JSON.stringify(e),method:"PUT"})}getVisitorApplicationEndpoint(e,t){return new URL(kn(this,At,Nt).call(this,e,t),da.visitorApplicationEndpoint).href}};var el=(e=>(e["PushNotificationDisplayed"]="pushNotificationDisplayed",e["ReceiptOfPushNotificationDisplayedConfirmation"]="receiptOfPushNotificationDisplayedConfirmation",e))(el||{});Ut=new WeakSet,Wt=e=>window.navigator.serviceWorker.ready.then((t=>t.active.postMessage(e)));const tl=new class{constructor(){En(this,Ut)}waitForWebPushReceptionConfirmation(e){return new Promise((t=>{window.navigator.serviceWorker.addEventListener("message",(r=>{if(r.origin===window.location.origin&&!!(i=r).data&&"object"==typeof i.data&&"type"in i.data&&i.data.type===el.PushNotificationDisplayed){const{messageId:i}=r.data.data;if(i===e)kn(this,Ut,Wt).call(this,{type:el.ReceiptOfPushNotificationDisplayedConfirmation,data:{messageId:e}}).catch((e=>{On.error("Failed to send message to service worker about confirmation of push reception",e)})),t()}var i}))}))}async saveCallbackForServiceWorker({apiCallbackData:e,dbCallbackData:t,senderId:r,messageId:i}){const n=Yu.create({type:hs.AutomationJourneyReactWebPushDb,resourceId:i,issuer:{id:r},data:{dbName:ms.VisitorJourneys,operationType:t.operationType,key:"put"===t.operationType?void 0:[t.data.journey.uuid,Rn(aa.visitorUuid)],objectStore:vs.VisitorJourneys,data:t.data.toSerializedDatabaseJSON()}}),o=Yu.create({type:hs.AutomationJourneyReactWebPushApi,resourceId:i,issuer:{id:r},data:{body:JSON.stringify(e.toJSON()),headers:{"Content-Type":"application/json"},method:"PUT",url:Qu.getVisitorApplicationEndpoint(da.getUserUuid(),Rn(aa.visitorUuid))}});await Promise.all([Zu.addCallback(n),Zu.addCallback(o)])}};class rl extends Oa{constructor(e){super(`Failed to send message: ${e}`)}}const il=new class{constructor(){this.authToken=null}async getAuthToken(){const{pushWpid:e,pushDomain:t}=da;if(e)try{if(this.authToken)return this.authToken;const r=await fetch(`${t}webpush/auth`,{method:"POST",mode:"cors",headers:{"X-WpId":e,"Content-Type":"application/json"},body:JSON.stringify({url:window.location.origin,gau:Rn("gaVisitorUuid")})});return this.authToken=await r.text(),this.authToken}catch(r){On.error(r)}}};function nl(e){this.message=e}(nl.prototype=new Error).name="InvalidCharacterError";var ol="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||(e=>{var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new nl("'atob' failed: The string to be decoded is not correctly encoded.");for(var r,i,n=0,o=0,s="";i=t.charAt(o++);~i&&(r=n%4?64*r+i:i,n++%4)?s+=String.fromCharCode(255&r>>(-2*n&6)):0)i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(i);return s});function sl(e){this.message=e}function al(e,t){if("string"!=typeof e)throw new sl("Invalid token specified");var r=true===(t=t||{}).header?0:1;try{return JSON.parse((e=>{var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return decodeURIComponent(ol(t).replace(/(.)/g,((e,t)=>{var r=t.charCodeAt(0).toString(16).toUpperCase();return 2>r.length&&(r="0"+r),"%"+r})))}catch(r){return ol(t)}})(e.split(".")[r]))}catch(i){throw new sl("Invalid token specified: "+i.message)}}(sl.prototype=new Error).name="InvalidTokenError";const cl="gr_webpush_database",ul="gr_visitor_data",ll="sub_data",dl=480;var pl=(e=>(e["DISPLAYED_CUSTOMIZED"]="dic",e["ACCEPTED_CUSTOMIZED"]="acc",e["DENIED_CUSTOMIZED"]="dec",e["DISPLAYED_NATIVE"]="din",e["ACCEPTED_NATIVE"]="acn",e["DENIED_NATIVE"]="den",e))(pl||{}),hl=(e=>(e["V1"]="1.0.0",e["V1_1"]="1.1.0",e["V2"]="2.0.0",e["V2_1"]="2.1.0",e))(hl||{});function ml({promptId:e,pushSubscription:t,wpid:r=da.pushWpid,domain:i=da.pushDomain,id:n}){window.indexedDB.deleteDatabase(cl),window.indexedDB.open(cl,1).onupgradeneeded=o=>{o.target.result.createObjectStore(ul,{keyPath:"id"}).add({id:ll,uuid:n,pushSubscription:t.toJSON(),domain:i,wpid:r,visitor:{pid:e,lang:cs.getBrowserLanguage()}})}}class wl{get promptId(){var e;return null==(e=this.promptData)?void 0:e.id}get statisticsEndpoint(){var e;return da.pushDomain+(null==(e=this.promptData)?void 0:e.pst)}get hasMobile(){var e,t;return!!(null==(t=null==(e=this.promptData)?void 0:e.data)?void 0:t.mobile)}get hasDesktop(){var e,t;return!!(null==(t=null==(e=this.promptData)?void 0:e.data)?void 0:t.desktop)}get mobilePromptData(){var e,t;return null==(t=null==(e=this.promptData)?void 0:e.data)?void 0:t.mobile}get desktopPromptData(){var e,t;return null==(t=null==(e=this.promptData)?void 0:e.data)?void 0:t.desktop}get showAgainAfter(){var e;return(null==(e=this.promptData)?void 0:e.showAgainAfter)||ca.ThreeMonths}shouldPromptBasedOnTriggersBeDisplayed(){return Promise.resolve(true)}}class fl extends wl{constructor(e){super(),this.promptData={id:e.pid,pst:e.pst,data:e.pc}}setActivePrompt(){throw new Error("Method not implemented in Prompt v1")}}function gl(e){const t=new URL(document.location.href).host;return gu(document.location.href,(Array.isArray(e)?e:[e]).map((e=>`${t}${e}`)))}var vl=(e=>(e["Includes"]="allowed",e["Excluded"]="excluded",e["Entire"]="entire",e))(vl||{}),yl=(e=>(e["Delay"]="delay",e["ExitIntend"]="exitIntend",e["Inactivity"]="inactivity",e["Scroll"]="scroll",e["Click"]="click",e["Location"]="location",e["Device"]="device",e["VisitorType"]="visitorType",e))(yl||{}),bl=(e=>(e["New"]="new",e["Returning"]="returning",e["All"]="all",e))(bl||{});Ft=new WeakMap,_t=new WeakMap,Vt=new WeakMap,xt=new WeakSet,Ot=function(e){In(this,Vt).push({...e})};let Sl=class e{constructor({automationJourney:e}){if(En(this,xt),En(this,Ft,void 0),En(this,_t,[]),En(this,Vt,[]),e)Cn(this,Ft,e)}static create(t={}){return new e(t)}withNode(e,t){return In(this,_t).push({type:e,...t}),this}withConnection(e){return kn(this,xt,Ot).call(this,e),this}withCascadeConnectionFalseOut({fromNodes:e,targetNode:t}){return e.forEach(((r,i)=>{if(i!==e.length-1)kn(this,xt,Ot).call(this,{from:r,to:e[i+1],fromPathKey:"false"});kn(this,xt,Ot).call(this,{from:r,to:t,fromPathKey:"true"})})),this}withSeriesConnectionTrueOut({fromNodes:e,targetNode:t}){return e.forEach(((r,i)=>{if(i===e.length-1)kn(this,xt,Ot).call(this,{from:r,to:t,fromPathKey:"true"});else kn(this,xt,Ot).call(this,{from:r,to:e[i+1],fromPathKey:"true"})})),this}build(){return{...In(this,Ft)||{},nodes:In(this,_t),connections:In(this,Vt)}}};var Pl=(e=>(e["NodeProcessed"]="nodeProcessed",e))(Pl||{});Rt=new WeakSet,Lt=function(e,{awaitsSeparator:t,filtersSeparator:r}){const i=Sl.create(),n=i.build(),o=kn(this,$t,Gt).call(this,i),s=[],a=[];for(const u of e)switch(u.type){case yl.Delay:s.push(kn(this,er,tr).call(this,u));break;case yl.Click:s.push(kn(this,qt,zt).call(this,u));break;case yl.ExitIntend:s.push(kn(this,Zt,Qt).call(this));break;case yl.Inactivity:s.push(kn(this,Xt,Yt).call(this,u));break;case yl.Scroll:s.push(kn(this,Ht,Kt).call(this,u));break;case yl.Location:a.push(kn(this,rr,ir).call(this,i,u));break;case yl.Device:a.push(kn(this,nr,or).call(this,i,u));break;case yl.VisitorType:a.push(kn(this,sr,ar).call(this,i,u));break;default:qn(u)}const c=kn(this,Bt,Jt).call(this,i,s,t);return kn(this,jt,Mt).call(this,i,{filterUrlId:o,mergedAwaitsNodeId:c,filterElementsIds:a,filtersSeparator:r}),{webFlow:new od({webflowSerializedData:n}),finalElementId:o,flowData:n}},jt=new WeakSet,Mt=(e,t)=>{const{filterUrlId:r,filtersSeparator:i,filterElementsIds:n,mergedAwaitsNodeId:o}=t;let s=r;if(n.length>0){if("or"===i)e.withCascadeConnectionFalseOut({fromNodes:n,targetNode:s});else if("and"===i)e.withSeriesConnectionTrueOut({fromNodes:n,targetNode:s});s=n[0]}if(o)e.withConnection({from:o,to:s,fromPathKey:"true"})},Bt=new WeakSet,Jt=(e,t,r)=>{if(t.length){const i=$u.generateRandomUuid();return e.withNode(Tn.AwaitMergedNodes,{id:i,recurrent:{type:so.EveryTime,value:false},properties:{leaveFalseDelay:0,nodesDefinition:t,separator:r}}),i}return""},$t=new WeakSet,Gt=e=>{const t=$u.generateRandomUuid();return e.withNode(Tn.FilterUrl,{id:t,properties:{urls:[window.location.origin]},recurrent:{type:so.EveryTime,value:false}}),t},qt=new WeakSet,zt=e=>({id:$u.generateRandomUuid(),type:Tn.AwaitClick,properties:{selector:e.value.selector,leaveFalseDelay:0}}),Ht=new WeakSet,Kt=e=>({id:$u.generateRandomUuid(),type:Tn.AwaitScroll,properties:{leaveFalseDelay:0,..."selector"===e.value.scrollType?{selector:e.value.value.selector}:{percent:e.value.value.percent}}}),Xt=new WeakSet,Yt=e=>({id:$u.generateRandomUuid(),type:Tn.AwaitInactivity,properties:{inactivityTime:e.value.delay,leaveFalseDelay:0}}),Zt=new WeakSet,Qt=()=>({id:$u.generateRandomUuid(),type:Tn.AwaitExit,properties:{leaveFalseDelay:0,useMobileScrollBasedExitIntend:true,useMobileHistoryBasedExitIntend:true}}),er=new WeakSet,tr=e=>({id:$u.generateRandomUuid(),type:Tn.ReactDelay,properties:{delay:e.value.timeout}}),rr=new WeakSet,ir=(e,t)=>{const r=$u.generateRandomUuid();return e.withNode(Tn.FilterLocation,{id:r,properties:{locations:t.value.locations},recurrent:{type:so.EveryTime,value:false}}),r},nr=new WeakSet,or=(e,t)=>{const r=$u.generateRandomUuid();return e.withNode(Tn.FilterDevice,{id:r,properties:{deviceType:t.value.devices},recurrent:{type:so.EveryTime,value:false}}),r},sr=new WeakSet,ar=(e,t)=>{const r=$u.generateRandomUuid(),{visitorType:i,returningVisitorVisitAmount:n,returningVisitorVisitAmountType:o}=t.value,s={};if("number"==typeof n&&i===bl.Returning)switch(s.frequencyDaysNumber=n,o){case"equal":s.frequency=Tc.ExactlyXTimes;break;case"before":s.frequency=Tc.LessThanXTimes;break;case"after":s.frequency=Tc.MoreThanXTimes;break;default:qn(o)}else s.visitors=i;return e.withNode(Tn.FilterVisit,{id:r,properties:s,recurrent:{type:so.EveryTime,value:false}}),r};const Il=new class{constructor(){En(this,Rt),En(this,jt),En(this,Bt),En(this,$t),En(this,qt),En(this,Ht),En(this,Xt),En(this,Zt),En(this,er),En(this,rr),En(this,nr),En(this,sr)}doesVisitorMeetsTriggers(e,t={awaitsSeparator:"or",filtersSeparator:"and"}){const{webFlow:r,finalElementId:i,flowData:n}=kn(this,Rt,Lt).call(this,e,t);return da.webPushActivePromptGraph={originalTriggers:e,transformedGraph:n},r.initVisitorFlow(),new Promise((e=>{const t=new AbortController;r.on(Pl.NodeProcessed,(({id:r})=>{if(r===i)t.abort(),e(true)}),{signal:t.signal})}))}};class El extends wl{constructor(e){super(),En(this,cr),En(this,lr),this.globalPromptConfig=e,kn(this,cr,ur).call(this,e)}setActivePrompt(e){const t=this.globalPromptConfig.customPrompts.find((t=>t.pid===e));if(t)this.promptData={id:t.pid,pst:t.pst,data:t.pc,showAgainAfter:t.showAgainAfter,triggers:t.triggers||{}}}async shouldPromptBasedOnTriggersBeDisplayed(){const{triggers:e,triggersAwaitsSeparator:t,triggersFilterSeparator:r}=kn(this,lr,dr).call(this,this.promptData.triggers);return Il.doesVisitorMeetsTriggers(e,{awaitsSeparator:t,filtersSeparator:r})}}cr=new WeakSet,ur=function(e){const t=e.paths.map((e=>{switch(e.type){case vl.Entire:return{...e,type:vl.Includes,path:"*"};case vl.Includes:case vl.Excluded:return{...e,path:e.path.startsWith("/")?`${e.path}*`:`*${e.path}*`};default:return e}})).find((e=>e.type===vl.Includes?gl(e.path):!gl(e.path)));if(e.nativePrompt&&e.nativePrompt.pid===(null==t?void 0:t.pid))return this.promptData={id:e.nativePrompt.pid,pst:e.nativePrompt.pst,data:null},void 0;const r=e.customPrompts.find((e=>e.pid===(null==t?void 0:t.pid)));if(r)this.promptData={id:r.pid,pst:r.pst,data:r.pc,showAgainAfter:r.showAgainAfter,triggers:r.triggers||{}}},lr=new WeakSet,dr=e=>{var t,r;const{awaits:i={},filters:n={},filtersSeparator:o="and",awaitsSeparator:s="or"}=e,a=[];if(i.delay)a.push({type:yl.Delay,value:{timeout:i.delay}});if(i.inactivity)a.push({type:yl.Inactivity,value:{delay:i.inactivity}});if(i.exitIntend)a.push({type:yl.ExitIntend});if(i.click)a.push({type:yl.Click,value:{selector:i.click}});if(null==(t=i.scroll)?void 0:t.selector)a.push({type:yl.Scroll,value:{scrollType:"selector",value:{selector:i.scroll.selector}}});if(null==(r=i.scroll)?void 0:r.percent)a.push({type:yl.Scroll,value:{scrollType:"percent",value:{percent:i.scroll.percent}}});if(n.location)a.push({type:yl.Location,value:{locations:n.location}});if(n.device)a.push({type:yl.Device,value:{devices:n.device}});if(n.visit)a.push({type:yl.VisitorType,value:{visitorType:n.visit.visitorType,returningVisitorVisitAmount:n.visit.returningVisitorVisitCount,returningVisitorVisitAmountType:n.visit.returningVisitorType}});return{triggers:a,triggersAwaitsSeparator:s,triggersFilterSeparator:o}};class Cl{constructor(e){this.nativePromptPaths=[],this.version=e._v;const t=e,r=e;switch(this.version){case hl.V1:case hl.V1_1:this.prompt=new fl(t),this.nativePromptPaths=t.paths;break;case hl.V2:case hl.V2_1:this.prompt=new El(r);break;default:throw new Error("Unsupported version of prompt")}}get shouldShowNativePrompt(){var e,t,r;if(this.version===hl.V2||this.version===hl.V2_1){if(!(null==(e=this.prompt)?void 0:e.hasDesktop)&&!(null==(t=this.prompt)?void 0:t.hasMobile)&&(null==(r=this.prompt)?void 0:r.promptId))return true}else if(gl(this.nativePromptPaths))return true;return false}getVersion(){return this.version}}const kl=new class{async initialize(){await this.fetchSiteConfig(da.pushPromptEndpoint),this.promptConfig=new Cl(globalThis._grpr)}get prompt(){return this.promptConfig.prompt}get promptData(){return this.promptConfig}fetchSiteConfig(e){return new Promise(((t,r)=>{const i=document.createElement("script");i.type="text/javascript",i.src=e,document.body.appendChild(i),i.onload=()=>{t()},i.onerror=r}))}setActivePrompt(e){try{this.promptConfig.prompt.setActivePrompt(e)}catch(t){On.error(t)}}};pr=new WeakSet,hr=()=>({lang:cs.getBrowserLanguage()});const Dl=new class{constructor(){En(this,pr)}sendConsentData(e,t,r){navigator.sendBeacon(new URL("wpn/consent-data",da.getUserAnalyticsDomain()),new Blob([JSON.stringify({uuid:t,aid:r,publicVpk:e})],{type:"application/json"}))}async renewSubscription(e,t,r){const{pushWpid:i,pushDomain:n}=da,o=await il.getAuthToken();return fetch(`${n}webpush/renew`,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json","X-WpId":i,Authorization:`Bearer ${o}`},body:JSON.stringify({oldSubscription:null==e?void 0:e.toJSON(),newSubscription:null==t?void 0:t.toJSON(),visitor:{...kn(this,pr,hr).call(this),pid:r}})})}sendPushSubscriptionData({pushWpId:e,pushSubscription:t,subscriptionEndpoint:r,authToken:i,promptId:n}){return fetch(r,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json","X-WpId":e,Authorization:`Bearer ${i}`},body:JSON.stringify({sub:t,prv:kl.promptData.getVersion(),visitor:{...kn(this,pr,hr).call(this),pid:n}})}).then((e=>{if(!e.ok)throw new Error(`Subscription failed ${e.status}`);return true}))}},Tl=new class{async registerServiceWorker(){const e=da.getCustomSwPath();if(e)return navigator.serviceWorker.register(`${e}`);try{return await navigator.serviceWorker.register("/gr_sw_main.js")}catch(t){return navigator.serviceWorker.register("./gr_sw_main.js")}}getExistingServiceWorkerRegistration(){const e=da.getCustomSwPath()||"gr_sw_main.js";return navigator.serviceWorker.getRegistrations().then((t=>t.find((t=>t.active.scriptURL.includes(e)))))}},Al=new class{sendStatsData(e){return fetch(`${kl.prompt.statisticsEndpoint}${e}`,{mode:"cors"})}},Nl=new class{setCookie({expiresIn:e,domain:t="",value:r,name:i}){const n=this.getExpirationTimeString(e);document.cookie=`${i}=${r}; expires=${n}; path=/; ${t?`domain=${t}`:""}`}getExpirationTimeString(e){if(e instanceof Date)return e.toUTCString();const t=new Date;return t.setTime(t.getTime()+e),t.toUTCString()}getCookie(e){const t=document.cookie.match(new RegExp(`(^| )${e}=([^;]+)`));if(t)return t[2]}removeUuidCookieSessionInfo(){window.sessionStorage.removeItem(Hs.UuidHasBeenSet)}};class Ul extends Oa{constructor(e){if(super("User denied push notification consent"),e)this.cause=e}}const Wl=1e3*60*60*24*7,Fl=new class{async isSubscribed(){return null!==await this.checkIfUserIsSubscribed()}async isSubscribedFromPrompt(e){if(Boolean(await this.checkIfUserIsSubscribed()))return e===Nl.getCookie(aa.NotificationConsentAcceptedFromPrompt);else return false}isPermissionPermanentlyDenied(){return"denied"===Notification.permission}isPermissionGranted(){return"granted"===Notification.permission}isPermissionDeniedForCustomPrompt(e){const t=!!Nl.getCookie(aa.NotificationConsentCustomPromptRejected.replace("promptId",e)),r=!!Nl.getCookie(aa.NotificationConsentCustomPromptRejectedDEPRECATED.replace("promptId",e));return"default"===Notification.permission&&(t||r)}async registerUserForNotifications(){const{pushWpid:e,pushDomain:t}=da,r=Rn(aa.visitorUuid),i=await Tl.registerServiceWorker();let n=await i.pushManager.getSubscription();if(!(null!==n))try{const i=await il.getAuthToken(),o=al(i),s=o.subEndp;n=await this.getUserNotificationsSubscription();const{promptId:a}=kl.promptData.prompt;return ml({id:r,pushSubscription:n,domain:t,wpid:e,promptId:a}),Al.sendStatsData(pl.ACCEPTED_NATIVE),await Dl.sendPushSubscriptionData({promptId:a,pushWpId:e,pushSubscription:n,subscriptionEndpoint:s,authToken:i}),Dl.sendConsentData(o.vpk,r,da.getUserAid()),Nl.setCookie({value:a,name:aa.NotificationConsentAcceptedFromPrompt,expiresIn:ca.OneYear,domain:Ln()}),Nl.removeUuidCookieSessionInfo(),this.markVisitorAsResubscribed(),n}catch(o){if(0===o.code)throw Al.sendStatsData(pl.DENIED_NATIVE),da.eventBus.publish(ha.WebPushNativeConsentRejected),new Ul(o);throw o}}async resubscribeVisitor(){if(this.shouldResubscribeVisitor()){const e=await Tl.getExistingServiceWorkerRegistration(),t=await(null==e?void 0:e.pushManager.getSubscription());if(t)if(!(await t.unsubscribe()))return;await(async()=>{var e,t;if("serviceWorker"in navigator){const r=await navigator.serviceWorker.getRegistrations(),i=[];for(const n of r)if(!((null==(e=n.active)?void 0:e.scriptURL.endsWith("gr_sw_main.js"))||(null==(t=n.active)?void 0:t.scriptURL.endsWith("service-worker/service-worker.js"))))i.push(n.unregister());return Promise.all(i)}})();const r=await this.getUserNotificationsSubscription(),i=Nl.getCookie(aa.NotificationConsentAcceptedFromPrompt);if(t||r)await Dl.renewSubscription(t,r,i).then((e=>{if(!e.ok)throw new Error(`Subscription failed ${e.status}`);return true})),Nl.removeUuidCookieSessionInfo();if(r)this.markVisitorAsResubscribed(),ml({id:Rn(aa.visitorUuid),pushSubscription:r,promptId:i});return r}}async getUserNotificationsSubscription(){const e=await Tl.registerServiceWorker(),t=await e.pushManager.getSubscription();if(!(null!==t))try{const t=al(await il.getAuthToken());if("default"===Notification.permission)Al.sendStatsData(pl.DISPLAYED_NATIVE);return e.pushManager.subscribe({userVisibleOnly:true,applicationServerKey:t.vpk})}catch(r){On.error(r)}return t}markVisitorAsResubscribed(){Nl.setCookie({name:aa.VisitorResubscribed,value:"true",expiresIn:Wl})}shouldResubscribeVisitor(){return!Nl.getCookie(aa.VisitorResubscribed)||!!window.sessionStorage.getItem(Hs.UuidHasBeenSet)}async checkIfUserIsSubscribed(){return(await Tl.registerServiceWorker()).pushManager.getSubscription()}},_l={".gr-visual-prompt":{all:"initial !important",position:"fixed !important",left:"50% !important",top:"0 !important","z-index":"999999999 !important",transform:"translateX(-50%) !important"}},Vl={".gr-visual-prompt":{all:"initial !important",position:"fixed !important",left:"50% !important",bottom:"0 !important","z-index":"999999999 !important",transform:"translateX(-50%) !important"}};function xl(e,t){return(e.shadowRoot||e).querySelector(t)}mr=new WeakMap,wr=new WeakMap,fr=new WeakMap,gr=new WeakSet,vr=function(e){Nl.setCookie({value:e,name:aa.NotificationConsentCustomPromptRejected.replace("promptId",e),expiresIn:In(this,fr)??ca.TwoWeeks,domain:Ln()})};const Ol=new class{constructor(){En(this,gr),En(this,mr,void 0),En(this,wr,void 0),En(this,fr,void 0),Cn(this,mr,new AbortController),Cn(this,wr,new AbortController),Cn(this,fr,null),this.onImageError=e=>{const t=e.target;t.parentNode.removeChild(t)},this.closeNotificationPrompt=e=>{const t=document.documentElement.querySelector('[data-gr-prompt="content"]'),r=xl(t,"img");if(null==r?void 0:r.removeEventListener("error",this.onImageError),!e)Al.sendStatsData(pl.DENIED_CUSTOMIZED);document.body.removeChild(t)}}get hasCustomPrompt(){const{prompt:e}=kl;return e&&((null==e?void 0:e.hasMobile)||(null==e?void 0:e.hasDesktop))}async displayCustomPrompt(e){if(e)Cn(this,fr,e);if(this.hasCustomPrompt){const{prompt:e}=kl;if(Fl.isPermissionDeniedForCustomPrompt(null==e?void 0:e.promptId))throw new Ul;if(e.showAgainAfter)Cn(this,fr,e.showAgainAfter);const r=function(e,t){const r=document.querySelector('[data-gr-prompt="content"]'),i=r?r:document.createElement("div"),n=/iPhone|iPad|iPod|Android|webOS|BlackBerry|Windows Phone/i.test(navigator.userAgent)||screen.availWidth<dl;let o;if(i.attachShadow)o=i.attachShadow({mode:"open"});if(i.dataset.grPrompt="content",i.classList.add("gr-visual-prompt"),o)o.innerHTML=n?t:e;else i.innerHTML=n?t:e;return(e=>{const t=document.createElement("style"),r=(i="mobile"===e?Vl:_l,Object.keys(i).reduce(((e,t)=>{const r=i[t];if("object"==typeof r){const i=Object.keys(r).reduce(((e,t)=>e+=`${t}: ${r[t]};`),"");e.push(`${t} {${i}}`)}return e}),[]));var i;let n;document.head.appendChild(t),n=t.sheet,r.forEach((e=>{n.insertRule(e,n.rules.length)}))})(n?"mobile":"desktop"),i}(e.desktopPromptData,e.mobilePromptData),i=xl(r,'[data-gr-prompt-button="allow"]'),n=xl(r,'[data-gr-prompt-button="cancel"]');xl(r,"img").addEventListener("error",this.onImageError),i.style.cursor="pointer",n.style.cursor="pointer",t=r,void new MutationObserver(((e,r)=>{e.forEach((e=>{if(Array.from(e.addedNodes).includes(t))void Al.sendStatsData(pl.DISPLAYED_CUSTOMIZED),r.disconnect()}))})).observe(document.body,{childList:true}),document.body.appendChild(r);const o=await Promise.race([this.getUserSubscriptionFromCustomPromptConfirm(r),this.waitForUserDenyConsent(r)]);if(this.isPushSubscription(o))return o;throw new Ul}var t}getUserSubscriptionFromCustomPromptConfirm(e){return new Promise(((t,r)=>{const i=xl(e,'[data-gr-prompt-button="allow"]');if(i)i.addEventListener("click",(()=>{Al.sendStatsData(pl.ACCEPTED_CUSTOMIZED),Fl.registerUserForNotifications().then((e=>{const{promptId:r,hasDesktop:i,hasMobile:n}=kl.promptData.prompt;da.eventBus.publish(ha.WebPushConsentAccepted,n||i?r:""),In(this,wr).abort(),t(e)})).catch((e=>{r(e)})),this.closeNotificationPrompt(true)}),{once:true,signal:In(this,mr).signal})}))}waitForUserDenyConsent(e){return new Promise((t=>{const r=xl(e,'[data-gr-prompt-button="cancel"]');if(r)r.addEventListener("click",(()=>{const{promptId:e}=kl.promptData.prompt;this.closeNotificationPrompt(),In(this,mr).abort(),kn(this,gr,vr).call(this,e),da.eventBus.publish(ha.WebPushCustomConsentRejected,e),t()}),{once:true,signal:In(this,wr).signal})}))}isPushSubscription(e){return e instanceof PushSubscription||!!e&&"object"==typeof e&&"endpoint"in e&&"expirationTime"in e}},Rl=new class{async collectPushNotificationSubscription(e,t){if(await kl.initialize(),await Fl.isSubscribed()||Fl.isPermissionGranted())return Fl.isSubscribedFromPrompt(e);if(Fl.isPermissionPermanentlyDenied()||Fl.isPermissionDeniedForCustomPrompt(e))return false;if(kl.setActivePrompt(e),!Ol.hasCustomPrompt)throw new Error("No prompt data");try{return await Ol.displayCustomPrompt(t),Fl.isSubscribedFromPrompt(e)}catch(r){if(r instanceof Ul)return false;throw On.error("Error while trying to send web push",r),r}}};class Ll{constructor(e){this.promptId=e}static create(e){return new Ll(e)}}class jl{constructor(e){this.promptId=e}static create(e){return new jl(e)}}yr=new WeakSet,br=()=>new Promise((e=>{da.eventBus.subscribe(ha.WebPushConsentAccepted,(t=>{e(jl.create(t))}))})),Sr=new WeakSet,Pr=()=>new Promise((e=>{da.eventBus.subscribe(ha.WebPushNativeConsentRejected,(()=>{e(Ll.create())}))})),Ir=new WeakSet,Er=()=>new Promise((e=>{da.eventBus.subscribe(ha.WebPushCustomConsentRejected,(t=>{e(Ll.create(t))}))}));const Ml=Object.freeze({[Nn]:true,[Un]:true}),Bl=Object.freeze({[Nn]:true}),Jl=Object.freeze({[Wn]:true}),$l=Object.freeze({}),Gl={[Tn.AwaitClick]:class extends Da{constructor(){super(...arguments),this.type=Tn.AwaitClick,this.outs=zl.getNodeOutsInstance(Tn.AwaitClick)}async handler(){const{selector:e}=this.properties;try{return await this.waitForElementClick(e),Nn}catch(t){if(t instanceof An)return Un;throw On.forceLogError(t),t}}waitForElementClick(e){return new Promise(((t,r)=>{const i=Array.from(document.querySelectorAll(e)),n=new AbortController,o=()=>{t(),this.cleanLeaveFalseTimeout(),n.abort()};if(i.length>0){for(const e of i)e.addEventListener("click",o,{signal:n.signal});this.waitForDelayLeaveFalse().then((()=>{n.abort(),r(new An)}))}else r(new Fn(e))}))}},[Tn.AwaitScroll]:class extends Da{constructor(){super(...arguments),this.type=Tn.AwaitScroll,this.outs=zl.getNodeOutsInstance(Tn.AwaitScroll)}async handler(){const{selector:e,percent:t}=this.properties;try{if(e)await this.watchForElementIntersectWithViewport(e);else if(t)await this.watchForPagePercentValueIntersectsWithViewport(t);return Nn}catch(r){if(r instanceof An)return Un;throw On.forceLogError(r),r}finally{this.cleanLeaveFalseTimeout()}}watchForElementIntersectWithViewport(e){return new Promise(((t,r)=>{const i=document.querySelector(e);if(i){const e=new IntersectionObserver(((e,r)=>{for(const n of e)if(n.isIntersecting&&n.target===i)t(),r.disconnect()}));e.observe(i),this.waitForDelayLeaveFalse().then((()=>{e.disconnect(),r(new An)}))}else r(new Fn(e))}))}async watchForPagePercentValueIntersectsWithViewport(e){return new Promise(((t,r)=>{const i=document.documentElement.scrollHeight*(e/Ta);function n(){if(document.documentElement.clientHeight+document.documentElement.scrollTop>i)t(),document.removeEventListener("scroll",n)}if(document.documentElement.clientHeight+document.documentElement.scrollTop>i)t();else document.addEventListener("scroll",n,true);this.waitForDelayLeaveFalse().then((()=>{document.removeEventListener("scroll",n),r(new An)}))}))}},[Tn.AwaitExit]:class extends Da{constructor(){super(...arguments),this.outs=zl.getNodeOutsInstance(Tn.AwaitExit),this.type=Tn.AwaitExit}handler(){const{useMobileHistoryBasedExitIntend:e,useMobileScrollBasedExitIntend:t}=this.properties,r=new ls({useMobileHistoryBasedExitIntend:e,useMobileScrollBasedExitIntend:t});return new Promise((e=>{r.handle().then((()=>{this.cleanLeaveFalseTimeout(),e(Nn)})).catch((e=>{On.error("Error while exit intend handler",e)})),this.waitForDelayLeaveFalse().then((()=>{e(Un),r.abort()}))}))}},[Tn.AwaitInactivity]:class extends Da{constructor(){super(...arguments),this.abortController=new AbortController,this.handlersMap={click:null,scroll:null,keydown:null,mousemove:null},this.type=Tn.AwaitInactivity,this.outs=zl.getNodeOutsInstance(Tn.AwaitInactivity)}handler(){const{inactivityTime:e}=this.properties;return new Promise((t=>{this.waitForDelayLeaveFalse().then((()=>{t(Un)})),this.waitForUserActivity(e).then((()=>{t(Nn),this.cleanLeaveFalseTimeout()}))}))}async waitForUserActivity(e){const t=window.setTimeout((()=>{this.abortController.abort()}),e);try{return await Promise.race([this.waitForUserAction("scroll"),this.waitForUserAction("click"),this.waitForUserAction("keydown"),this.waitForUserAction("mousemove")]),window.clearTimeout(t),this.detachActivityMonitorHandlers(),this.waitForUserActivity(e)}catch(r){if(r instanceof Ra)return;window.clearTimeout(t),On.error(r)}}detachActivityMonitorHandlers(){const{click:e,keydown:t,scroll:r,mousemove:i}=this.handlersMap;document.removeEventListener("click",e),document.removeEventListener("scroll",r),document.removeEventListener("keydown",t),document.removeEventListener("mousemove",i),this.handlersMap={click:null,keydown:null,scroll:null,mousemove:null}}waitForUserAction(e){return new Promise(((t,r)=>{document.addEventListener(e,t,{once:true,capture:"scroll"===e}),this.handlersMap[e]=t,this.abortController.signal.addEventListener("abort",(()=>{r(new Ra)}),{once:true})}))}},[Tn.AwaitECommerceActivity]:class extends Da{constructor(e){super(e),En(this,dt),En(this,ht),En(this,wt),En(this,gt),En(this,yt),En(this,ut,void 0),En(this,lt,void 0),Cn(this,ut,(e=>{var t,r;const i=null==(t=Object.entries(da.automationJourneyGraphs).find((([,t])=>{const{transformedGraph:r}=t;return r.nodes.find((t=>t.id===e))})))?void 0:t[0],n=null==(r=Object.entries(da.popupGraphs).find((([,t])=>{const{transformedGraph:r}=t;return r.nodes.find((t=>t.id===e))})))?void 0:r[0];return i||n||null})(this.id)),Cn(this,lt,[]),this.outs=zl.getNodeOutsInstance(Tn.AwaitECommerceActivity),this.type=Tn.AwaitECommerceActivity,this.properties.conditions=this.properties.conditions.map((e=>({...e,conditionId:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))})))}async handler(){return new Promise((async e=>{const{conditions:t}=this.properties;if(0===t.length||await kn(this,wt,ft).call(this))e(Nn);else da.eventBus.subscribe(ha.UserEventSaved,(async t=>{if(ku(t)&&!kn(this,yt,bt).call(this,t.eventId))if(await kn(this,dt,pt).call(this,t))kn(this,gt,vt).call(this,t.eventId),e(Nn)}),{ignoreQueuedEvents:true}),da.eventBus.subscribe(ha.UserEventUpdated,(async t=>{const r=await Lc.getEventById(t);if(r&&ku(r)&&!kn(this,yt,bt).call(this,r.eventId))if(await kn(this,dt,pt).call(this,r))kn(this,gt,vt).call(this,r.eventId),e(Nn)}),{ignoreQueuedEvents:true})}))}},[Tn.AwaitMergedNodes]:class extends Da{constructor(e){super(e),En(this,St,void 0),En(this,Pt,void 0),Cn(this,St,null),this.type=Tn.AwaitMergedNodes,this.outs=zl.getNodeOutsInstance(Tn.AwaitMergedNodes),Cn(this,Pt,[]);const{nodesDefinition:t}=e.properties;Cn(this,Pt,t.map((e=>zl.getNodeInstance(e.type,{id:$u.generateRandomUuid(),properties:e.properties,context:this.context}))))}async handler(e){const{separator:t="or"}=this.properties;if("or"===t){Cn(this,St,Date.now());const t=await Promise.race(In(this,Pt).map((t=>t.handler(e))));if(t!==Un)return t;if(In(this,St)&&Date.now()-In(this,St)<Gu)await _a(Gu);return this.handler()}else if("and"===t)if((await Promise.all(In(this,Pt).map((t=>t.handler(e))))).includes(Un))return Un;else return Nn;else qn(t)}},[Tn.AwaitWebPushConsent]:class extends Da{constructor(){super(...arguments),En(this,yr),En(this,Sr),En(this,Ir),this.type=Tn.AwaitWebPushConsent,this.outs=zl.getNodeOutsInstance(Tn.AwaitWebPushConsent)}async handler(){const{pid:e}=this.properties;if("Notification"in window){if("denied"===window.Notification.permission)return Un;else if("granted"===window.Notification.permission)if(Nl.getCookie(aa.NotificationConsentAcceptedFromPrompt)===e||"any"===e)return Nn;else return Un;else if("default"===window.Notification.permission){const t=await Promise.race([kn(this,yr,br).call(this),kn(this,Ir,Er).call(this),kn(this,Sr,Pr).call(this)]);if(t instanceof jl)if(t.promptId===e||"any"===e)return Nn;else return this.handler();else if(t instanceof Ll)if(t.promptId===e)return Un;else return this.handler()}}else return Un}},[Tn.FilterSubscriber]:class extends ka{constructor(){super(...arguments),this.type=Tn.FilterSubscriber,this.outs=zl.getNodeOutsInstance(Tn.FilterSubscriber)}async handler(){return await(async()=>{let e="1"===Rn("gaIsValuable");if(da.canUseBackendForSubscriberIdentification())try{e=(await Ua.getVisitorData()).isConfirmedIdentifiedVisitor}catch(t){On.error("Failed to load subscriber data",t)}return e})()?Nn:Un}},[Tn.FilterDevice]:class extends ka{constructor(){super(...arguments),this.type=Tn.FilterDevice,this.outs=zl.getNodeOutsInstance(Tn.FilterDevice)}handler(){const{deviceType:e}=this.properties,t=ta(cs,Ma).getDeviceType();if(e.includes(t))return Promise.resolve(Nn);else return Promise.resolve(Un)}},[Tn.FilterLocation]:class extends ka{constructor(){super(...arguments),this.type=Tn.FilterLocation,this.outs=zl.getNodeOutsInstance(Tn.FilterLocation)}handler(){return new Promise((async e=>{let{locations:t}=this.properties;if(null==t?void 0:t.length){if(t=(Array.isArray(t)?t:[t]).map((e=>e.toLowerCase())),t.includes(Po.All))return e(Nn),void 0;try{const r=(await ta($a,za).getVisitorCountryCode()).toLowerCase();if(t.includes(r))e(Nn);else e(Un)}catch(r){if(r.status===Ha)e(Un);On.error(r)}}else e(Nn)}))}},[Tn.FilterUrl]:class extends ka{constructor(){super(...arguments),this.type=Tn.FilterUrl,this.outs=zl.getNodeOutsInstance(Tn.FilterUrl)}handler(){if("urls"in(e=this.properties)&&Array.isArray(e.urls)&&e.urls.every((e=>"string"==typeof e))){const{urls:e}=this.properties;if(gu(document.location.href,e))return Promise.resolve(Nn);else return Promise.resolve(Un)}else if(yu.create({...this.properties,currentUrl:window.location.href}).isOnCurrentUrl())return Promise.resolve(Nn);else return Promise.resolve(Un);var e}},[Tn.FilterTime]:class extends ka{constructor(){super(...arguments),this.type=Tn.FilterTime,this.outs=zl.getNodeOutsInstance(Tn.FilterVisit)}handler(){const{beforeTime:e,afterTime:t}=this.properties,r=Date.now();let i=true,n=true;if(null===e&&null===t)return Promise.resolve(Nn);if(this.validateProperties(),e)i=e>r;if(t)n=r>t;if(i&&n)return Promise.resolve(Nn);else return Promise.resolve(Un)}validateProperties(){const{afterTime:e,beforeTime:t}=this.properties,r="number"==typeof e,i="number"==typeof t;if(e&&!r||t&&!i||(r&&i?e>=t:false))throw new Ka}},[Tn.FilterECommerceActivity]:class extends ka{constructor(){super(...arguments),this.type=Tn.FilterECommerceActivity,this.outs=zl.getNodeOutsInstance(Tn.FilterECommerceActivity)}async handler(){var e,t,r;const i=0===Object.keys(this.properties).length;let n=i,o=i,s=i,a=i;if(this.properties.productOrCategoryView)n=await async function(e){const{modifiers:t}=e;return Ru.checkECommerceEventModificators({eventTypes:[Kn.ViewItem,Kn.ViewCategory],modificators:(null==t?void 0:t.rules.length)?t:{separator:_u.Or,rules:[{type:Fu.EventsAmount,comparisonOperator:xu.GreaterThanOrEqual,amount:1}]},pastEventsCheckFn:t=>(async(e,t)=>{const{product:r,category:i}=t;let n=false;if(Tu(e)){const{data:{product:{id:i},categories:o}}=e;if("any"===r)n=true;else if("any"===t.productCategories&&r)n=true;else if(Array.isArray(t.productCategories)&&Array.isArray(o)&&o.some((e=>t.productCategories.includes(e.id))))n=true;else n=null==r?void 0:r.includes(i)}else if(Du(e)){const{data:{id:t}}=e;if("any"===i)n=true;else n=null==i?void 0:i.includes(t)}if(n)da.eventBus.publish(ha.UserECommerceEventMatchedByECommerceElement,e);return n})(t,e)})}(this.properties.productOrCategoryView);if((null==(e=this.properties.likeItem)?void 0:e.product.length)>0)o=await async function(e){const t=(await Lc.getPopupECommerceEvents((t=>((e,t)=>{if(Au(e)||Wu(e,Kn.UnlikeItem)){const{product:r,date:i}=t,{product:{id:n}}=e.data;if(r===To.AnyProductLiked)return true;else if(!r.includes(n))return false;return Eu(e,i,{ignoreToDateInDateRange:true})}})(t,e)))).reduce(((e,t)=>(e[t.data.product.id].push(t),e)),jn([]));let r=Object.values(t).filter(bu);if(e.date)r=r.map((t=>t.filter((t=>Eu(t,e.date)))));return r.some((e=>e.some((e=>{const t=e.eventType===Kn.LikeItem;if(t)da.eventBus.publish(ha.UserECommerceEventMatchedByECommerceElement,e);return t}))))}(this.properties.likeItem);if(Object.keys((null==(t=this.properties.orderPlaced)?void 0:t.condition)||{}).length>0)s=await async function(e){return(await Lc.getPopupECommerceEvents((t=>((e,t)=>{if(Nu(e))return Iu(t,e)})(t,e)))).length>0}(this.properties.orderPlaced);if(Object.keys((null==(r=this.properties.cartUpdated)?void 0:r.condition)||{}).length>0)a=await async function(e){const[t,r]=await Promise.all([Lc.getPopupECommerceEvents((t=>((e,t)=>{if(Uu(e))return Iu(t,e)})(t,e))),Lc.getPopupECommerceEvents((()=>true))]);return t.filter((e=>!r.find((t=>t.data.cartId===e.data.cartId&&t.time>e.time)))).length>0}(this.properties.cartUpdated);return n||o||s||a?Nn:Un}},[Tn.FilterUniqueSessionVisit]:class extends ka{constructor(){super(...arguments),this.outs=zl.getNodeOutsInstance(Tn.FilterUniqueSessionVisit),this.type=Tn.FilterUniqueSessionVisit}handler(){return Promise.resolve(Ea.hasElementBeenVisited(this.id)?Un:Nn)}},[Tn.FilterVisit]:class extends ka{constructor(){super(...arguments),this.type=Tn.FilterVisit,this.outs=zl.getNodeOutsInstance(Tn.FilterVisit)}async handler(){const{frequency:e,frequencyDaysNumber:t,urlPath:r,visitors:i}=this.properties;return await xc.validateVisitorVisits({frequency:e,visitorType:i,frequencyDaysNumber:t,urlPath:r})?Nn:Un}},[Tn.FilterPopup]:class extends ka{constructor(){super(...arguments),this.type=Tn.FilterPopup,this.outs=zl.getNodeOutsInstance(Tn.FilterPopup)}async handler(){const{popupId:e,showIfNotCloseBefore:t,showIfNotSubmittedBefore:r,showIfSeenLessThanAmount:i}=this.properties;if(!(await this.shouldPassFrequencyConditionCheck()))return Un;if(t&&await au().hasPopupBeenClosedBefore(e))return Un;if(r&&await au().hasPopupBeenSubmittedBefore(e))return Un;if(i&&await au().getPopupImpressionsAmount(e)>=i)return Un;else return Nn}async shouldPassFrequencyConditionCheck(){const{showEveryDays:e,frequency:t,popupId:r}=this.properties;if("session"===t)return!(await au().hasPopupBeenSeenInSession(r));if("everyDays"===t&&e){const t=await au().getLastPopupImpression(r);if(t)return Va(t.getTime(),e);else return true}return true}},[Tn.ReactScroll]:class extends ka{constructor(){super(...arguments),this.type=Tn.ReactScroll,this.outs=zl.getNodeOutsInstance(Tn.ReactScroll)}handler(){if(this.shouldProcessHandler()){const{selector:e}=this.properties,t=document.querySelector(e);if(t)return t.scrollIntoView({behavior:"smooth"}),Promise.resolve(Nn)}}},[Tn.ReactRedirect]:class extends ka{constructor(){super(...arguments),this.type=Tn.ReactRedirect,this.outs=zl.getNodeOutsInstance(Tn.ReactRedirect)}handler(){if(this.shouldProcessHandler()){const{url:e}=this.properties;return window.location.assign(e),Promise.resolve(void 0)}}},[Tn.ReactDelay]:class extends ka{constructor(){super(...arguments),this.type=Tn.ReactDelay,this.outs=zl.getNodeOutsInstance(Tn.ReactDelay)}async handler(){const{delay:e}=this.properties;return await _a(e),Nn}},[Tn.ReactPopup]:class extends ka{constructor(){super(...arguments),En(this,tt,void 0),Cn(this,tt,false),this.type=Tn.ReactPopup,this.outs=zl.getNodeOutsInstance(Tn.ReactPopup)}async handler(){var e;const{env:t,id:r,mode:i}=this.properties;if(i===to.Inline)return await(null==(e=window.PopupsRenderer)?void 0:e.renderCustomElement(r)),Nn;if(await du.attachPopupLibrary(),window.PopupsRenderer)if(this.shouldProcessHandler()){if(!In(this,tt))this.attachPopupEvents();try{if(await window.PopupsRenderer.renderPopupFromId(r,{env:window.PopupsRenderer.GeoEnvironment[t]}),!this.context.isJourneyGraph)await this.waitForPopupClose();return Nn}catch(n){return On.error(n),Nn}}}attachPopupEvents(){window.PopupsRenderer.registerEventSubscriber((e=>{if(e instanceof window.PopupsRenderer.PopupEvents.Close)this.closePopupHandler(e);if(e instanceof window.PopupsRenderer.PopupEvents.BodyView)this.showPopupHandler();if(e instanceof window.PopupsRenderer.PopupEvents.FormLead)this.submitPopupHandler()})),Cn(this,tt,true)}waitForPopupClose(){const e=new AbortController;return new Promise((t=>{lu.on(uu.PopupClose,(r=>{if(r===this.properties.id)t(),e.abort()}),{signal:e.signal})}))}closePopupHandler(e){if(e.entityId===this.properties.id)au().registerPopupClose(this.properties.id),lu.notifyPopupClose(this.properties.id)}showPopupHandler(){au().registerPopupView(this.properties.id),lu.notifyPopupShow(this.properties.id)}submitPopupHandler(){au().registerPopupSubmit(this.properties.id)}},[Tn.ReactSendToBackend]:class extends ka{constructor(){super(...arguments),this.type=Tn.ReactSendToBackend,this.outs=zl.getNodeOutsInstance(Tn.ReactSendToBackend)}async handler(){if(this.shouldProcessHandler())return Promise.resolve(Wn)}},[Tn.ReactSendWebPush]:class extends ka{constructor(){super(...arguments),this.type=Tn.ReactSendWebPush,this.outs=zl.getNodeOutsInstance(Tn.ReactSendWebPush)}async handler(e){const{messageId:t}=this.properties,{journeyVo:r,type:i}=this.context.calculateJourneyStateForNextNode(e,this,Nn);if(Fl.isPermissionPermanentlyDenied())return Un;try{return tl.saveCallbackForServiceWorker({senderId:`${this.id}-${e.journey.uuid}`,apiCallbackData:this.context.calculateTransitionsForNextNodeFromNode(e,this,Nn),dbCallbackData:{operationType:i,data:r},messageId:t}).catch((e=>{On.error("Error while saving callback data for sw",e)})),await tl.waitForWebPushReceptionConfirmation(t),Nn}catch(n){if(n instanceof rl)return Un;throw n}}},[Tn.ReactCollectWebPushConsent]:class extends ka{constructor(){super(...arguments),this.type=Tn.ReactCollectWebPushConsent,this.outs=zl.getNodeOutsInstance(Tn.ReactCollectWebPushConsent)}async handler(){const{customPromptRejectionDuration:e=ca.OneYear,pid:t}=this.properties;return await Rl.collectPushNotificationSubscription(t,e)?Nn:Un}}},ql={[Tn.AwaitClick]:Ml,[Tn.AwaitScroll]:Ml,[Tn.AwaitExit]:Ml,[Tn.AwaitInactivity]:Ml,[Tn.AwaitECommerceActivity]:Ml,[Tn.AwaitMergedNodes]:Ml,[Tn.AwaitWebPushConsent]:Ml,[Tn.FilterUrl]:Ml,[Tn.FilterSubscriber]:Ml,[Tn.FilterDevice]:Ml,[Tn.FilterLocation]:Ml,[Tn.FilterECommerceActivity]:Ml,[Tn.FilterUniqueSessionVisit]:Ml,[Tn.FilterTime]:Ml,[Tn.FilterVisit]:Ml,[Tn.FilterPopup]:Ml,[Tn.ReactDelay]:Bl,[Tn.ReactScroll]:Bl,[Tn.ReactRedirect]:$l,[Tn.ReactPopup]:Bl,[Tn.ReactSendToBackend]:Jl,[Tn.ReactSendWebPush]:Ml,[Tn.ReactCollectWebPushConsent]:Ml};class zl{static getNodeInstance(e,t){return new Gl[e](t)}static getNodeOutsInstance(e){return ql[e]}}function Hl(e){return"object"==typeof e&&null!==e&&"id"in e&&"status"in e&&"starting"in e}function Kl(e){var t;switch(e){case co.TransferToBackend:return"backend_transfer";case co.ReactSendWebPush:return"react_web_push";default:return null==(t=/(?<type>filter|react|await)_.*/g.exec(e))?void 0:t.groups.type}}function Xl(e){switch(e.type){case co.TransferToBackend:return e.data;case co.ReactSendWebPush:return{message_encoded_id:e.data.nid};default:return{upstream:null}}}class Yl{constructor({journey:e,transitions:t,workflowEncodedId:r,graphEncodedId:i,pass_through_params:n}){this.journey=e,this.transitions=t,this.pass_through_params=n,this.graph={encodedId:i},this.workflow={encodedId:r}}static create(e){return new Yl(e)}addGlobalExitToLastTransition(){if(this.transitions.length){const e=this.transitions.at(-1);delete e.entered,e.leave.stats[e.leave.path]=[...new Set([...e.leave.stats[e.leave.path],"globalExit"])]}}toJSON(){const{pass_through_params:e,...t}=this;return{...t,...e.shopId&&(e.category_id.length||e.product_id.length)?{pass_through_params:e}:{}}}}Cr=new WeakMap,kr=new WeakMap,Dr=new WeakMap,Tr=new WeakMap,Ar=new WeakMap,Nr=new WeakSet,Ur=function(e){const t=e.filter((e=>{var t;return e.from.externalId!==(null==(t=e.to)?void 0:t.externalId)})).map(In(this,Wr)).filter(Boolean),{wId:r,id:i}=In(this,Cr);return Yl.create({workflowEncodedId:r,graphEncodedId:i,journey:In(this,kr).journey,pass_through_params:In(this,kr).pass_through_params.toSerializedForApiJson(),transitions:t})},Wr=new WeakMap,Fr=new WeakSet,_r=function(e){var t,r,i,n,o,s,a;const c=In(this,Wr).call(this,e),u=(null==(t=e.to)?void 0:t.nodeTypeGroup)===Dn.Await,l=null==(i=null==(r=c.entered)?void 0:r.element)?void 0:i.starting,d=null==(o=null==(n=c.leave)?void 0:n.element)?void 0:o.starting,p=(null==(s=e.to)?void 0:s.nodeTypeGroup)===Dn.BackendTransfer,h=(null==(a=e.to)?void 0:a.type)===Tn.ReactSendWebPush;if(p||h)return true;if(u&&!l)return true;if(!c.entered&&!d)return true;else return false};let Zl=class e{constructor(e,t){En(this,Nr),En(this,Fr),En(this,Cr,void 0),En(this,kr,void 0),En(this,Dr,[]),En(this,Tr,false),En(this,Ar,(e=>{const t=kn(this,Nr,Ur).call(this,e);if(In(this,Tr))t.addGlobalExitToLastTransition();return Qu.sendVisitorTransitions(t.toJSON())})),En(this,Wr,(e=>{var t,r,i;const{fromPathKey:n,from:o,to:s,transitionTime:a,reason:c}=e,u={reason:c},l=In(this,Cr).originalGraph.nodes.find((e=>e.id===o.externalId)),d=s?In(this,Cr).originalGraph.nodes.find((e=>e.id===s.externalId)):null,p=In(this,Cr).originalGraph.transitions.find((e=>e.from===l.id&&e.to===(null==d?void 0:d.id)));let h;if(In(this,Cr).outsMap[o.externalId])h=In(this,Cr).outsMap[o.externalId][n];const m=(null==p?void 0:p.key)??h??n;if(u.leave={node:{id:l.id},path:m,occurred_at:a,element:l.element,stats:{...(null==(r=null==(t=l.stats)?void 0:t.transitions)?void 0:r[m])?{[m]:l.stats.transitions[m]}:{}}},d)if(u.entered={node:{id:d.id,type:Kl(d.type),data:Xl(d)},occurred_at:a,element:d.element},d.type!==co.TransferToBackend)u.entered.stats=(null==(i=d.stats)?void 0:i.enters)?{input:d.stats.enters.input}:{};return u})),Cn(this,Cr,e),Cn(this,kr,t)}get journey(){return In(this,kr)}static create(t,r){return new e(t,r)}async addTransition(e){In(this,Dr).push(e)}async flushTransitionsIfNeeded(e){if(kn(this,Fr,_r).call(this,e)){const e=[...In(this,Dr)];Cn(this,Dr,[]),await xa((()=>In(this,Ar).call(this,e)),{multiplyDelay:true,maxAttempts:10})}}getCurrentVisitorTransitionsVoCopyWithTransitions(e){const t=[...In(this,Dr),...e||[]];return kn(this,Nr,Ur).call(this,t)}addGlobalExitToLastTransitionBeforeSend(){Cn(this,Tr,true)}};const Ql=1e3;Vr=new WeakMap,xr=new WeakSet,Or=function(e){In(this,Vr).set(e,Date.now())};const ed=new class{constructor(){En(this,xr),En(this,Vr,new Map)}isNodeUsedInLoop(e,t){const r=`${e.id}-${t}`,i=In(this,Vr).get(r);if(!i||Date.now()-i>Ql)return kn(this,xr,Or).call(this,r),false;else return On.log(`JourneyLoopPrevention: Node overused. Journey will be stopped and removed because it violates fair usage policy. Node data:`,e),true}},td=new class{publishEvent(e,t){if(window.__externalEventsEnabled)window.dispatchEvent(new CustomEvent(e,{detail:t}))}},rd=new class{init(){window.__currentlyProcessedNodes=[]}publishCurrentlyProcessedNode(e){window.__currentlyProcessedNodes.push(e),td.publishEvent("web_flow_node_process",window.__currentlyProcessedNodes)}};rd.init();var id=(e=>(e["WebFlowStarted"]="_grWebFlowStarted",e))(id||{});Rr=new WeakSet,Lr=()=>{window._grTestWebFlowStarted=true};const nd=new class{constructor(){En(this,Rr)}dispatchSandboxEvent(...[e,t]){if(window._grTestSandbox)switch(window.document.documentElement.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:true,composed:true})),e){case"_grWebFlowStarted":return kn(this,Rr,Lr).call(this)}}};class od extends $n{constructor({webflowSerializedData:e,visitorJourneys:t,isJourneyGraph:r}){super(),En(this,jr,void 0),En(this,Mr,void 0),En(this,Br,Rn(aa.visitorUuid)),En(this,Jr,new Map),Cn(this,jr,this.createWebFlowFromSerializedData(e)),Cn(this,Mr,t),this.isJourneyGraph=r}initVisitorFlow(){this.findStartingElements().forEach((({node:e,journey:t})=>{const r=$u.generateRandomUuid();let i;if(Hl(In(this,jr))){if(t)i=Pa.create(t);else i=Pa.createBlank({journey:{uuid:r},visitor:{uuid:In(this,Br)}});In(this,Jr).set(i.journey.uuid,Zl.create(In(this,jr),i))}this.shouldProcessFlow(e,i).then((t=>{if(t)nd.dispatchSandboxEvent(id.WebFlowStarted),this.processFlow(e,i)}))}))}calculateTransitionsForNextNodeFromNode(e,t,r){const i=this.calculateNextTransitionForNode(t,r);return In(this,Jr).get(e.journey.uuid).getCurrentVisitorTransitionsVoCopyWithTransitions([{...i}])}calculateJourneyStateForNextNode(e,t,r){var i,n;const o=this.calculateNextTransitionForNode(t,r),s=null==(i=o.to)?void 0:i.id;return{journeyVo:Pa.create({journey:{uuid:e.journey.uuid},node:{uuid:(null==(n=o.to)?void 0:n.id)||t.id},visitor:{uuid:In(this,Br)},pass_through_params:e.pass_through_params,node_entered_at:(new Date).toISOString()},{preventAttachingListeners:true}),type:s?"put":"delete"}}calculateNextTransitionForNode(e,t){return{from:e,to:this.getNodeConnectedToNodes(e)[t],fromPathKey:t,transitionTime:null}}async processFlow(e,t){try{const r=(new Date).toISOString(),i=e.id===(null==t?void 0:t.node.uuid);if(t&&!i)t.updateJourneyData({node:{uuid:e.id},node_entered_at:r});if(this.isJourneyGraph)await Ia.saveVisitorJourney(t);this.processNode(e,t).then((async i=>{if(Ea.addEntry(e.id),this.isJourneyGraph)await Ia.saveNodeHistoryEntry(e.id,In(this,Br),r);if(i&&await this.shouldProcessFlow(i,t))this.processFlow(i,t);else if(!i&&this.isJourneyGraph&&e.type!==Tn.ReactSendToBackend)t.terminate(),await Ia.clearVisitorJourney(t)})).catch((e=>{On.error(e)}))}catch(r){On.error(r)}}async processNode(e,t){const r=this.getNodeConnectedToNodes(e);On.log(`Processing node ${e.type} with id: ${e.id}`,e),rd.publishCurrentlyProcessedNode({nodeId:e.id,journeyUuid:null==t?void 0:t.journey.uuid,pathKey:"input"}),e.startUpstreamCalculation(t);const i=await Promise.race([e.waitForUpstreamPassed(),e.handler(t)]);let n;if(i===Symbol.for("upstreamPassed"))n=Un;else n=i,e.cancelUpstreamToResolveWait();const o=r[n];if(this.isJourneyGraph)if(e.type!==Tn.ReactSendToBackend){const r=o?ed.isNodeUsedInLoop(o,t.journey.uuid):false,i=o?await o.validateRecurrentConditionForJourney(t):true,s={from:e,to:r?void 0:o,fromPathKey:r?"exit":n,transitionTime:(new Date).toISOString(),reason:r?"loop":void 0},a=In(this,Jr).get(t.journey.uuid);if(await a.addTransition(s),!i&&o.recurrent.failStrategy===ao.RemoveLastTransitionNodeEnter)a.addGlobalExitToLastTransitionBeforeSend();if(await a.flushTransitionsIfNeeded(s),r)return}return this.emit(Pl.NodeProcessed,{id:e.id,pathKey:n}),On.log(`Finished processing node ${e.type} with id: ${e.id} with result ${n}`),rd.publishCurrentlyProcessedNode({nodeId:e.id,journeyUuid:null==t?void 0:t.journey.uuid,pathKey:n}),o}getNodeConnectedToNodes(e){return In(this,jr).connections.filter((t=>t.from===e.id)).reduce(((e,t)=>(e[t.fromPathKey]=In(this,jr).nodes.find((e=>e.id===t.to)),e)),{})}findStartingElements(){var e;if(Hl(In(this,jr))){const{starting:t,nodes:r,startAt:i,stopAt:n}=In(this,jr),o=null==(e=In(this,Mr))?void 0:e.length;if(!(({startAt:e,stopAt:t})=>{const r=Date.parse(e),i=Date.parse(t),n=Date.now();if(!Number.isNaN(r)&&r>n)return false;if(!Number.isNaN(i)&&n>i)return false;else return true})({startAt:i,stopAt:n}))return[];if(o)return In(this,Mr).map((e=>({node:r.find((t=>t.id===e.node.uuid)),journey:e}))).filter((e=>e.node.type!==Tn.ReactSendToBackend));if(t.length)return r.filter((e=>t.includes(e.externalId))).map((e=>({node:e})));else return[]}const{nodes:t,connections:r}=In(this,jr);return t.filter((e=>!r.some((t=>t.to===e.id)))).map((e=>({node:e})))}createWebFlowFromSerializedData(e){return{...e,nodes:e.nodes.map((e=>zl.getNodeInstance(e.type,{...e,context:this})))}}async shouldProcessFlow(e,t){if(this.isJourneyGraph)return e.validateRecurrentConditionForJourney(t);else return true}}jr=new WeakMap,Mr=new WeakMap,Br=new WeakMap,Jr=new WeakMap;class sd{fetchFlowDataFromRemote(e){return fetch(e).then((async e=>{var t;if(!e.ok){const r=null==(t=e.headers.get("Content-Type"))?void 0:t.includes("application/json");return Promise.reject(await(r?e.json():e.text()))}const r=await e.json();if(!!(i=r)&&"object"==typeof i&&"connections"in i&&"nodes"in i&&Array.isArray(i["nodes"])&&i["nodes"].length>0)return r;else return On.error("Fetched data is not a valid web flow data",r),null;var i})).catch((e=>(On.error("Failed to fetch web flow data",e),null)))}}class ad{static getLastFullNDaysTimestamp(e){const t=new Date(Date.now()-e*no.OneDay);return t.setHours(0,0,0,0),t.getTime()}}function cd(e){return{...ld(e),...dd(e),...pd(e),...hd(e)}}function ud(e){const t={},{cartUpdated:r,orderPlaced:i,likeItem:n,productOrCategoryView:o}=e;if(e[Wo.ViewProductOrCategory]||e[Wo.LikeProduct]||e[Wo.OrderPlaced]||e[Wo.CartUpdated]){if((null==o?void 0:o.product)||(null==o?void 0:o.category)){if(t.productOrCategoryView={},o.product)t.productOrCategoryView.product=o.product;if(o.category)t.productOrCategoryView.category=o.category;t.productOrCategoryView.modifiers={separator:_u.Or,rules:[{type:Fu.EventsAmount,amount:1,comparisonOperator:xu.GreaterThanOrEqual}]};const e=t.productOrCategoryView.modifiers.rules.at(0);if(o.date)if(o.date.name===Do.LastDays)e.timeFrom=ad.getLastFullNDaysTimestamp(o.date.value);else if(o.date.name===Do.DateRange){if(o.date.value.from)e.timeFrom=new Date(o.date.value.from).getTime();if(o.date.value.to)e.timeTo=new Date(o.date.value.to).getTime()}if(o.amount)e.amount=o.amount.value}}else{t.productOrCategoryView={},t.productOrCategoryView.modifiers={separator:_u.Or,rules:[{type:Fu.EventsAmount,amount:1,comparisonOperator:xu.GreaterThanOrEqual}]},t.productOrCategoryView.product=e.product,t.productOrCategoryView.category=e.category;const r=t.productOrCategoryView.modifiers.rules.at(0);if(e.amount)r.amount=e.amount.value;if(e.date)if(e.date.name===Do.LastDays)r.timeFrom=ad.getLastFullNDaysTimestamp(e.date.value);else if(e.date.name===Do.DateRange){if(e.date.value.from)r.timeFrom=new Date(e.date.value.from).getTime();if(e.date.value.to)r.timeTo=new Date(e.date.value.to).getTime()}}if(n)if(t.likeItem={product:n.product},n.date)t.likeItem.date=n.date;if(i){const{product:e,productsAmount:r,category:n,price:o,date:s}=i;if(t.orderPlaced={condition:{}},e)t.orderPlaced.condition.product={id:e};if(n)t.orderPlaced.condition.category={id:n};if(r)t.orderPlaced.condition.amount={condition:r.name,value:r.value};if(o)t.orderPlaced.condition.price={condition:o.name,value:o.value};if(s)t.orderPlaced.settings={date:s}}if(r){const{product:e,productsAmount:i,category:n,price:o,date:s}=r;if(t.cartUpdated={condition:{},settings:{}},e)t.cartUpdated.condition.product={id:e};if(n)t.cartUpdated.condition.category={id:n};if(i)t.cartUpdated.condition.amount={condition:i.name,value:i.value};if(o)t.cartUpdated.condition.price={condition:o.name,value:o.value};if(s)t.cartUpdated.settings={date:s}}return t}function ld(e){const t={};if(e.productOrCategoryView){if(e.productOrCategoryView.product)t.product={id:e.productOrCategoryView.product};if(e.productOrCategoryView.category)t.category={id:e.productOrCategoryView.category}}return t}function dd(e){var t;const r={};if(null==(t=e.likeItem)?void 0:t.product)r.likeProduct={product:{id:e.likeItem.product}};return r}function pd(e){const t={};if(e.orderPlaced){const{product:r,productsAmount:i,category:n,price:o}=e.orderPlaced;if(t.orderPlaced={},r)t.orderPlaced.product={id:r};if(n)t.orderPlaced.category={id:n};if(i)t.orderPlaced.amount={condition:i.name,value:i.value};if(o)t.orderPlaced.value={condition:o.name,value:o.value}}return t}function hd(e){const t={};if(e.cartUpdated){const{product:r,productsAmount:i,category:n,price:o}=e.cartUpdated;if(t.cartUpdate={},r)t.cartUpdate.product={id:r};if(n)t.cartUpdate.category={id:n};if(i)t.cartUpdate.amount={condition:i.name,value:i.value};if(o)t.cartUpdate.value={condition:o.name,value:o.value}}return t}const md=1e3;$r=new WeakSet,Gr=(e,t,r=1)=>{const i=[];for(let n=0;r>n;n++){const r=$u.generateRandomUuid(),n={id:r,properties:{urls:t}};i.push(r),e.withNode(Tn.FilterUrl,n)}return i},qr=new WeakSet,zr=(e,t)=>{const r=$u.generateRandomUuid();return e.withNode(Tn.FilterLocation,{id:r,properties:{locations:t}}),r},Hr=new WeakSet,Kr=function(e,t){if(!t)return null;const{ecommerceConditions:r,conditionsLogicSeparator:i=Co.Or}=t;if(i===Co.Or){const{awaitNode:t,filterNodes:i}=kn(this,Xr,Yr).call(this,r);if(t)e.withNode(t.type,t);for(const r of i)e.withNode(r.type,r);return{separator:Co.Or,...(null==t?void 0:t.id)&&{ecommerceActivityAwaitNodeId:t.id},...i.length&&{ecommerceActivityFilterNodeIds:i.map((e=>e.id))}}}else if(i===Co.And){const{nodesToMerge:t}=kn(this,Zr,Qr).call(this,r),i=$u.generateRandomUuid();return e.withNode(Tn.AwaitMergedNodes,{id:i,properties:{separator:"and",nodesDefinition:t,leaveFalseDelay:0}}),{separator:Co.And,mergedNodeId:i}}},Xr=new WeakSet,Yr=e=>{const{filterConditions:t,awaitConditions:r}=e.reduce(((e,t)=>{const r={},i={};for(const[n,o]of Object.entries(t))if(o)if("object"==typeof o&&null!==o&&"triggerType"in o&&o.triggerType===Ao.FutureEvents)i[n]=o;else r[n]=o;if(Object.keys(r).length)e.filterConditions.push(r);if(Object.keys(i).length)e.awaitConditions.push(i);return e}),{filterConditions:[],awaitConditions:[]});let i;const n=t.map((e=>({id:$u.generateRandomUuid(),type:Tn.FilterECommerceActivity,properties:ud(e)})));if(r.length)i={id:$u.generateRandomUuid(),type:Tn.AwaitECommerceActivity,properties:{separator:"or",conditions:r.map((e=>cd(e)))}};return{awaitNode:i,filterNodes:n}},Zr=new WeakSet,Qr=e=>({nodesToMerge:e.reduce(((e,t)=>{const r={},i={};for(const[s,a]of Object.entries(t))if(a)if("object"==typeof a&&null!==a&&"triggerType"in a&&a.triggerType===Ao.FutureEvents)r[s]=a;else i[s]=a;let n=null,o=null;if(Object.keys(r).length>0)n={id:$u.generateRandomUuid(),type:Tn.AwaitECommerceActivity,properties:{separator:"or",conditions:[cd(r)]}};if(Object.keys(i).length>0)o={id:$u.generateRandomUuid(),type:Tn.FilterECommerceActivity,properties:ud(i)};if(n&&o)e.push({id:$u.generateRandomUuid(),type:Tn.AwaitMergedNodes,properties:{separator:"or",nodesDefinition:[o,n]}});else if(n)e.push(n);else if(o)e.push(o);return e}),[])}),ei=new WeakSet,ti=(e,t)=>{const r=$u.generateRandomUuid(),i={id:r,properties:{deviceType:Array.isArray(t)?t:[t]}};return e.withNode(Tn.FilterDevice,i),r},ri=new WeakSet,ii=(e,t={})=>{const r=t.to&&new Date(t.to).getTime(),i=t.from&&new Date(t.from).getTime(),n=$u.generateRandomUuid();return e.withNode(Tn.FilterTime,{id:n,properties:{beforeTime:r,afterTime:i}}),n},ni=new WeakSet,oi=(e,t,r,i)=>{if((null==t?void 0:t.length)||r){let n,o,s;null==t?void 0:t.forEach((e=>{if(e.name===Vo.AfterClose)n=true;if(e.name===Vo.AfterSubmit)o=true;if(e.name===Vo.AfterTimes)s=e.value}));const a=$u.generateRandomUuid(),c={id:a,properties:{frequency:(null==r?void 0:r.name)||xo.Always,...(null==r?void 0:r.name)===xo.EveryDays&&{showEveryDays:r.value},popupId:i,showIfSeenLessThanAmount:s,showIfNotCloseBefore:n,showIfNotSubmittedBefore:o}};return e.withNode(Tn.FilterPopup,c),a}},si=new WeakSet,ai=(e,t)=>{const r=$u.generateRandomUuid();return e.withNode(Tn.FilterVisit,{id:r,properties:{visitors:t}}),r},ci=new WeakSet,ui=function(e,t){const r=t.map((e=>kn(this,li,di).call(this,e))).filter(Boolean),i=t.find((e=>e.name===_o.Click&&!e.value.showOnlyOncePerVisit));if(0===r.length)return{showWhenAwaitId:null,showWhenRecurrentClickNodeId:null};const n=$u.generateRandomUuid(),o=i?$u.generateRandomUuid():null;if(e.withNode(Tn.AwaitMergedNodes,{id:n,properties:{nodesDefinition:r,leaveFalseDelay:0}}),o)e.withNode(Tn.AwaitClick,{id:o,properties:{leaveFalseDelay:0,selector:i.value.selector}});return{showWhenAwaitId:n,showWhenRecurrentClickNodeId:o}},li=new WeakSet,di=e=>{var t,r;switch(e.name){case _o.Instantly:return null;case _o.Delay:return{type:Tn.ReactDelay,properties:{delay:e.value*md}};case _o.Exit:return{type:Tn.AwaitExit,properties:{leaveFalseDelay:0,useMobileScrollBasedExitIntend:!!(null==(t=e.value)?void 0:t.useMobileScrollBasedExitIntend),useMobileHistoryBasedExitIntend:!!(null==(r=e.value)?void 0:r.useMobileHistoryBasedExitIntend)}};case _o.Inactivity:return{type:Tn.AwaitInactivity,properties:{leaveFalseDelay:0,inactivityTime:e.value*md}};case _o.Scroll:return{type:Tn.AwaitScroll,properties:{leaveFalseDelay:0,selector:e.value.name===Fo.Selector?e.value.value:null,percent:e.value.name===Fo.Percent?e.value.value:null}};case _o.Click:return{type:Tn.AwaitClick,properties:{leaveFalseDelay:0,selector:"string"==typeof e.value?e.value:e.value.selector||null}};default:qn(e)}},pi=new WeakSet,hi=(e,t,r,i)=>{const n=$u.generateRandomUuid();return e.withNode(Tn.ReactPopup,{id:n,properties:{id:t,env:r,mode:i}}),n};const wd=new class{constructor(){En(this,$r),En(this,qr),En(this,Hr),En(this,Xr),En(this,Zr),En(this,ei),En(this,ri),En(this,ni),En(this,si),En(this,ci),En(this,li),En(this,pi)}createWebFlowForInlinePopup({popupEnv:e,popupId:t,excludedUrls:r,urls:i}){const n=Sl.create(),o=kn(this,pi,hi).call(this,n,t,e,to.Inline),s=kn(this,$r,Gr).call(this,n,i);let a=null;if(Array.isArray(r)&&r.length>0)a=kn(this,$r,Gr).call(this,n,r),n.withConnection({from:a[0],to:s[0],fromPathKey:"false"});return n.withConnection({from:s[0],to:o,fromPathKey:"true"}),n.build()}createWebFlowFromTriggerData({triggers:e,popupId:t,popupEnv:r,urls:i,excludedUrls:n}){const{location:o,device:s,visitors:a,showWhenCondition:c,dateRange:u,preventDisplay:l,frequency:d,ecommerce:p}=e,h=Sl.create(),m=kn(this,qr,zr).call(this,h,o),w=kn(this,ei,ti).call(this,h,s),f=kn(this,si,ai).call(this,h,a),g=kn(this,ri,ii).call(this,h,u),v=kn(this,ni,oi).call(this,h,l,d,t),{showWhenAwaitId:y,showWhenRecurrentClickNodeId:b}=kn(this,ci,ui).call(this,h,c),S=kn(this,Hr,Kr).call(this,h,p),P=kn(this,pi,hi).call(this,h,t,r,to.Popup),I=kn(this,$r,Gr).call(this,h,i);let E=null;if(Array.isArray(n)&&n.length>0)E=kn(this,$r,Gr).call(this,h,n);if(Array.isArray(E)&&E[0])h.withConnection({from:E[0],to:I[0],fromPathKey:"false"});if(S){const{separator:e}=S;if(e===Co.Or){const{ecommerceActivityFilterNodeIds:e=[],ecommerceActivityAwaitNodeId:t}=S;if(h.withConnection({from:I[0],to:(null==e?void 0:e.length)?e[0]:t,fromPathKey:"true"}),y)h.withCascadeConnectionFalseOut({fromNodes:e,targetNode:y}).withConnection({from:y,to:m,fromPathKey:"true"});else h.withCascadeConnectionFalseOut({fromNodes:e,targetNode:m});if(t&&e.length)h.withConnection({from:e[e.length-1],to:t,fromPathKey:"false"});if(t)if(y)h.withConnection({from:t,to:y,fromPathKey:"true"}).withConnection({from:y,to:m,fromPathKey:"true"});else h.withConnection({from:t,to:m,fromPathKey:"true"})}else if(e===Co.And){const{mergedNodeId:e}=S;if(h.withConnection({from:I[0],to:e,fromPathKey:"true"}),y)h.withConnection({from:e,to:y,fromPathKey:"true"}),h.withConnection({from:y,to:m,fromPathKey:"true"});else h.withConnection({from:e,to:m,fromPathKey:"true"})}}else if(y)h.withConnection({from:I[0],to:y,fromPathKey:"true"}).withConnection({from:y,to:m,fromPathKey:"true"});else h.withConnection({from:I[0],to:m,fromPathKey:"true"});h.withConnection({from:m,to:w,fromPathKey:"true"}).withConnection({from:w,to:f,fromPathKey:"true"}).withConnection({from:f,to:g,fromPathKey:"true"});let C=g;if(v)h.withConnection({from:g,to:v,fromPathKey:"true"}),C=v;if(h.withConnection({from:C,to:P,fromPathKey:"true"}),b)h.withConnection({from:P,to:b,fromPathKey:"true"}),h.withConnection({from:b,to:g,fromPathKey:"true"});return h.build()}};mi=new WeakMap;const fd=new class extends sd{constructor(){super(...arguments),En(this,mi,false)}async parse({data:e,type:t,id:r}){if(t===Lu.Popup){let t;if((e=>!!e&&"object"==typeof e&&"flowDataUrl"in e)(e))t=await this.fetchFlowDataFromRemote(e.flowDataUrl);else if((e=>!!e&&"object"==typeof e&&"triggers"in e&&"urls"in e)(e)){const{env:i,...n}=e,o={popupId:r,popupEnv:i,...n};if(e.mode===to.Inline){if(!In(this,mi))window.PopupsRenderer.registerCustomElements({lazy:true}),Cn(this,mi,true);t=wd.createWebFlowForInlinePopup(o)}else t=wd.createWebFlowFromTriggerData(o)}if(da.popupGraphs[r]={originalTriggers:e,transformedGraph:t},t)return t}}isPopupFromCurrentUrl(e){const{urls:t}=e.data;return gu(document.location.href,t)}},gd=class e{constructor(){En(this,fi),En(this,wi,new Set)}static create(){return new e}add(...e){for(const t of e)if(!Array.from(In(this,wi)).some((e=>kn(this,fi,gi).call(this,e,t))))In(this,wi).add(t)}replace(e,t){this.remove(e),this.add(t)}remove(e){In(this,wi).delete(e)}forEach(e){In(this,wi).forEach(e)}*[Symbol.iterator](){yield*In(this,wi)}};wi=new WeakMap,fi=new WeakSet,gi=(e,t)=>t.from===e.from&&t.to===e.to&&t.key===e.key;let vd=gd;const yd=1e3*60*60;function bd(e,t){if(e===Tn.ReactSendWebPush&&true===t)return{type:so.OnceEveryAmountTime,value:yd,failStrategy:ao.RemoveLastTransitionNodeEnter};else return(e=>{if(void 0===e)return{type:so.EveryTime,value:false,failStrategy:ao.RemoveLastTransitionNodeEnter};if("boolean"==typeof e)return{type:so.EveryTime,value:e,failStrategy:ao.RemoveLastTransitionNodeEnter};if(!!e&&"object"==typeof e)return e;else return})(t)}function Sd(e){const t={modifiers:{separator:_u.Or,rules:[{type:Fu.EventsAmount,amount:1,comparisonOperator:xu.GreaterThanOrEqual}]}};if(e){if("and"===e.separator)t.modifiers.separator=_u.And;else t.modifiers.separator=_u.Or;if(Array.isArray(e.rules)&&e.rules.length>0){t.modifiers.rules=[];for(const r of e.rules)switch(r.type){case"amount":t.modifiers.rules.push({type:Fu.EventsAmount,comparisonOperator:r.operator,amount:r.value,...Pd(e)});break;case"duration":t.modifiers.rules.push({type:Fu.EventsTimeSpent,totalEventsDuration:r.value*no.OneSecond,...Pd(e)});break;default:qn(r)}}else t.modifiers.rules.push({type:Fu.EventsAmount,amount:1,comparisonOperator:xu.GreaterThanOrEqual})}return t}function Pd(e){if(e.activityPeriod)switch(e.activityPeriod.type){case"lastDays":return{timeFrom:ad.getLastFullNDaysTimestamp(e.activityPeriod.value)};default:qn(e.activityPeriod.type)}return{}}function Id(e){return{quantifier:"or",upstreams:Object.entries(e||{}).filter((e=>{const t=e[1];if(Array.isArray(t))return!!t.length;else return null!==t})).map((([e,t])=>({type:e,value:t})))}}const Ed=1e3*60;vi=new WeakMap,yi=new WeakMap,bi=new WeakMap,Si=new WeakMap,Pi=new WeakSet,Ii=(e,t)=>t.filter((t=>t.from===e.id)),Ei=new WeakSet,Ci=function(e){return e.map((e=>({from:In(this,yi).has(e.from)?In(this,yi).get(e.from):e.from,to:In(this,bi).has(e.to)?In(this,bi).get(e.to):e.to,fromPathKey:e.key})))},ki=new WeakSet,Di=function(e,t,r){const{id:i,data:n,isRecurrent:o,upstream:s}=e;r.withNode(Tn.ReactSendWebPush,{id:i,externalId:i,recurrent:bd(Tn.ReactSendWebPush,o),upstream:Id(s),properties:{messageId:n.nid}}),In(this,Si).add(...t)},Ti=new WeakSet,Ai=function(e,t,r){const{id:i,data:n,isRecurrent:o,upstream:s}=e;r.withNode(Tn.ReactCollectWebPushConsent,{id:i,externalId:i,recurrent:bd(Tn.ReactCollectWebPushConsent,o),upstream:Id(s),properties:{pid:n.pid,customPromptRejectionDuration:n.denyBefore*Ed}}),In(this,Si).add(...t)},Ni=new WeakSet,Ui=function(e,t,r){const{id:i,data:n,isRecurrent:o,upstream:s}=e,{pid:a,concerns:c}=n;r.withNode(Tn.AwaitWebPushConsent,{id:i,externalId:i,recurrent:bd(Tn.AwaitWebPushConsent,o),upstream:Id(s),properties:{pid:"specific_prompt"===c?a:"any",leaveFalseDelay:0}}),In(this,Si).add(...t)},Wi=new WeakSet,Fi=function(e,t,r){const{id:i,data:n,isRecurrent:o,upstream:s}=e,{concerns:a,url:c,params:u}=n,l="includes"===a?i:$u.generateRandomUuid();let d;if(In(this,yi).set(i,l),In(this,bi).set(i,l),u){const e=c.startsWith("http://")||c.startsWith("https://")?c:`https://${c}`;d=new URL(e)}const p=u?{baseUrl:d.host,path:d.pathname,queryParamsSelectionRule:"all",queryParams:u.reduce(((e,t)=>({...e,[t.name]:{value:t.value,operator:t.operator}})),{})}:{urls:Array.isArray(c)?c:[c]};switch(r.withNode(Tn.FilterUrl,{id:l,externalId:i,upstream:Id(s),recurrent:bd(Tn.FilterUrl,o),properties:p}),e.data.concerns){case"excludes":In(this,Si).add(...t.map((e=>({from:e.from,to:e.to,key:"false"===e.key?"true":"false"})))),In(this,vi)[i]={true:"false",false:"true"};break;case"includes":In(this,Si).add(...t);break;default:qn(e.data.concerns)}},_i=new WeakSet,Vi=function(e,t,r){const{id:i,data:n,isRecurrent:o,upstream:s}=e;if("country_code"===n.contestType){const{countryCodes:e}=n;r.withNode(Tn.FilterLocation,{id:i,externalId:i,recurrent:bd(Tn.FilterLocation,o),upstream:Id(s),properties:{locations:e}}),In(this,Si).add(...t)}else qn(n.contestType)},xi=new WeakSet,Oi=(e,t)=>{const{id:r,data:i,isRecurrent:n,upstream:o}=e;t.withNode(Tn.ReactSendToBackend,{id:r,externalId:r,recurrent:bd(Tn.ReactSendToBackend,n),upstream:Id(o),properties:{automation_node:{id:i.destination_node_id}}})},Ri=new WeakSet,Li=function(e,t,r){const{id:i,data:{value:n},isRecurrent:o,upstream:s}=e,a="yes"===n?i:$u.generateRandomUuid();if(In(this,yi).set(i,a),In(this,bi).set(i,a),r.withNode(Tn.FilterSubscriber,{id:a,externalId:i,recurrent:bd(Tn.FilterSubscriber,o),upstream:Id(s),properties:{}}),"yes"===n)In(this,Si).add(...t);else if("no"===n)In(this,Si).add(...t.map((e=>({from:e.from,to:e.to,key:"false"===e.key?"true":"false"})))),In(this,vi)[i]={true:"false",false:"true"};else qn(n)},ji=new WeakSet,Mi=function(e,t,r){const{id:i,data:n,isRecurrent:o,upstream:s}=e;r.withNode(Tn.AwaitScroll,{id:i,externalId:i,recurrent:bd(Tn.AwaitScroll,o),upstream:Id(s),properties:{percent:n.percent,leaveFalseDelay:0}}),In(this,Si).add(...t)},Bi=new WeakSet,Ji=function(e,t,r){const{id:i,data:n,isRecurrent:o,upstream:s}=e,{popupId:a,popupEnv:c}=n;r.withNode(Tn.ReactPopup,{id:i,externalId:i,recurrent:bd(Tn.ReactPopup,o),upstream:Id(s),properties:{id:a,env:c,mode:to.Popup}}),In(this,Si).add(...t)},$i=new WeakSet,Gi=function(e,t,r){const{id:i,data:n,isRecurrent:o,upstream:s}=e,{env:a,popup_uuid:c}=n;r.withNode(Tn.ReactPopup,{id:i,externalId:i,recurrent:bd(Tn.ReactPopup,o),upstream:Id(s),properties:{id:c,env:a,mode:to.Popup}}),In(this,Si).add(...t)},qi=new WeakSet,zi=function(e,t,r){const{id:i,data:n,isRecurrent:o,upstream:s}=e,{product:a}=n;r.withNode(Tn.AwaitECommerceActivity,{id:i,externalId:i,recurrent:bd(Tn.AwaitECommerceActivity,o),upstream:Id(s),properties:{conditions:[{likeProduct:{product:a}}],separator:"or",leaveFalseDelay:0}}),In(this,Si).add(...t)},Hi=new WeakSet,Ki=function(e,t,r){const{id:i,data:n,isRecurrent:o,upstream:s}=e,{device:a}=n;r.withNode(Tn.FilterDevice,{id:i,externalId:i,recurrent:bd(Tn.FilterDevice,o),upstream:Id(s),properties:{deviceType:a}}),In(this,Si).add(...t)},Xi=new WeakSet,Yi=function(e,t,r){const{id:i,isRecurrent:n,upstream:o}=e;r.withNode(Tn.FilterVisit,{id:i,externalId:i,recurrent:bd(Tn.FilterVisit,n),upstream:Id(o),properties:{frequency:Tc.Always,visitors:So.Returning}}),In(this,Si).add(...t)},Zi=new WeakSet,Qi=function(e,t,r){const{id:i,data:n,isRecurrent:o,upstream:s}=e,{actions:a,logic_operator:c}=n;r.withNode(Tn.AwaitMergedNodes,{id:i,externalId:i,recurrent:bd(Tn.AwaitMergedNodes,o),upstream:Id(s),properties:{separator:null==c?void 0:c.toLowerCase(),leaveFalseDelay:0,nodesDefinition:a.map((e=>{if("scroll_to_element"===e.actionType)return{type:Tn.AwaitScroll,properties:{selector:e.value}};if("scroll_percentage"===e.actionType)return{type:Tn.AwaitScroll,properties:{percent:e.value}};else return{type:Tn.AwaitClick,properties:{selector:e.value}}}))}}),In(this,Si).add(...t)},en=new WeakSet,tn=function({webGraphOriginalIdToGeneratedNodeIdTo:e,webGraphOriginalIdToGeneratedNodeIdFrom:t,nodesConnections:r}){if(t)for(const[i,n]of t.entries())In(this,yi).set(i,n);if(e)for(const[i,n]of e.entries())In(this,bi).set(i,n);In(this,Si).add(...r)};let Cd=class e{constructor(){En(this,Pi),En(this,Ei),En(this,ki),En(this,Ti),En(this,Ni),En(this,Wi),En(this,_i),En(this,xi),En(this,Ri),En(this,ji),En(this,Bi),En(this,$i),En(this,qi),En(this,Hi),En(this,Xi),En(this,Zi),En(this,en),En(this,vi,{}),En(this,yi,new Map),En(this,bi,new Map),En(this,Si,vd.create())}static create(){return new e}transformEditorGraphToWebGraph(e){const{transitions:t,nodes:r,...i}=e,n=Sl.create({automationJourney:i});r.forEach((e=>{const r=kn(this,Pi,Ii).call(this,e,t),{type:i}=e;switch(i){case co.ReactSendWebPush:kn(this,ki,Di).call(this,e,r,n);break;case co.ReactCollectWebPushConsent:kn(this,Ti,Ai).call(this,e,r,n);break;case co.FilterWebUrl:kn(this,Wi,Fi).call(this,e,r,n);break;case co.TransferToBackend:kn(this,xi,Oi).call(this,e,n);break;case co.ShowPopup:kn(this,Bi,Ji).call(this,e,r,n);break;case co.FilterWebSubscribers:kn(this,Ri,Li).call(this,e,r,n);break;case co.AwaitScroll:kn(this,ji,Mi).call(this,e,r,n);break;case co.ConditionProductViewed:{const{nodesConnections:t,webGraphOriginalIdToGeneratedNodeIdFrom:i,webGraphOriginalIdToGeneratedNodeIdTo:o}=(({builder:e,nodesConnections:t,node:r})=>{const{id:i,data:n,isRecurrent:o,upstream:s}=r,{product:a,category:c,modifiers:u,filterMode:l}=n,d=l?$u.generateRandomUuid():i,p=l?$u.generateRandomUuid():null,h=Sd(u),m=Id(s);if(l)e.withNode(Tn.FilterECommerceActivity,{id:p,externalId:i,recurrent:bd(Tn.FilterECommerceActivity,o),upstream:m,properties:{productOrCategoryView:{...(null==a?void 0:a.id)?{product:a.id}:null,...(null==c?void 0:c.id)?{productCategories:c.id}:null,modifiers:h.modifiers}}});e.withNode(Tn.AwaitECommerceActivity,{id:d,externalId:i,recurrent:bd(Tn.AwaitECommerceActivity,o),upstream:m,properties:{conditions:[{product:{...(null==a?void 0:a.id)?{id:a.id}:null,...(null==c?void 0:c.id)?{category:c.id}:null,modifiers:h.modifiers}}],separator:"or",leaveFalseDelay:0}});const w=t.filter((e=>e.to===i)),f=t.find((e=>e.from===i&&"true"===e.key));if(l){const e=[],t=new Map,r=new Map;t.set(i,d),r.set(i,p);for(const i of w)e.push({from:i.from,to:p,key:i.key});if(e.push({from:p,to:d,key:"false"}),f)e.push({from:p,to:f.to,key:"true"}),e.push({from:d,to:f.to,key:"true"});return{nodesConnections:e,webGraphOriginalIdToGeneratedNodeIdFrom:t,webGraphOriginalIdToGeneratedNodeIdTo:r}}return{nodesConnections:t}})({nodesConnections:r,node:e,builder:n});kn(this,en,tn).call(this,{webGraphOriginalIdToGeneratedNodeIdTo:o,webGraphOriginalIdToGeneratedNodeIdFrom:i,nodesConnections:t});break}case co.ConditionCategoryViewed:{const{webGraphOriginalIdToGeneratedNodeIdTo:t,webGraphOriginalIdToGeneratedNodeIdFrom:i,nodesConnections:o}=(({node:e,builder:t,nodesConnections:r})=>{const{id:i,data:n,isRecurrent:o,upstream:s}=e,{category:a,modifiers:c,filterMode:u}=n,l=u?$u.generateRandomUuid():i,d=u?$u.generateRandomUuid():null,p=Sd(c),h=Id(s);if(u)t.withNode(Tn.FilterECommerceActivity,{id:d,externalId:i,recurrent:bd(Tn.FilterECommerceActivity,o),upstream:h,properties:{productOrCategoryView:{...(null==a?void 0:a.id)?{category:a.id}:null,modifiers:p.modifiers}}});t.withNode(Tn.AwaitECommerceActivity,{id:l,externalId:i,recurrent:bd(Tn.AwaitECommerceActivity,o),upstream:h,properties:{conditions:[{category:{...a,modifiers:p.modifiers}}],separator:"or",leaveFalseDelay:0}});const m=r.filter((e=>e.to===i)),w=r.find((e=>e.from===i&&"true"===e.key));if(u){const e=[],t=new Map,r=new Map;t.set(i,l),r.set(i,d);for(const i of m)e.push({from:i.from,to:d,key:i.key});if(e.push({from:d,to:l,key:"false"}),w)e.push({from:d,to:w.to,key:"true"}),e.push({from:l,to:w.to,key:"true"});return{nodesConnections:e,webGraphOriginalIdToGeneratedNodeIdFrom:t,webGraphOriginalIdToGeneratedNodeIdTo:r}}return{nodesConnections:r}})({nodesConnections:r,builder:n,node:e});kn(this,en,tn).call(this,{webGraphOriginalIdToGeneratedNodeIdTo:t,webGraphOriginalIdToGeneratedNodeIdFrom:i,nodesConnections:o});break}case co.ConditionWebPushConsent:kn(this,Ni,Ui).call(this,e,r,n);break;case co.FilterLocation:kn(this,_i,Vi).call(this,e,r,n);break;case co.ConditionProductLiked:kn(this,qi,zi).call(this,e,r,n);break;case co.FilterDevice:kn(this,Hi,Ki).call(this,e,r,n);break;case co.FilterReturningVisitor:kn(this,Xi,Yi).call(this,e,r,n);break;case co.ReactShowPopup:kn(this,$i,Gi).call(this,e,r,n);break;case co.ConditionWebAction:kn(this,Zi,Qi).call(this,e,r,n);break;default:qn(i)}})),kn(this,Ei,Ci).call(this,Array.from(In(this,Si))).forEach((e=>{n.withConnection(e)}));const o=n.build();return o.outsMap=In(this,vi),o.originalGraph=e,o}};const kd=new class extends sd{async parse({data:e,type:t,id:r}){if(t===Lu.Automation){let t;if((e=>!!e&&"object"==typeof e&&"flowDataUrl"in e)(e))t=await this.fetchFlowDataFromRemote(e.flowDataUrl);else if((e=>!!e&&"object"==typeof e&&"nodes"in e&&"transitions"in e&&Array.isArray(e.nodes)&&Array.isArray(e.transitions))(e))t=Cd.create().transformEditorGraphToWebGraph(e),da.automationJourneyGraphs[r]={originalGraph:e,transformedGraph:t};if(t)return t}}};rn=new WeakMap;const Dd=new class{constructor(){En(this,rn,new Map)}async parseWebFlowScriptInitialSingleFlowData(e){let t;if(e.type===Lu.Popup)if(fd.isPopupFromCurrentUrl(e)){if(e.data.mode===to.Inline)await du.attachPopupLibrary();t=await fd.parse(e)}else return null;else if(e.type===Lu.Automation)t=await kd.parse(e);return In(this,rn).set(t,e),t}shouldGraphWaitForDocumentLoad(e){const t=In(this,rn).get(e);if(t)return t.type===Lu.Popup&&t.data.mode===to.Popup;else return true}};class Td{constructor(e,t){this.webEventFlowData=e,this.journeys=t}initialize(){const e="complete"===document.readyState;for(const t of this.webEventFlowData){const r=Hl(t),i=r?this.journeys.get(t.id):null,n=new od({webflowSerializedData:t,visitorJourneys:i,isJourneyGraph:r});if(e||!Dd.shouldGraphWaitForDocumentLoad(t))n.initVisitorFlow();else window.addEventListener("load",(()=>{n.initVisitorFlow()}),{once:true})}}}const Ad=new class{isScriptDelayed(e){return Object.keys(da.delayedScripts).includes(e)}delay(e){if(!this.isScriptDelayed(e))da.delayedScripts={...da.delayedScripts,[e]:void 0}}storeDelayedScriptParams(e,t){if(this.isScriptDelayed(e))da.delayedScripts={...da.delayedScripts,[e]:t}}initScript(e){var t;const r=da.delayedScripts[e];if(r){da.delayedScripts=Object.fromEntries(Object.entries(da.delayedScripts).filter((([t])=>t!==e)));const i=na[e];null==(t=null==window?void 0:window[i])?void 0:t.init(...r)}}};nn=new WeakSet,on=async e=>(await Ms.openAutomationJourneysDatabaseConnection(Is)).transaction(vs.GraphJourneyFetchedData,e);const Nd=new class{constructor(){En(this,nn)}async getGraphActiveNodesData(e){const t=await kn(this,nn,on).call(this,"readonly"),r=t.objectStore(vs.GraphJourneyFetchedData).index(Ps.GraphId),i=await r.getAll(e);return await t.done,i}async saveGraphJourneyActiveNodeData(e,t){const{journey:r,node:i}=t,n=(await kn(this,nn,on).call(this,"readwrite")).objectStore(vs.GraphJourneyFetchedData),o=e.nodes.find((e=>e.id===i.uuid)),s=e.originalGraph.nodes.find((e=>e.id===(null==o?void 0:o.externalId)));if(s)await n.put({graph:{id:e.id},journey:{id:r.uuid},node:{id:i.uuid,since:s.since}})}},Ud=30;sn=new WeakSet,an=(e,t)=>e.map((e=>{const r=t.find((t=>t.journey.uuid===e.journey.uuid));if(null==r?void 0:r.pass_through_params)e.pass_through_params=r.pass_through_params;return e})),cn=new WeakSet,un=(e,t)=>t.map((t=>{const r=e.nodes.find((e=>e.externalId===t.node.uuid)),{pass_through_params:i,...n}=t;if(r)return Pa.create({...n,node:{uuid:r.id},...i?{pass_through_params:zs.create(i)}:{}})})).filter(Boolean),ln=new WeakSet,dn=(e,t)=>e.reduce(((e,r)=>{const i=t.filter((e=>r.nodes.some((t=>t.id===e.node.uuid))));return e.set(r,i.length?i:null),e}),new Map),pn=new WeakSet,hn=e=>new Map(Array.from(e.entries()).map((([e,t])=>[e.id,null==t?void 0:t.filter((e=>e.visitor.uuid===Nl.getCookie(aa.visitorUuid)))]))),mn=new WeakSet,wn=async(e,t)=>{const r=t.map((e=>e.journey.uuid)),i=e.filter((e=>!r.includes(e.journey.uuid)));return await Promise.all(i.map((e=>Ia.clearVisitorJourney(e)))),i},fn=new WeakSet,gn=async(e,t)=>{if(!(null==t?void 0:t.length))return false;const r=new Date(e.since),i=await Nd.getGraphActiveNodesData(e.id);return t.every((t=>{const n=new Date(t.node_entered_at);if(Number(n)>=Number(r))return true;const o=e.nodes.find((e=>e.id===t.node.uuid)),s=e.originalGraph.nodes.find((e=>e.id===(null==o?void 0:o.externalId))),a=new Date(s.since);if(Number(a)<=Number(n))return true;const c=i.find((e=>e.journey.id===t.journey.uuid&&e.node.id===(null==o?void 0:o.id))),u=c?new Date(c.node.since):void 0;if(u&&Number(a)===Number(u))return true;else return false}))},vn=new WeakSet,yn=async function(e){return(await Promise.all(Array.from(e.entries()).map((([e,t])=>kn(this,fn,gn).call(this,e,t))))).every(Boolean)},bn=new WeakSet,Sn=e=>e.filter((e=>{const t=new Date(e.node_entered_at),r=new Date(t.setDate(t.getDate()+Ud));if(Number(r)>Number(new Date))return true;else return false}));const Wd=new class{constructor(){En(this,sn),En(this,cn),En(this,ln),En(this,pn),En(this,mn),En(this,fn),En(this,vn),En(this,bn)}async getVisitorJourneys(e){const t=Nl.getCookie(aa.visitorUuid),r=await Ia.getVisitorJourneys(t),i=kn(this,ln,dn).call(this,e,kn(this,bn,Sn).call(this,r)),n=await kn(this,vn,yn).call(this,i);await kn(this,mn,wn).call(this,r,Array.from(i.values()).flat().filter(Boolean));const o=Array.from(i).some((([e,t])=>{if(!(null==t?void 0:t.length))return false;else return t.some((t=>{const r=e.nodes.find((e=>e.id===t.node.uuid));return(null==r?void 0:r.type)===Tn.ReactSendToBackend}))}));if(n&&!o)return kn(this,pn,hn).call(this,i);const s=kn(this,sn,an).call(this,(await Qu.getVisitorJourneys()).map((e=>Pa.create(e))),r);return await kn(this,mn,wn).call(this,r,s),await Promise.all(Array.from(i.keys()).map((async e=>{const t=kn(this,cn,un).call(this,e,s);if(t.length)return i.set(e,t),Promise.all(t.map((t=>Nd.saveGraphJourneyActiveNodeData(e,t))));else i.set(e,null)}))),kn(this,pn,hn).call(this,i)}};async function Fd(e){Vc().saveUserVisit();const t=e.filter(Hl);let r=new Map;try{if(t.length>0)r=(await Promise.all([Wd.getVisitorJourneys(t),Xc.migrateData().catch((e=>On.warn("Failed to migrate popup data",e)))]))[0];else await Xc.migrateData()}catch(i){On.error("Failed to get journey data",i)}if(null==e?void 0:e.length)new Td(e,r).initialize()}function _d(e){if(Array.isArray(e))return Promise.all(e.map((e=>{if(!!(t=e)&&"object"==typeof t&&"type"in t&&"string"==typeof t.type&&Object.values(Lu).includes(t.type)&&"data"in t&&!!t.data&&"object"==typeof t.data)return Dd.parseWebFlowScriptInitialSingleFlowData(e);else return On.error("Invalid web flow data",e),null;var t})).filter(Boolean));On.error("Invalid initial web flows data structure, expected array, got",e)}e.init=e=>{const{visitorApplicationEndpoint:t,flowData:r}=JSON.parse((e=>{if("string"!=typeof e)throw new Error(`Invalid input, expect string, got ${typeof e}`);return e.replace(/(\w+)([*|$^~]*)=["]([^"]*)["]/g,((e,t,r,i)=>`${t}${r}=\\"${i}\\"`))})(e));let i=window.location.href;if(Ad.isScriptDelayed(ia.we))return Ad.storeDelayedScriptParams(ia.we,[e]),null;if(!da.scriptModuleManager.isScriptInitialized(ia.we)){if(da.scriptModuleManager.setScriptInitialized(ia.we),da.enablePopupDevMode(),t)da.visitorApplicationEndpoint=t;_d(r).then((e=>e.filter(Boolean))).then((e=>{function t(){_d(r).then((e=>e.filter(Boolean))).then((e=>Fd(e)))}Fd(e),da.pageHistoryService.onPushState(((e,r,n)=>{if((null==e?void 0:e.gr)!==go.ExitIntend&&!!n&&n!==i)i=n.toString(),setTimeout((()=>t()),0)})),da.pageHistoryService.onReplaceState(((e,r,n)=>{if(n&&n!==i)i=n.toString(),setTimeout((()=>t()),0)})),window.addEventListener("popstate",(e=>{var r;if((null==(r=e.state)?void 0:r.gr)!==go.ExitIntend)t()}))}))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}((e="undefined"!=typeof globalThis?globalThis:e||self).GRWE={})}(this);
